<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 10: Advanced Models</title>
    <link rel="stylesheet" href="_static/reset-min.css" type="text/css">
    <link rel="stylesheet" href="_static/grids-min.css" type="text/css">
    <link rel="stylesheet" href="_static/djangobook.css" type="text/css">
    
  </head>
  <body>
    <div id="doc" class="yui-t7">
      <div id="hd">
        <h1><a href="index.html">The Django Book</a></h1>
        <div id="global-nav">
            <a class="about" href="frontmatter.html">About</a>
        </div>
        
<div class="nav">
    
        <a href='chapter09.html'>&laquo; previous</a> &loz;
    
    <a href="index.html">table of contents</a>
    
        &loz; <a href='chapter11.html'>next &raquo;</a>
    
</div>

      </div>
      <div id="bd">
        <div id="yui-main">
          <div class="yui-b">
            
  <div id="chapter-body"><div class="section" id="chapter-10-advanced-models">
<h1>Chapter 10: Advanced Models<a class="headerlink" href="#chapter-10-advanced-models" title="Permalink to this headline">¶</a></h1>
<p>In Chapter 5, we presented an introduction to Django’s database layer –
how to define models and how to use the database API to create, retrieve,
update and delete records. In this chapter, we’ll introduce you to some more
advanced features of this part of Django.</p>
<div class="section" id="related-objects">
<h2>Related Objects<a class="headerlink" href="#related-objects" title="Permalink to this headline">¶</a></h2>
<p>Recall our book models from Chapter 5:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">Publisher</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">city</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">state_province</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">country</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">website</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

<span class="k">class</span> <span class="nc">Author</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EmailField</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">authors</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">Author</span><span class="p">)</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Publisher</span><span class="p">)</span>
    <span class="n">publication_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span>
</pre></div>
</div>
<p>As we explained in Chapter 5, accessing the value for a particular field on
a database object is as straightforward as using an attribute. For example,
to determine the title of the book with ID 50, we’d do the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">books.models</span> <span class="k">import</span> <span class="n">Book</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">.</span><span class="n">title</span>
<span class="go">u&#39;The Django Book&#39;</span>
</pre></div>
</div>
<p>But one thing we didn’t mention previously is that related objects – fields
expressed as either a <code class="docutils literal notranslate"><span class="pre">ForeignKey</span></code> or <code class="docutils literal notranslate"><span class="pre">ManyToManyField</span></code> – act slightly
differently.</p>
<div class="section" id="accessing-foreign-key-values">
<h3>Accessing Foreign Key Values<a class="headerlink" href="#accessing-foreign-key-values" title="Permalink to this headline">¶</a></h3>
<p>When you access a field that’s a <code class="docutils literal notranslate"><span class="pre">ForeignKey</span></code>, you’ll get the
related model object. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">.</span><span class="n">publisher</span>
<span class="go">&lt;Publisher: Apress Publishing&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">website</span>
<span class="go">u&#39;http://www.apress.com/&#39;</span>
</pre></div>
</div>
<p>With <code class="docutils literal notranslate"><span class="pre">ForeignKey</span></code> fields, it works the other way, too, but it’s slightly
different due to the non-symmetrical nature of the relationship. To get a list
of books for a given publisher, use <code class="docutils literal notranslate"><span class="pre">publisher.book_set.all()</span></code>, like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Apress Publishing&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">book_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="go">[&lt;Book: The Django Book&gt;, &lt;Book: Dive Into Python&gt;, ...]</span>
</pre></div>
</div>
<p>Behind the scenes, <code class="docutils literal notranslate"><span class="pre">book_set</span></code> is just a <code class="docutils literal notranslate"><span class="pre">QuerySet</span></code> (as covered in
Chapter 5), and it can be filtered and sliced like any other <code class="docutils literal notranslate"><span class="pre">QuerySet</span></code>.
For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Apress Publishing&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">book_set</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">title__icontains</span><span class="o">=</span><span class="s1">&#39;django&#39;</span><span class="p">)</span>
<span class="go">[&lt;Book: The Django Book&gt;, &lt;Book: Pro Django&gt;]</span>
</pre></div>
</div>
<p>The attribute name <code class="docutils literal notranslate"><span class="pre">book_set</span></code> is generated by appending the lower case
model name to <code class="docutils literal notranslate"><span class="pre">_set</span></code>.</p>
<div class="admonition-field-name-restrictions admonition">
<p class="first admonition-title">Field name restrictions</p>
<p>A field name cannot contain more than one underscore in a row, due to the way
Django’s query lookup syntax works. For example:</p>
<div class="last highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Example</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">foo__bar</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span> <span class="c1"># &#39;foo__bar&#39; has two underscores!</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="accessing-many-to-many-values">
<h3>Accessing Many-to-Many Values<a class="headerlink" href="#accessing-many-to-many-values" title="Permalink to this headline">¶</a></h3>
<p>Many-to-many values work like foreign-key values, except we deal with
<code class="docutils literal notranslate"><span class="pre">QuerySet</span></code> values instead of model instances. For example, here’s how to
view the authors for a book:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="go">[&lt;Author: Adrian Holovaty&gt;, &lt;Author: Jacob Kaplan-Moss&gt;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">first_name</span><span class="o">=</span><span class="s1">&#39;Adrian&#39;</span><span class="p">)</span>
<span class="go">[&lt;Author: Adrian Holovaty&gt;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">first_name</span><span class="o">=</span><span class="s1">&#39;Adam&#39;</span><span class="p">)</span>
<span class="go">[]</span>
</pre></div>
</div>
<p>It works in reverse, too. To view all of the books for an author, use
<code class="docutils literal notranslate"><span class="pre">author.book_set</span></code>, like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">first_name</span><span class="o">=</span><span class="s1">&#39;Adrian&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s1">&#39;Holovaty&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">book_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="go">[&lt;Book: The Django Book&gt;, &lt;Book: Adrian&#39;s Other Book&gt;]</span>
</pre></div>
</div>
<p>Here, as with <code class="docutils literal notranslate"><span class="pre">ForeignKey</span></code> fields, the attribute name <code class="docutils literal notranslate"><span class="pre">book_set</span></code> is
generated by appending the lower case model name to <code class="docutils literal notranslate"><span class="pre">_set</span></code>.</p>
</div>
</div>
<div class="section" id="making-changes-to-a-database-schema">
<h2>Making Changes to a Database Schema<a class="headerlink" href="#making-changes-to-a-database-schema" title="Permalink to this headline">¶</a></h2>
<p>When we introduced the <code class="docutils literal notranslate"><span class="pre">syncdb</span></code> command in Chapter 5, we noted that
<code class="docutils literal notranslate"><span class="pre">syncdb</span></code> merely creates tables that don’t yet exist in your database –
it does <em>not</em> sync changes in models or perform deletions of models. If you
add or change a model’s field, or if you delete a model, you’ll need to make
the change in your database manually. This section explains how to do that.</p>
<p>When dealing with schema changes, it’s important to keep a few things in mind
about how Django’s database layer works:</p>
<ul class="simple">
<li>Django will complain loudly if a model contains a field that has not yet
been created in the database table. This will cause an error the first
time you use the Django database API to query the given table (i.e., it
will happen at code execution time, not at compilation time).</li>
<li>Django does <em>not</em> care if a database table contains columns that are not
defined in the model.</li>
<li>Django does <em>not</em> care if a database contains a table that is not
represented by a model.</li>
</ul>
<p>Making schema changes is a matter of changing the various pieces – the Python
code and the database itself – in the right order.</p>
<div class="section" id="adding-fields">
<h3>Adding Fields<a class="headerlink" href="#adding-fields" title="Permalink to this headline">¶</a></h3>
<p>When adding a field to a table/model in a production setting, the trick is to
take advantage of the fact that Django doesn’t care if a table contains columns
that aren’t defined in the model. The strategy is to add the column in the
database, and then update the Django model to include the new field.</p>
<p>However, there’s a bit of a chicken-and-egg problem here, because in order to
know how the new database column should be expressed in SQL, you need to look
at the output of Django’s <code class="docutils literal notranslate"><span class="pre">manage.py</span> <span class="pre">sqlall</span></code> command, which requires that the
field exist in the model. (Note that you’re not <em>required</em> to create your
column with exactly the same SQL that Django would, but it’s a good idea to do
so, just to be sure everything’s in sync.)</p>
<p>The solution to the chicken-and-egg problem is to use a development environment
instead of making the changes on a production server. (You <em>are</em> using a
testing/development environment, right?) Here are the detailed steps to take.</p>
<p>First, take these steps in the development environment (i.e., not on the production server):</p>
<ol class="arabic simple">
<li>Add the field to your model.</li>
<li>Run <code class="docutils literal notranslate"><span class="pre">manage.py</span> <span class="pre">sqlall</span> <span class="pre">[yourapp]</span></code> to see the new <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TABLE</span></code>
statement for the model. Note the column definition for the new field.</li>
<li>Start your database’s interactive shell (e.g., <code class="docutils literal notranslate"><span class="pre">psql</span></code> or <code class="docutils literal notranslate"><span class="pre">mysql</span></code>, or
you can use <code class="docutils literal notranslate"><span class="pre">manage.py</span> <span class="pre">dbshell</span></code>). Execute an <code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">TABLE</span></code> statement
that adds your new column.</li>
<li>Launch the Python interactive shell with <code class="docutils literal notranslate"><span class="pre">manage.py</span> <span class="pre">shell</span></code>
and verify that the new field was added properly by importing the model
and selecting from the table (e.g., <code class="docutils literal notranslate"><span class="pre">MyModel.objects.all()[:5]</span></code>).
If you updated the database correctly, the statement should work without
errors.</li>
</ol>
<p>Then on the production server perform these steps:</p>
<ol class="arabic simple">
<li>Start your database’s interactive shell.</li>
<li>Execute the <code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">TABLE</span></code> statement you used in step 3 of the
development environment steps.</li>
<li>Add the field to your model. If you’re using source-code revision
control and you checked in your change in development environment step
1, now is the time to update the code (e.g., <code class="docutils literal notranslate"><span class="pre">svn</span> <span class="pre">update</span></code>, with
Subversion) on the production server.</li>
<li>Restart the Web server for the code changes to take effect.</li>
</ol>
<p>For example, let’s walk through what we’d do if we added a <code class="docutils literal notranslate"><span class="pre">num_pages</span></code> field
to the <code class="docutils literal notranslate"><span class="pre">Book</span></code> model from Chapter 5. First, we’d alter the
model in our development environment to look like this:</p>
<pre class="literal-block">
class Book(models.Model):
    title = models.CharField(max_length=100)
    authors = models.ManyToManyField(Author)
    publisher = models.ForeignKey(Publisher)
    publication_date = models.DateField()
    <strong>num_pages = models.IntegerField(blank=True, null=True)</strong>

    def __unicode__(self):
        return self.title
</pre>
<p>(Note: Read the section “Making Fields Optional” in Chapter 6, plus the
sidebar “Adding NOT NULL Columns” below for important details on why we
included <code class="docutils literal notranslate"><span class="pre">blank=True</span></code> and <code class="docutils literal notranslate"><span class="pre">null=True</span></code>.)</p>
<p>Then we’d run the command <code class="docutils literal notranslate"><span class="pre">manage.py</span> <span class="pre">sqlall</span> <span class="pre">books</span></code> to see the
<code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TABLE</span></code> statement. Depending on your database backend, it would
look something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="s2">&quot;books_book&quot;</span> <span class="p">(</span>
    <span class="s2">&quot;id&quot;</span> <span class="n">serial</span> <span class="n">NOT</span> <span class="n">NULL</span> <span class="n">PRIMARY</span> <span class="n">KEY</span><span class="p">,</span>
    <span class="s2">&quot;title&quot;</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span>
    <span class="s2">&quot;publisher_id&quot;</span> <span class="n">integer</span> <span class="n">NOT</span> <span class="n">NULL</span> <span class="n">REFERENCES</span> <span class="s2">&quot;books_publisher&quot;</span> <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
    <span class="s2">&quot;publication_date&quot;</span> <span class="n">date</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span>
    <span class="s2">&quot;num_pages&quot;</span> <span class="n">integer</span> <span class="n">NULL</span>
<span class="p">);</span>
</pre></div>
</div>
<p>The new column is represented like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;num_pages&quot;</span> <span class="n">integer</span> <span class="n">NULL</span>
</pre></div>
</div>
<p>Next, we’d start the database’s interactive shell for our development database
by typing <code class="docutils literal notranslate"><span class="pre">psql</span></code> (for PostgreSQL), and we’d execute the following statements:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">books_book</span> <span class="n">ADD</span> <span class="n">COLUMN</span> <span class="n">num_pages</span> <span class="n">integer</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition-adding-not-null-columns admonition">
<p class="first admonition-title">Adding NOT NULL Columns</p>
<p>There’s a subtlety here that deserves mention. When we added the
<code class="docutils literal notranslate"><span class="pre">num_pages</span></code> field to our model, we included the <code class="docutils literal notranslate"><span class="pre">blank=True</span></code> and
<code class="docutils literal notranslate"><span class="pre">null=True</span></code> options. We did this because a database column will contain
NULL values when you first create it.</p>
<p>However, it’s also possible to add columns that cannot contain NULL values.
To do this, you have to create the column as <code class="docutils literal notranslate"><span class="pre">NULL</span></code>, then populate the
column’s values using some default(s), and then alter the column to set the
<code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code> modifier. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BEGIN</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">books_book</span> <span class="n">ADD</span> <span class="n">COLUMN</span> <span class="n">num_pages</span> <span class="n">integer</span><span class="p">;</span>
<span class="n">UPDATE</span> <span class="n">books_book</span> <span class="n">SET</span> <span class="n">num_pages</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">books_book</span> <span class="n">ALTER</span> <span class="n">COLUMN</span> <span class="n">num_pages</span> <span class="n">SET</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">;</span>
<span class="n">COMMIT</span><span class="p">;</span>
</pre></div>
</div>
<p class="last">If you go down this path, remember that you should leave off
<code class="docutils literal notranslate"><span class="pre">blank=True</span></code> and <code class="docutils literal notranslate"><span class="pre">null=True</span></code> in your model (obviously).</p>
</div>
<p>After the <code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">TABLE</span></code> statement, we’d verify that the change worked
properly by starting the Python shell and running this code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">books.models</span> <span class="k">import</span> <span class="n">Book</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<p>If that code didn’t cause errors, we’d switch to our production server and
execute the <code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">TABLE</span></code> statement on the production database. Then, we’d
update the model in the production environment and restart the Web server.</p>
</div>
<div class="section" id="removing-fields">
<h3>Removing Fields<a class="headerlink" href="#removing-fields" title="Permalink to this headline">¶</a></h3>
<p>Removing a field from a model is a lot easier than adding one. To remove a
field, just follow these steps:</p>
<ol class="arabic">
<li><p class="first">Remove the field from your model and restart the Web server.</p>
</li>
<li><p class="first">Remove the column from your database, using a command like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">books_book</span> <span class="n">DROP</span> <span class="n">COLUMN</span> <span class="n">num_pages</span><span class="p">;</span>
</pre></div>
</div>
</li>
</ol>
<p>Make sure to do it in this order. If you remove the column from your database
first, Django will immediately begin raising errors.</p>
</div>
<div class="section" id="removing-many-to-many-fields">
<h3>Removing Many-to-Many Fields<a class="headerlink" href="#removing-many-to-many-fields" title="Permalink to this headline">¶</a></h3>
<p>Because many-to-many fields are different than normal fields, the removal
process is different:</p>
<ol class="arabic">
<li><p class="first">Remove the <code class="docutils literal notranslate"><span class="pre">ManyToManyField</span></code> from your model and restart the Web
server.</p>
</li>
<li><p class="first">Remove the many-to-many table from your database, using a command like
this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DROP</span> <span class="n">TABLE</span> <span class="n">books_book_authors</span><span class="p">;</span>
</pre></div>
</div>
</li>
</ol>
<p>As in the previous section, make sure to do it in this order.</p>
</div>
<div class="section" id="removing-models">
<h3>Removing Models<a class="headerlink" href="#removing-models" title="Permalink to this headline">¶</a></h3>
<p>Removing a model entirely is as easy as removing a field. To remove a model,
just follow these steps:</p>
<ol class="arabic">
<li><p class="first">Remove the model from your <code class="docutils literal notranslate"><span class="pre">models.py</span></code> file and restart the Web server.</p>
</li>
<li><p class="first">Remove the table from your database, using a command like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DROP</span> <span class="n">TABLE</span> <span class="n">books_book</span><span class="p">;</span>
</pre></div>
</div>
<p>Note that you might need to remove any dependent tables from your
database first – e.g., any tables that have foreign keys to
<code class="docutils literal notranslate"><span class="pre">books_book</span></code>.</p>
</li>
</ol>
<p>As in the previous sections, make sure to do it in this order.</p>
</div>
</div>
<div class="section" id="managers">
<h2>Managers<a class="headerlink" href="#managers" title="Permalink to this headline">¶</a></h2>
<p>In the statement <code class="docutils literal notranslate"><span class="pre">Book.objects.all()</span></code>, <code class="docutils literal notranslate"><span class="pre">objects</span></code> is a special attribute
through which you query your database. In Chapter 5, we briefly identified this
as the model’s <em>manager</em>. Now it’s time to dive a bit deeper into what managers
are and how you can use them.</p>
<p>In short, a model’s manager is an object through which Django models perform
database queries. Each Django model has at least one manager, and you can
create custom managers in order to customize database access.</p>
<p>There are two reasons you might want to create a custom manager: to add extra
manager methods, and/or to modify the initial <code class="docutils literal notranslate"><span class="pre">QuerySet</span></code> the manager
returns.</p>
<div class="section" id="adding-extra-manager-methods">
<h3>Adding Extra Manager Methods<a class="headerlink" href="#adding-extra-manager-methods" title="Permalink to this headline">¶</a></h3>
<p>Adding extra manager methods is the preferred way to add “table-level”
functionality to your models. (For “row-level” functionality – i.e., functions
that act on a single instance of a model object – use model methods, which are
explained later in this chapter.)</p>
<p>For example, let’s give our <code class="docutils literal notranslate"><span class="pre">Book</span></code> model a manager method <code class="docutils literal notranslate"><span class="pre">title_count()</span></code>
that takes a keyword and returns the number of books that have a title
containing that keyword. (This example is slightly contrived, but it
demonstrates how managers work.)</p>
<pre class="literal-block">
# models.py

from django.db import models

# ... Author and Publisher models here ...

<strong>class BookManager(models.Manager):</strong>
    <strong>def title_count(self, keyword):</strong>
        <strong>return self.filter(title__icontains=keyword).count()</strong>

class Book(models.Model):
    title = models.CharField(max_length=100)
    authors = models.ManyToManyField(Author)
    publisher = models.ForeignKey(Publisher)
    publication_date = models.DateField()
    num_pages = models.IntegerField(blank=True, null=True)
    <strong>objects = BookManager()</strong>

    def __unicode__(self):
        return self.title
</pre>
<p>With this manager in place, we can now do this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">title_count</span><span class="p">(</span><span class="s1">&#39;django&#39;</span><span class="p">)</span>
<span class="go">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">title_count</span><span class="p">(</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
<span class="go">18</span>
</pre></div>
</div>
<p>Here are some notes about the code:</p>
<ul class="simple">
<li>We’ve created a <code class="docutils literal notranslate"><span class="pre">BookManager</span></code> class that extends
<code class="docutils literal notranslate"><span class="pre">django.db.models.Manager</span></code>. This has a single method,
<code class="docutils literal notranslate"><span class="pre">title_count()</span></code>, which does the calculation. Note that the method uses
<code class="docutils literal notranslate"><span class="pre">self.filter()</span></code>, where <code class="docutils literal notranslate"><span class="pre">self</span></code> refers to the manager itself.</li>
<li>We’ve assigned <code class="docutils literal notranslate"><span class="pre">BookManager()</span></code> to the <code class="docutils literal notranslate"><span class="pre">objects</span></code> attribute on the
model. This has the effect of replacing the “default” manager for the
model, which is called <code class="docutils literal notranslate"><span class="pre">objects</span></code> and is automatically created if you
don’t specify a custom manager. We call it <code class="docutils literal notranslate"><span class="pre">objects</span></code> rather than
something else, so as to be consistent with automatically created
managers.</li>
</ul>
<p>Why would we want to add a method such as <code class="docutils literal notranslate"><span class="pre">title_count()</span></code>? To encapsulate
commonly executed queries so that we don’t have to duplicate code.</p>
</div>
<div class="section" id="modifying-initial-manager-querysets">
<h3>Modifying Initial Manager QuerySets<a class="headerlink" href="#modifying-initial-manager-querysets" title="Permalink to this headline">¶</a></h3>
<p>A manager’s base <code class="docutils literal notranslate"><span class="pre">QuerySet</span></code> returns all objects in the system. For
example, <code class="docutils literal notranslate"><span class="pre">Book.objects.all()</span></code> returns all books in the book database.</p>
<p>You can override a manager’s base <code class="docutils literal notranslate"><span class="pre">QuerySet</span></code> by overriding the
<code class="docutils literal notranslate"><span class="pre">Manager.get_query_set()</span></code> method. <code class="docutils literal notranslate"><span class="pre">get_query_set()</span></code> should return a
<code class="docutils literal notranslate"><span class="pre">QuerySet</span></code> with the properties you require.</p>
<p>For example, the following model has <em>two</em> managers – one that returns
all objects, and one that returns only the books by Roald Dahl.</p>
<pre class="literal-block">
from django.db import models

<strong># First, define the Manager subclass.</strong>
<strong>class DahlBookManager(models.Manager):</strong>
    <strong>def get_query_set(self):</strong>
        <strong>return super(DahlBookManager, self).get_query_set().filter(author='Roald Dahl')</strong>

<strong># Then hook it into the Book model explicitly.</strong>
class Book(models.Model):
    title = models.CharField(max_length=100)
    author = models.CharField(max_length=50)
    # ...

    <strong>objects = models.Manager() # The default manager.</strong>
    <strong>dahl_objects = DahlBookManager() # The Dahl-specific manager.</strong>
</pre>
<p>With this sample model, <code class="docutils literal notranslate"><span class="pre">Book.objects.all()</span></code> will return all books in the
database, but <code class="docutils literal notranslate"><span class="pre">Book.dahl_objects.all()</span></code> will only return the ones written by
Roald Dahl. Note that we explicitly set <code class="docutils literal notranslate"><span class="pre">objects</span></code> to a vanilla <code class="docutils literal notranslate"><span class="pre">Manager</span></code>
instance, because if we hadn’t, the only available manager would be
<code class="docutils literal notranslate"><span class="pre">dahl_objects</span></code>.</p>
<p>Of course, because <code class="docutils literal notranslate"><span class="pre">get_query_set()</span></code> returns a <code class="docutils literal notranslate"><span class="pre">QuerySet</span></code> object, you can
use <code class="docutils literal notranslate"><span class="pre">filter()</span></code>, <code class="docutils literal notranslate"><span class="pre">exclude()</span></code> and all the other <code class="docutils literal notranslate"><span class="pre">QuerySet</span></code> methods on it.
So these statements are all legal:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Book</span><span class="o">.</span><span class="n">dahl_objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="n">Book</span><span class="o">.</span><span class="n">dahl_objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Matilda&#39;</span><span class="p">)</span>
<span class="n">Book</span><span class="o">.</span><span class="n">dahl_objects</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
<p>This example also pointed out another interesting technique: using multiple
managers on the same model. You can attach as many <code class="docutils literal notranslate"><span class="pre">Manager()</span></code> instances to
a model as you’d like. This is an easy way to define common “filters” for your
models.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MaleManager</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Manager</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_query_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MaleManager</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_query_set</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">sex</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">FemaleManager</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Manager</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_query_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">FemaleManager</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_query_set</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">sex</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">sex</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">((</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;Male&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;Female&#39;</span><span class="p">)))</span>
    <span class="n">people</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
    <span class="n">men</span> <span class="o">=</span> <span class="n">MaleManager</span><span class="p">()</span>
    <span class="n">women</span> <span class="o">=</span> <span class="n">FemaleManager</span><span class="p">()</span>
</pre></div>
</div>
<p>This example allows you to request <code class="docutils literal notranslate"><span class="pre">Person.men.all()</span></code>, <code class="docutils literal notranslate"><span class="pre">Person.women.all()</span></code>,
and <code class="docutils literal notranslate"><span class="pre">Person.people.all()</span></code>, yielding predictable results.</p>
<p>If you use custom <code class="docutils literal notranslate"><span class="pre">Manager</span></code> objects, take note that the first
<code class="docutils literal notranslate"><span class="pre">Manager</span></code> Django encounters (in the order in which they’re defined
in the model) has a special status. Django interprets this first
<code class="docutils literal notranslate"><span class="pre">Manager</span></code> defined in a class as the “default” <code class="docutils literal notranslate"><span class="pre">Manager</span></code>, and
several parts of Django (though not the admin application) will use
that <code class="docutils literal notranslate"><span class="pre">Manager</span></code> exclusively for that model. As a result, it’s often a
good idea to be careful in your choice of default manager, in order to
avoid a situation where overriding of <code class="docutils literal notranslate"><span class="pre">get_query_set()</span></code> results in
an inability to retrieve objects you’d like to work with.</p>
</div>
</div>
<div class="section" id="model-methods">
<h2>Model methods<a class="headerlink" href="#model-methods" title="Permalink to this headline">¶</a></h2>
<p>Define custom methods on a model to add custom “row-level” functionality to your
objects. Whereas managers are intended to do “table-wide” things, model methods
should act on a particular model instance.</p>
<p>This is a valuable technique for keeping business logic in one place – the
model.</p>
<p>An example is the easiest way to explain this. Here’s a model with a few custom
methods:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.localflavor.us.models</span> <span class="k">import</span> <span class="n">USStateField</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">birth_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">()</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">city</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">USStateField</span><span class="p">()</span> <span class="c1"># Yes, this is U.S.-centric...</span>

    <span class="k">def</span> <span class="nf">baby_boomer_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Returns the person&#39;s baby-boomer status.&quot;</span>
        <span class="kn">import</span> <span class="nn">datetime</span>
        <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">1945</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">birth_date</span> <span class="o">&lt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">1964</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;Baby boomer&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">birth_date</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">1945</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;Pre-boomer&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;Post-boomer&quot;</span>

    <span class="k">def</span> <span class="nf">is_midwestern</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Returns True if this person is from the Midwest.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;IL&#39;</span><span class="p">,</span> <span class="s1">&#39;WI&#39;</span><span class="p">,</span> <span class="s1">&#39;MI&#39;</span><span class="p">,</span> <span class="s1">&#39;IN&#39;</span><span class="p">,</span> <span class="s1">&#39;OH&#39;</span><span class="p">,</span> <span class="s1">&#39;IA&#39;</span><span class="p">,</span> <span class="s1">&#39;MO&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_full_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Returns the person&#39;s full name.&quot;</span>
        <span class="k">return</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span>
    <span class="n">full_name</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_full_name</span><span class="p">)</span>
</pre></div>
</div>
<p>The last method in this example is a “property.” Read more about properties
at <a class="reference external" href="http://www.python.org/download/releases/2.2/descrintro/#property">http://www.python.org/download/releases/2.2/descrintro/#property</a></p>
<p>And here’s example usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">first_name</span><span class="o">=</span><span class="s1">&#39;Barack&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s1">&#39;Obama&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">birth_date</span>
<span class="go">datetime.date(1961, 8, 4)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">baby_boomer_status</span><span class="p">()</span>
<span class="go">&#39;Baby boomer&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">is_midwestern</span><span class="p">()</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">full_name</span>  <span class="c1"># Note this isn&#39;t a method -- it&#39;s treated as an attribute</span>
<span class="go">u&#39;Barack Obama&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="executing-raw-sql-queries">
<h2>Executing Raw SQL Queries<a class="headerlink" href="#executing-raw-sql-queries" title="Permalink to this headline">¶</a></h2>
<p>Sometimes you’ll find that the Django database API can only take you so far,
and you’ll want to write custom SQL queries against your database. You can do
this very easily by accessing the object <code class="docutils literal notranslate"><span class="pre">django.db.connection</span></code>, which
represents the current database connection. To use it, call
<code class="docutils literal notranslate"><span class="pre">connection.cursor()</span></code> to get a cursor object. Then, call
<code class="docutils literal notranslate"><span class="pre">cursor.execute(sql,</span> <span class="pre">[params])</span></code> to execute the SQL and
<code class="docutils literal notranslate"><span class="pre">cursor.fetchone()</span></code> or <code class="docutils literal notranslate"><span class="pre">cursor.fetchall()</span></code> to return the resulting
rows. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">connection</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="s2">   SELECT DISTINCT first_name</span>
<span class="gp">... </span><span class="s2">   FROM people_person</span>
<span class="gp">... </span><span class="s2">   WHERE last_name = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Lennon&#39;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="n">row</span>
<span class="go">[&#39;John&#39;]</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">connection</span></code> and <code class="docutils literal notranslate"><span class="pre">cursor</span></code> mostly implement the standard Python “DB-API,”
which you can read about at <a class="reference external" href="http://www.python.org/peps/pep-0249.html">http://www.python.org/peps/pep-0249.html</a>. If you’re
not familiar with the Python DB-API, note that the SQL statement in
<code class="docutils literal notranslate"><span class="pre">cursor.execute()</span></code> uses placeholders, <code class="docutils literal notranslate"><span class="pre">&quot;%s&quot;</span></code>, rather than adding parameters
directly within the SQL. If you use this technique, the underlying database
library will automatically add quotes and escaping to your parameter(s) as
necessary.</p>
<p>Rather than littering your view code with these <code class="docutils literal notranslate"><span class="pre">django.db.connection</span></code>
statements, it’s a good idea to put them in custom model methods or manager
methods. For example, the above example could be integrated into a custom
manager method like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">connection</span><span class="p">,</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">PersonManager</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Manager</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">first_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">last_name</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT DISTINCT first_name</span>
<span class="s2">            FROM people_person</span>
<span class="s2">            WHERE last_name = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">last_name</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()]</span>

<span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">PersonManager</span><span class="p">()</span>
</pre></div>
</div>
<p>And sample usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first_names</span><span class="p">(</span><span class="s1">&#39;Lennon&#39;</span><span class="p">)</span>
<span class="go">[&#39;John&#39;, &#39;Cynthia&#39;]</span>
</pre></div>
</div>
</div>
<div class="section" id="what-s-next">
<h2>What’s Next?<a class="headerlink" href="#what-s-next" title="Permalink to this headline">¶</a></h2>
<p>In the <a class="reference external" href="chapter11.html">next chapter</a>, we’ll show you Django’s “generic views” framework, which
lets you save time in building Web sites that follow common patterns.</p>
</div>
</div>
</div>

          </div>
        </div>
      </div>
      <div id="ft">
        
<div class="nav">
    
        <a href='chapter09.html'>&laquo; previous</a> &loz;
    
    <a href="index.html">table of contents</a>
    
        &loz; <a href='chapter11.html'>next &raquo;</a>
    
</div>

        Copyright Adrian Holovaty, Jacob Kaplan-Moss, et al.<br>This
        work is licensed under the <a href="license.html">GNU Free Document
        License</a>.
      </div>
    </div>
  
  </body>
</html>