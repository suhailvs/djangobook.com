<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 9: Advanced Templates</title>
    <link rel="stylesheet" href="_static/reset-min.css" type="text/css">
    <link rel="stylesheet" href="_static/grids-min.css" type="text/css">
    <link rel="stylesheet" href="_static/djangobook.css" type="text/css">
    
  </head>
  <body>
    <div id="doc" class="yui-t7">
      <div id="hd">
        <h1><a href="index.html">The Django Book</a></h1>
        <div id="global-nav">
            <a class="about" href="frontmatter.html">About</a>
        </div>
        
<div class="nav">
    
        <a href='chapter08.html'>&laquo; previous</a> &loz;
    
    <a href="index.html">table of contents</a>
    
        &loz; <a href='chapter10.html'>next &raquo;</a>
    
</div>

      </div>
      <div id="bd">
        <div id="yui-main">
          <div class="yui-b">
            
  <div id="chapter-body"><div class="section" id="chapter-9-advanced-templates">
<h1>Chapter 9: Advanced Templates<a class="headerlink" href="#chapter-9-advanced-templates" title="Permalink to this headline">¶</a></h1>
<p>Although most of your interactions with Django’s template language will be in
the role of template author, you may want to customize and extend the template
engine – either to make it do something it doesn’t already do, or to make your
job easier in some other way.</p>
<p>This chapter delves deep into the guts of Django’s template system. It covers
what you need to know if you plan to extend the system or if you’re just
curious about how it works. It also covers the auto-escaping feature, a
security measure you’ll no doubt notice over time as you continue to use
Django.</p>
<p>If you’re looking to use the Django template system as part of another
application (i.e., without the rest of the framework), make sure to read the
“Configuring the Template System in Standalone Mode” section later in the
chapter.</p>
<div class="section" id="template-language-review">
<h2>Template Language Review<a class="headerlink" href="#template-language-review" title="Permalink to this headline">¶</a></h2>
<p>First, let’s quickly review a number of terms introduced in Chapter 4:</p>
<ul>
<li><p class="first">A <em>template</em> is a text document, or a normal Python string, that is
marked up using the Django template language. A template can contain
template tags and variables.</p>
</li>
<li><p class="first">A <em>template tag</em> is a symbol within a template that does something. This
definition is deliberately vague. For example, a template tag can produce
content, serve as a control structure (an <code class="docutils literal notranslate"><span class="pre">if</span></code> statement or <code class="docutils literal notranslate"><span class="pre">for</span></code>
loop), grab content from a database, or enable access to other template
tags.</p>
<p>Template tags are surrounded by <code class="docutils literal notranslate"><span class="pre">{%</span></code> and <code class="docutils literal notranslate"><span class="pre">%}</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>{% if is_logged_in %}
    Thanks for logging in!
{% else %}
    Please log in.
{% endif %}
</pre></div>
</div>
</li>
<li><p class="first">A <em>variable</em> is a symbol within a template that outputs a value.</p>
<p>Variable tags are surrounded by <code class="docutils literal notranslate"><span class="pre">{{</span></code> and <code class="docutils literal notranslate"><span class="pre">}}</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">My</span> <span class="n">first</span> <span class="n">name</span> <span class="ow">is</span> <span class="p">{{</span> <span class="n">first_name</span> <span class="p">}}</span><span class="o">.</span> <span class="n">My</span> <span class="n">last</span> <span class="n">name</span> <span class="ow">is</span> <span class="p">{{</span> <span class="n">last_name</span> <span class="p">}}</span><span class="o">.</span>
</pre></div>
</div>
</li>
<li><p class="first">A <em>context</em> is a name -&gt; value mapping (similar to a Python
dictionary) that is passed to a template.</p>
</li>
<li><p class="first">A template <em>renders</em> a context by replacing the variable “holes” with
values from the context and executing all template tags.</p>
</li>
</ul>
<p>For more details about the basics of these terms, refer back to Chapter 4.</p>
<p>The rest of this chapter discusses ways of extending the template engine. First,
though, let’s take a quick look at a few internals left out of Chapter 4 for
simplicity.</p>
</div>
<div class="section" id="requestcontext-and-context-processors">
<h2>RequestContext and Context Processors<a class="headerlink" href="#requestcontext-and-context-processors" title="Permalink to this headline">¶</a></h2>
<p>When rendering a template, you need a context. This can be an instance of
<code class="docutils literal notranslate"><span class="pre">django.template.Context</span></code>, but Django also comes with a subclass,
<code class="docutils literal notranslate"><span class="pre">django.template.RequestContext</span></code>, that acts slightly differently.
<code class="docutils literal notranslate"><span class="pre">RequestContext</span></code> adds a bunch of variables to your template context by
default – things like the <code class="docutils literal notranslate"><span class="pre">HttpRequest</span></code> object or information about the
currently logged-in user. The <code class="docutils literal notranslate"><span class="pre">render()</span></code> shortcut creates a <code class="docutils literal notranslate"><span class="pre">RequestContext</span></code>
unless it is passed a different context instance explicitly.</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">RequestContext</span></code> when you don’t want to have to specify the same set of
variables in a series of templates. For example, consider these two views:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.template</span> <span class="k">import</span> <span class="n">loader</span><span class="p">,</span> <span class="n">Context</span>

<span class="k">def</span> <span class="nf">view_1</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s1">&#39;template1.html&#39;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Context</span><span class="p">({</span>
        <span class="s1">&#39;app&#39;</span><span class="p">:</span> <span class="s1">&#39;My app&#39;</span><span class="p">,</span>
        <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
        <span class="s1">&#39;ip_address&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">],</span>
        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;I am view 1.&#39;</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">view_2</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s1">&#39;template2.html&#39;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Context</span><span class="p">({</span>
        <span class="s1">&#39;app&#39;</span><span class="p">:</span> <span class="s1">&#39;My app&#39;</span><span class="p">,</span>
        <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
        <span class="s1">&#39;ip_address&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">],</span>
        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;I am the second view.&#39;</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<p>(Note that we’re deliberately <em>not</em> using the <code class="docutils literal notranslate"><span class="pre">render()</span></code> shortcut
in these examples – we’re manually loading the templates, constructing the
context objects and rendering the templates. We’re “spelling out” all of the
steps for the purpose of clarity.)</p>
<p>Each view passes the same three variables – <code class="docutils literal notranslate"><span class="pre">app</span></code>, <code class="docutils literal notranslate"><span class="pre">user</span></code> and
<code class="docutils literal notranslate"><span class="pre">ip_address</span></code> – to its template. Wouldn’t it be nice if we could remove that
redundancy?</p>
<p><code class="docutils literal notranslate"><span class="pre">RequestContext</span></code> and <strong>context processors</strong> were created to solve this
problem. Context processors let you specify a number of variables that get set
in each context automatically – without you having to specify the variables in
each <code class="docutils literal notranslate"><span class="pre">render()</span></code> call. The catch is that you have to use
<code class="docutils literal notranslate"><span class="pre">RequestContext</span></code> instead of <code class="docutils literal notranslate"><span class="pre">Context</span></code> when you render a template.</p>
<p>The most low-level way of using context processors is to create some processors
and pass them to <code class="docutils literal notranslate"><span class="pre">RequestContext</span></code>. Here’s how the above example could be
written with context processors:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.template</span> <span class="k">import</span> <span class="n">loader</span><span class="p">,</span> <span class="n">RequestContext</span>

<span class="k">def</span> <span class="nf">custom_proc</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="s2">&quot;A context processor that provides &#39;app&#39;, &#39;user&#39; and &#39;ip_address&#39;.&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;app&#39;</span><span class="p">:</span> <span class="s1">&#39;My app&#39;</span><span class="p">,</span>
        <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
        <span class="s1">&#39;ip_address&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">]</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">view_1</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s1">&#39;template1.html&#39;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;I am view 1.&#39;</span><span class="p">},</span>
            <span class="n">processors</span><span class="o">=</span><span class="p">[</span><span class="n">custom_proc</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">view_2</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s1">&#39;template2.html&#39;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;I am the second view.&#39;</span><span class="p">},</span>
            <span class="n">processors</span><span class="o">=</span><span class="p">[</span><span class="n">custom_proc</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s step through this code:</p>
<ul class="simple">
<li>First, we define a function <code class="docutils literal notranslate"><span class="pre">custom_proc</span></code>. This is a context processor
– it takes an <code class="docutils literal notranslate"><span class="pre">HttpRequest</span></code> object and returns a dictionary of
variables to use in the template context. That’s all it does.</li>
<li>We’ve changed the two view functions to use <code class="docutils literal notranslate"><span class="pre">RequestContext</span></code> instead
of <code class="docutils literal notranslate"><span class="pre">Context</span></code>. There are two differences in how the context is
constructed. One, <code class="docutils literal notranslate"><span class="pre">RequestContext</span></code> requires the first argument to be an
<code class="docutils literal notranslate"><span class="pre">HttpRequest</span></code> object – the one that was passed into the view function
in the first place (<code class="docutils literal notranslate"><span class="pre">request</span></code>). Two, <code class="docutils literal notranslate"><span class="pre">RequestContext</span></code> takes an
optional <code class="docutils literal notranslate"><span class="pre">processors</span></code> argument, which is a list or tuple of context
processor functions to use. Here, we pass in <code class="docutils literal notranslate"><span class="pre">custom_proc</span></code>, the custom
processor we defined above.</li>
<li>Each view no longer has to include <code class="docutils literal notranslate"><span class="pre">app</span></code>, <code class="docutils literal notranslate"><span class="pre">user</span></code> or <code class="docutils literal notranslate"><span class="pre">ip_address</span></code> in
its context construction, because those are provided by <code class="docutils literal notranslate"><span class="pre">custom_proc</span></code>.</li>
<li>Each view <em>still</em> has the flexibility to introduce any custom template
variables it might need. In this example, the <code class="docutils literal notranslate"><span class="pre">message</span></code> template
variable is set differently in each view.</li>
</ul>
<p>In Chapter 4, we introduced the <code class="docutils literal notranslate"><span class="pre">render()</span></code> shortcut, which saves
you from having to call <code class="docutils literal notranslate"><span class="pre">loader.get_template()</span></code>, then create a <code class="docutils literal notranslate"><span class="pre">Context</span></code>,
then call the <code class="docutils literal notranslate"><span class="pre">render()</span></code> method on the template. In order to demonstrate the
lower-level workings of context processors, the above examples didn’t use
<code class="docutils literal notranslate"><span class="pre">render()</span></code>, . But it’s possible – and preferable – to use
context processors with <code class="docutils literal notranslate"><span class="pre">render()</span></code>. Do this with the
<code class="docutils literal notranslate"><span class="pre">context_instance</span></code> argument, like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="k">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="k">import</span> <span class="n">RequestContext</span>

<span class="k">def</span> <span class="nf">custom_proc</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="s2">&quot;A context processor that provides &#39;app&#39;, &#39;user&#39; and &#39;ip_address&#39;.&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;app&#39;</span><span class="p">:</span> <span class="s1">&#39;My app&#39;</span><span class="p">,</span>
        <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
        <span class="s1">&#39;ip_address&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">]</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">view_1</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;template1.html&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;I am view 1.&#39;</span><span class="p">},</span>
        <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">processors</span><span class="o">=</span><span class="p">[</span><span class="n">custom_proc</span><span class="p">]))</span>

<span class="k">def</span> <span class="nf">view_2</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;template2.html&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;I am the second view.&#39;</span><span class="p">},</span>
        <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">processors</span><span class="o">=</span><span class="p">[</span><span class="n">custom_proc</span><span class="p">]))</span>
</pre></div>
</div>
<p>Here, we’ve trimmed down each view’s template rendering code to a single
(wrapped) line.</p>
<p>This is an improvement, but, evaluating the conciseness of this code, we have
to admit we’re now almost overdosing on the <em>other</em> end of the spectrum. We’ve
removed redundancy in data (our template variables) at the cost of adding
redundancy in code (in the <code class="docutils literal notranslate"><span class="pre">processors</span></code> call). Using context processors
doesn’t save you much typing if you have to type <code class="docutils literal notranslate"><span class="pre">processors</span></code> all the time.</p>
<p>For that reason, Django provides support for <em>global</em> context processors. The
<code class="docutils literal notranslate"><span class="pre">TEMPLATE_CONTEXT_PROCESSORS</span></code> setting (in your <code class="docutils literal notranslate"><span class="pre">settings.py</span></code>) designates
which context processors should <em>always</em> be applied to <code class="docutils literal notranslate"><span class="pre">RequestContext</span></code>. This
removes the need to specify <code class="docutils literal notranslate"><span class="pre">processors</span></code> each time you use
<code class="docutils literal notranslate"><span class="pre">RequestContext</span></code>.</p>
<p>By default, <code class="docutils literal notranslate"><span class="pre">TEMPLATE_CONTEXT_PROCESSORS</span></code> is set to the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TEMPLATE_CONTEXT_PROCESSORS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;django.core.context_processors.auth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.core.context_processors.debug&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.core.context_processors.i18n&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.core.context_processors.media&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This setting is a tuple of callables that use the same interface as our
<code class="docutils literal notranslate"><span class="pre">custom_proc</span></code> function above – functions that take a request object as their
argument and return a dictionary of items to be merged into the context. Note
that the values in <code class="docutils literal notranslate"><span class="pre">TEMPLATE_CONTEXT_PROCESSORS</span></code> are specified as <em>strings</em>,
which means the processors are required to be somewhere on your Python path
(so you can refer to them from the setting).</p>
<p>Each processor is applied in order. That is, if one processor adds a variable
to the context and a second processor adds a variable with the same name, the
second will override the first.</p>
<p>Django provides a number of simple context processors, including the ones that
are enabled by default:</p>
<div class="section" id="django-core-context-processors-auth">
<h3>django.core.context_processors.auth<a class="headerlink" href="#django-core-context-processors-auth" title="Permalink to this headline">¶</a></h3>
<p>If <code class="docutils literal notranslate"><span class="pre">TEMPLATE_CONTEXT_PROCESSORS</span></code> contains this processor, every
<code class="docutils literal notranslate"><span class="pre">RequestContext</span></code> will contain these variables:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">user</span></code>: A <code class="docutils literal notranslate"><span class="pre">django.contrib.auth.models.User</span></code> instance representing the
current logged-in user (or an <code class="docutils literal notranslate"><span class="pre">AnonymousUser</span></code> instance, if the client
isn’t logged in).</li>
<li><code class="docutils literal notranslate"><span class="pre">messages</span></code>: A list of messages (as strings) for the current logged-in
user. Behind the scenes, this variable calls
<code class="docutils literal notranslate"><span class="pre">request.user.get_and_delete_messages()</span></code> for every request. That method
collects the user’s messages and deletes them from the database.</li>
<li><code class="docutils literal notranslate"><span class="pre">perms</span></code>: An instance of <code class="docutils literal notranslate"><span class="pre">django.core.context_processors.PermWrapper</span></code>,
which represents the permissions the current logged-in user has.</li>
</ul>
<p>See Chapter 14 for more information on users, permissions, and messages.</p>
</div>
<div class="section" id="django-core-context-processors-debug">
<h3>django.core.context_processors.debug<a class="headerlink" href="#django-core-context-processors-debug" title="Permalink to this headline">¶</a></h3>
<p>This processor pushes debugging information down to the template layer. If
<code class="docutils literal notranslate"><span class="pre">TEMPLATE_CONTEXT_PROCESSORS</span></code> contains this processor, every
<code class="docutils literal notranslate"><span class="pre">RequestContext</span></code> will contain these variables:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">debug</span></code>: The value of your <code class="docutils literal notranslate"><span class="pre">DEBUG</span></code> setting (either <code class="docutils literal notranslate"><span class="pre">True</span></code> or
<code class="docutils literal notranslate"><span class="pre">False</span></code>). You can use this variable in templates to test whether you’re
in debug mode.</li>
<li><code class="docutils literal notranslate"><span class="pre">sql_queries</span></code>: A list of <code class="docutils literal notranslate"><span class="pre">{'sql':</span> <span class="pre">...,</span> <span class="pre">'time':</span> <span class="pre">...}</span></code> dictionaries
representing every SQL query that has happened so far during the request
and how long it took. The list is in the order in which the queries were
issued.</li>
</ul>
<p>Because debugging information is sensitive, this context processor will only
add variables to the context if both of the following conditions are true:</p>
<ul class="simple">
<li>The <code class="docutils literal notranslate"><span class="pre">DEBUG</span></code> setting is <code class="docutils literal notranslate"><span class="pre">True</span></code>.</li>
<li>The request came from an IP address in the <code class="docutils literal notranslate"><span class="pre">INTERNAL_IPS</span></code> setting.</li>
</ul>
<p>Astute readers will notice that the <code class="docutils literal notranslate"><span class="pre">debug</span></code> template variable will never have
the value <code class="docutils literal notranslate"><span class="pre">False</span></code> because, if <code class="docutils literal notranslate"><span class="pre">DEBUG</span></code> is <code class="docutils literal notranslate"><span class="pre">False</span></code>, then the <code class="docutils literal notranslate"><span class="pre">debug</span></code>
template variable won’t be populated in the first place.</p>
</div>
<div class="section" id="django-core-context-processors-i18n">
<h3>django.core.context_processors.i18n<a class="headerlink" href="#django-core-context-processors-i18n" title="Permalink to this headline">¶</a></h3>
<p>If this processor is enabled, every <code class="docutils literal notranslate"><span class="pre">RequestContext</span></code> will contain these
variables:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">LANGUAGES</span></code>: The value of the <code class="docutils literal notranslate"><span class="pre">LANGUAGES</span></code> setting.</li>
<li><code class="docutils literal notranslate"><span class="pre">LANGUAGE_CODE</span></code>: <code class="docutils literal notranslate"><span class="pre">request.LANGUAGE_CODE</span></code> if it exists; otherwise, the
value of the <code class="docutils literal notranslate"><span class="pre">LANGUAGE_CODE</span></code> setting.</li>
</ul>
<p>Appendix D provides more information about these two settings.</p>
</div>
<div class="section" id="django-core-context-processors-request">
<h3>django.core.context_processors.request<a class="headerlink" href="#django-core-context-processors-request" title="Permalink to this headline">¶</a></h3>
<p>If this processor is enabled, every <code class="docutils literal notranslate"><span class="pre">RequestContext</span></code> will contain a variable
<code class="docutils literal notranslate"><span class="pre">request</span></code>, which is the current <code class="docutils literal notranslate"><span class="pre">HttpRequest</span></code> object. Note that this
processor is not enabled by default; you have to activate it.</p>
<p>You might want to use this if you find your templates needing to access
attributes of the current <code class="docutils literal notranslate"><span class="pre">HttpRequest</span></code> such as the IP address:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{{</span> <span class="n">request</span><span class="o">.</span><span class="n">REMOTE_ADDR</span> <span class="p">}}</span>
</pre></div>
</div>
</div>
<div class="section" id="guidelines-for-writing-your-own-context-processors">
<h3>Guidelines for Writing Your Own Context Processors<a class="headerlink" href="#guidelines-for-writing-your-own-context-processors" title="Permalink to this headline">¶</a></h3>
<p>Here are a few tips for rolling your own:</p>
<ul class="simple">
<li>Make each context processor responsible for the smallest subset of
functionality possible. It’s easy to use multiple processors, so you
might as well split functionality into logical pieces for future reuse.</li>
<li>Keep in mind that any context processor in <code class="docutils literal notranslate"><span class="pre">TEMPLATE_CONTEXT_PROCESSORS</span></code>
will be available in <em>every</em> template powered by that settings file, so
try to pick variable names that are unlikely to conflict with variable
names your templates might be using independently. As variable names are
case-sensitive, it’s not a bad idea to use all caps for variables that a
processor provides.</li>
<li>It doesn’t matter where on the filesystem they live, as long as they’re
on your Python path so you can point to them from the
<code class="docutils literal notranslate"><span class="pre">TEMPLATE_CONTEXT_PROCESSORS</span></code> setting. With that said, the convention
is to save them in a file called <code class="docutils literal notranslate"><span class="pre">context_processors.py</span></code> within your
app or project.</li>
</ul>
</div>
</div>
<div class="section" id="automatic-html-escaping">
<h2>Automatic HTML Escaping<a class="headerlink" href="#automatic-html-escaping" title="Permalink to this headline">¶</a></h2>
<p>When generating HTML from templates, there’s always a risk that a variable will
include characters that affect the resulting HTML. For example, consider this
template fragment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Hello</span><span class="p">,</span> <span class="p">{{</span> <span class="n">name</span> <span class="p">}}</span><span class="o">.</span>
</pre></div>
</div>
<p>At first, this seems like a harmless way to display a user’s name, but consider
what would happen if the user entered his name as this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span><span class="n">alert</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>With this name value, the template would be rendered as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Hello</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span><span class="n">alert</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>…which means the browser would pop-up a JavaScript alert box!</p>
<p>Similarly, what if the name contained a <code class="docutils literal notranslate"><span class="pre">'&lt;'</span></code> symbol, like this?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">username</span>
</pre></div>
</div>
<p>That would result in a rendered template like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Hello</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">username</span>
</pre></div>
</div>
<p>…which, in turn, would result in the remainder of the Web page being bolded!</p>
<p>Clearly, user-submitted data shouldn’t be trusted blindly and inserted directly
into your Web pages, because a malicious user could use this kind of hole to
do potentially bad things. This type of security exploit is called a
Cross Site Scripting (XSS) attack. (For more on security, see Chapter 20.)</p>
<p>To avoid this problem, you have two options:</p>
<ul class="simple">
<li>One, you can make sure to run each untrusted variable through the
<code class="docutils literal notranslate"><span class="pre">escape</span></code> filter, which converts potentially harmful HTML characters to
unharmful ones. This was the default solution in Django for its first few
years, but the problem is that it puts the onus on <em>you</em>, the developer /
template author, to ensure you’re escaping everything. It’s easy to forget
to escape data.</li>
<li>Two, you can take advantage of Django’s automatic HTML escaping. The
remainder of this section describes how auto-escaping works.</li>
</ul>
<p>By default in Django, every template automatically escapes the output
of every variable tag. Specifically, these five characters are
escaped:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">&lt;</span></code> is converted to <code class="docutils literal notranslate"><span class="pre">&amp;lt;</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">&gt;</span></code> is converted to <code class="docutils literal notranslate"><span class="pre">&amp;gt;</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">'</span></code> (single quote) is converted to <code class="docutils literal notranslate"><span class="pre">&amp;#39;</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">&quot;</span></code> (double quote) is converted to <code class="docutils literal notranslate"><span class="pre">&amp;quot;</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">&amp;</span></code> is converted to <code class="docutils literal notranslate"><span class="pre">&amp;amp;</span></code></li>
</ul>
<p>Again, we stress that this behavior is on by default. If you’re using Django’s
template system, you’re protected.</p>
<div class="section" id="how-to-turn-it-off">
<h3>How to Turn it Off<a class="headerlink" href="#how-to-turn-it-off" title="Permalink to this headline">¶</a></h3>
<p>If you don’t want data to be auto-escaped, on a per-site, per-template level or
per-variable level, you can turn it off in several ways.</p>
<p>Why would you want to turn it off? Because sometimes, template variables
contain data that you <em>intend</em> to be rendered as raw HTML, in which case you
don’t want their contents to be escaped. For example, you might store a blob of
trusted HTML in your database and want to embed that directly into your
template. Or, you might be using Django’s template system to produce text that
is <em>not</em> HTML – like an e-mail message, for instance.</p>
<div class="section" id="for-individual-variables">
<h4>For Individual Variables<a class="headerlink" href="#for-individual-variables" title="Permalink to this headline">¶</a></h4>
<p>To disable auto-escaping for an individual variable, use the <code class="docutils literal notranslate"><span class="pre">safe</span></code> filter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">This</span> <span class="n">will</span> <span class="n">be</span> <span class="n">escaped</span><span class="p">:</span> <span class="p">{{</span> <span class="n">data</span> <span class="p">}}</span>
<span class="n">This</span> <span class="n">will</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">escaped</span><span class="p">:</span> <span class="p">{{</span> <span class="n">data</span><span class="o">|</span><span class="n">safe</span> <span class="p">}}</span>
</pre></div>
</div>
<p>Think of <em>safe</em> as shorthand for <em>safe from further escaping</em> or <em>can be
safely interpreted as HTML</em>. In this example, if <code class="docutils literal notranslate"><span class="pre">data</span></code> contains <code class="docutils literal notranslate"><span class="pre">'&lt;b&gt;'</span></code>,
the output will be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">This</span> <span class="n">will</span> <span class="n">be</span> <span class="n">escaped</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">b</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span>
<span class="n">This</span> <span class="n">will</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">escaped</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="for-template-blocks">
<h4>For Template Blocks<a class="headerlink" href="#for-template-blocks" title="Permalink to this headline">¶</a></h4>
<p>To control auto-escaping for a template, wrap the template (or just a
particular section of the template) in the <code class="docutils literal notranslate"><span class="pre">autoescape</span></code> tag, like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="n">autoescape</span> <span class="n">off</span> <span class="o">%</span><span class="p">}</span>
    <span class="n">Hello</span> <span class="p">{{</span> <span class="n">name</span> <span class="p">}}</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endautoescape</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">autoescape</span></code> tag takes either <code class="docutils literal notranslate"><span class="pre">on</span></code> or <code class="docutils literal notranslate"><span class="pre">off</span></code> as its argument. At
times, you might want to force auto-escaping when it would otherwise be
disabled. Here is an example template:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Auto</span><span class="o">-</span><span class="n">escaping</span> <span class="ow">is</span> <span class="n">on</span> <span class="n">by</span> <span class="n">default</span><span class="o">.</span> <span class="n">Hello</span> <span class="p">{{</span> <span class="n">name</span> <span class="p">}}</span>

<span class="p">{</span><span class="o">%</span> <span class="n">autoescape</span> <span class="n">off</span> <span class="o">%</span><span class="p">}</span>
    <span class="n">This</span> <span class="n">will</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">auto</span><span class="o">-</span><span class="n">escaped</span><span class="p">:</span> <span class="p">{{</span> <span class="n">data</span> <span class="p">}}</span><span class="o">.</span>

    <span class="n">Nor</span> <span class="n">this</span><span class="p">:</span> <span class="p">{{</span> <span class="n">other_data</span> <span class="p">}}</span>
    <span class="p">{</span><span class="o">%</span> <span class="n">autoescape</span> <span class="n">on</span> <span class="o">%</span><span class="p">}</span>
        <span class="n">Auto</span><span class="o">-</span><span class="n">escaping</span> <span class="n">applies</span> <span class="n">again</span><span class="p">:</span> <span class="p">{{</span> <span class="n">name</span> <span class="p">}}</span>
    <span class="p">{</span><span class="o">%</span> <span class="n">endautoescape</span> <span class="o">%</span><span class="p">}</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endautoescape</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
<p>The auto-escaping tag passes its effect on to templates that extend the
current one as well as templates included via the <code class="docutils literal notranslate"><span class="pre">include</span></code> tag, just like
all block tags. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># base.html</span>

<span class="p">{</span><span class="o">%</span> <span class="n">autoescape</span> <span class="n">off</span> <span class="o">%</span><span class="p">}</span>
<span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="p">{</span><span class="o">%</span> <span class="n">block</span> <span class="n">title</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="n">endblock</span> <span class="o">%</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="p">{</span><span class="o">%</span> <span class="n">block</span> <span class="n">content</span> <span class="o">%</span><span class="p">}</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endblock</span> <span class="o">%</span><span class="p">}</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endautoescape</span> <span class="o">%</span><span class="p">}</span>

<span class="c1"># child.html</span>

<span class="p">{</span><span class="o">%</span> <span class="n">extends</span> <span class="s2">&quot;base.html&quot;</span> <span class="o">%</span><span class="p">}</span>
<span class="p">{</span><span class="o">%</span> <span class="n">block</span> <span class="n">title</span> <span class="o">%</span><span class="p">}</span><span class="n">This</span> <span class="o">&amp;</span> <span class="n">that</span><span class="p">{</span><span class="o">%</span> <span class="n">endblock</span> <span class="o">%</span><span class="p">}</span>
<span class="p">{</span><span class="o">%</span> <span class="n">block</span> <span class="n">content</span> <span class="o">%</span><span class="p">}{{</span> <span class="n">greeting</span> <span class="p">}}{</span><span class="o">%</span> <span class="n">endblock</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
<p>Because auto-escaping is turned off in the base template, it will also be
turned off in the child template, resulting in the following rendered
HTML when the <code class="docutils literal notranslate"><span class="pre">greeting</span></code> variable contains the string <code class="docutils literal notranslate"><span class="pre">&lt;b&gt;Hello!&lt;/b&gt;</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;h1&gt;This &amp; that&lt;/h1&gt;
&lt;b&gt;Hello!&lt;/b&gt;
</pre></div>
</div>
</div>
</div>
<div class="section" id="notes">
<h3>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h3>
<p>Generally, template authors don’t need to worry about auto-escaping very much.
Developers on the Python side (people writing views and custom filters) need to
think about the cases in which data shouldn’t be escaped, and mark data
appropriately, so things work in the template.</p>
<p>If you’re creating a template that might be used in situations where you’re
not sure whether auto-escaping is enabled, then add an <code class="docutils literal notranslate"><span class="pre">escape</span></code> filter to any
variable that needs escaping. When auto-escaping is on, there’s no danger of
the <code class="docutils literal notranslate"><span class="pre">escape</span></code> filter <em>double-escaping</em> data – the <code class="docutils literal notranslate"><span class="pre">escape</span></code> filter does not
affect auto-escaped variables.</p>
</div>
<div class="section" id="automatic-escaping-of-string-literals-in-filter-arguments">
<h3>Automatic Escaping of String Literals in Filter Arguments<a class="headerlink" href="#automatic-escaping-of-string-literals-in-filter-arguments" title="Permalink to this headline">¶</a></h3>
<p>As we mentioned earlier, filter arguments can be strings:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{{</span> <span class="n">data</span><span class="o">|</span><span class="n">default</span><span class="p">:</span><span class="s2">&quot;This is a string literal.&quot;</span> <span class="p">}}</span>
</pre></div>
</div>
<p>All string literals are inserted <em>without</em> any automatic escaping into the
template – they act as if they were all passed through the <code class="docutils literal notranslate"><span class="pre">safe</span></code> filter.
The reasoning behind this is that the template author is in control of what
goes into the string literal, so they can make sure the text is correctly
escaped when the template is written.</p>
<p>This means you would write</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{{</span> <span class="n">data</span><span class="o">|</span><span class="n">default</span><span class="p">:</span><span class="s2">&quot;3 &amp;lt; 2&quot;</span> <span class="p">}}</span>
</pre></div>
</div>
<p>…rather than</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>{{ data|default:&quot;3 &lt; 2&quot; }}  &lt;-- Bad! Don&#39;t do this.
</pre></div>
</div>
<p>This doesn’t affect what happens to data coming from the variable itself.
The variable’s contents are still automatically escaped, if necessary, because
they’re beyond the control of the template author.</p>
</div>
</div>
<div class="section" id="inside-template-loading">
<h2>Inside Template Loading<a class="headerlink" href="#inside-template-loading" title="Permalink to this headline">¶</a></h2>
<p>Generally, you’ll store templates in files on your filesystem, but you can use
custom <em>template loaders</em> to load templates from other sources.</p>
<p>Django has two ways to load templates:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">django.template.loader.get_template(template_name)</span></code>: <code class="docutils literal notranslate"><span class="pre">get_template</span></code>
returns the compiled template (a <code class="docutils literal notranslate"><span class="pre">Template</span></code> object) for the template
with the given name. If the template doesn’t exist, a
<code class="docutils literal notranslate"><span class="pre">TemplateDoesNotExist</span></code> exception will be raised.</li>
<li><code class="docutils literal notranslate"><span class="pre">django.template.loader.select_template(template_name_list)</span></code>:
<code class="docutils literal notranslate"><span class="pre">select_template</span></code> is just like <code class="docutils literal notranslate"><span class="pre">get_template</span></code>, except it takes a list
of template names. Of the list, it returns the first template that exists.
If none of the templates exist, a <code class="docutils literal notranslate"><span class="pre">TemplateDoesNotExist</span></code> exception will
be raised.</li>
</ul>
<p>As covered in Chapter 4, each of these functions by default uses your
<code class="docutils literal notranslate"><span class="pre">TEMPLATE_DIRS</span></code> setting to load templates. Internally, however, these
functions actually delegate to a template loader for the heavy lifting.</p>
<p>Some of loaders are disabled by default, but you can activate them by editing
the <code class="docutils literal notranslate"><span class="pre">TEMPLATE_LOADERS</span></code> setting. <code class="docutils literal notranslate"><span class="pre">TEMPLATE_LOADERS</span></code> should be a tuple of
strings, where each string represents a template loader. These template loaders
ship with Django:</p>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">django.template.loaders.filesystem.load_template_source</span></code>: This loader
loads templates from the filesystem, according to <code class="docutils literal notranslate"><span class="pre">TEMPLATE_DIRS</span></code>. It is
enabled by default.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">django.template.loaders.app_directories.load_template_source</span></code>: This
loader loads templates from Django applications on the filesystem. For
each application in <code class="docutils literal notranslate"><span class="pre">INSTALLED_APPS</span></code>, the loader looks for a
<code class="docutils literal notranslate"><span class="pre">templates</span></code> subdirectory. If the directory exists, Django looks for
templates there.</p>
<p>This means you can store templates with your individual applications,
making it easy to distribute Django applications with default templates.
For example, if <code class="docutils literal notranslate"><span class="pre">INSTALLED_APPS</span></code> contains <code class="docutils literal notranslate"><span class="pre">('myproject.polls',</span>
<span class="pre">'myproject.music')</span></code>, then <code class="docutils literal notranslate"><span class="pre">get_template('foo.html')</span></code> will look for
templates in this order:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">/path/to/myproject/polls/templates/foo.html</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">/path/to/myproject/music/templates/foo.html</span></code></li>
</ul>
<p>Note that the loader performs an optimization when it is first imported:
it caches a list of which <code class="docutils literal notranslate"><span class="pre">INSTALLED_APPS</span></code> packages have a <code class="docutils literal notranslate"><span class="pre">templates</span></code>
subdirectory.</p>
<p>This loader is enabled by default.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">django.template.loaders.eggs.load_template_source</span></code>: This loader is just
like <code class="docutils literal notranslate"><span class="pre">app_directories</span></code>, except it loads templates from Python eggs
rather than from the filesystem. This loader is disabled by default;
you’ll need to enable it if you’re using eggs to distribute your
application. (Python eggs are a way of compressing Python code into a
single file.)</p>
</li>
</ul>
<p>Django uses the template loaders in order according to the <code class="docutils literal notranslate"><span class="pre">TEMPLATE_LOADERS</span></code>
setting. It uses each loader until a loader finds a match.</p>
</div>
<div class="section" id="extending-the-template-system">
<h2>Extending the Template System<a class="headerlink" href="#extending-the-template-system" title="Permalink to this headline">¶</a></h2>
<p>Now that you understand a bit more about the internals of the template system,
let’s look at how to extend the system with custom code.</p>
<p>Most template customization comes in the form of custom template tags and/or
filters. Although the Django template language comes with many built-in tags and
filters, you’ll probably assemble your own libraries of tags and filters that
fit your own needs. Fortunately, it’s quite easy to define your own
functionality.</p>
<div class="section" id="creating-a-template-library">
<h3>Creating a Template Library<a class="headerlink" href="#creating-a-template-library" title="Permalink to this headline">¶</a></h3>
<p>Whether you’re writing custom tags or filters, the first thing to do is to
create a <strong>template library</strong> – a small bit of infrastructure Django can hook
into.</p>
<p>Creating a template library is a two-step process:</p>
<ul>
<li><p class="first">First, decide which Django application should house the template library.
If you’ve created an app via <code class="docutils literal notranslate"><span class="pre">manage.py</span> <span class="pre">startapp</span></code>, you can put it in
there, or you can create another app solely for the template library.
We’d recommend the latter, because your filters might be useful to you
in future projects.</p>
<p>Whichever route you take, make sure to add the app to your
<code class="docutils literal notranslate"><span class="pre">INSTALLED_APPS</span></code> setting. We’ll explain this shortly.</p>
</li>
<li><p class="first">Second, create a <code class="docutils literal notranslate"><span class="pre">templatetags</span></code> directory in the appropriate Django
application’s package. It should be on the same level as <code class="docutils literal notranslate"><span class="pre">models.py</span></code>,
<code class="docutils literal notranslate"><span class="pre">views.py</span></code>, and so forth. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">books</span><span class="o">/</span>
    <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
    <span class="n">models</span><span class="o">.</span><span class="n">py</span>
    <span class="n">templatetags</span><span class="o">/</span>
    <span class="n">views</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>Create two empty files in the <code class="docutils literal notranslate"><span class="pre">templatetags</span></code> directory: an <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code>
file (to indicate to Python that this is a package containing Python code)
and a file that will contain your custom tag/filter definitions. The name
of the latter file is what you’ll use to load the tags later. For example,
if your custom tags/filters are in a file called <code class="docutils literal notranslate"><span class="pre">poll_extras.py</span></code>, you’d
write the following in a template:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="n">load</span> <span class="n">poll_extras</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">load</span> <span class="pre">%}</span></code> tag looks at your <code class="docutils literal notranslate"><span class="pre">INSTALLED_APPS</span></code> setting and only
allows the loading of template libraries within installed Django
applications. This is a security feature; it allows you to host Python
code for many template libraries on a single computer without enabling
access to all of them for every Django installation.</p>
</li>
</ul>
<p>If you write a template library that isn’t tied to any particular models/views,
it’s valid and quite normal to have a Django application package that contains
only a <code class="docutils literal notranslate"><span class="pre">templatetags</span></code> package. There’s no limit on how many modules you put in
the <code class="docutils literal notranslate"><span class="pre">templatetags</span></code> package. Just keep in mind that a <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">load</span> <span class="pre">%}</span></code> statement
will load tags/filters for the given Python module name, not the name of the
application.</p>
<p>Once you’ve created that Python module, you’ll just have to write a bit of
Python code, depending on whether you’re writing filters or tags.</p>
<p>To be a valid tag library, the module must contain a module-level variable named
<code class="docutils literal notranslate"><span class="pre">register</span></code> that is an instance of <code class="docutils literal notranslate"><span class="pre">template.Library</span></code>. This is the data
structure in which all the tags and filters are registered. So, near the top of
your module, insert the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django</span> <span class="k">import</span> <span class="n">template</span>

<span class="n">register</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">Library</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For a fine selection of examples, read the source code for Django’s default
filters and tags. They’re in <code class="docutils literal notranslate"><span class="pre">django/template/defaultfilters.py</span></code> and
<code class="docutils literal notranslate"><span class="pre">django/template/defaulttags.py</span></code>, respectively. Some applications in
<code class="docutils literal notranslate"><span class="pre">django.contrib</span></code> also contain template libraries.</p>
</div>
<p>Once you’ve created this <code class="docutils literal notranslate"><span class="pre">register</span></code> variable, you’ll use it to create template
filters and tags.</p>
</div>
<div class="section" id="writing-custom-template-filters">
<h3>Writing Custom Template Filters<a class="headerlink" href="#writing-custom-template-filters" title="Permalink to this headline">¶</a></h3>
<p>Custom filters are just Python functions that take one or two arguments:</p>
<ul class="simple">
<li>The value of the variable (input)</li>
<li>The value of the argument, which can have a default value or be left out
altogether</li>
</ul>
<p>For example, in the filter <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">var|foo:&quot;bar&quot;</span> <span class="pre">}}</span></code>, the filter <code class="docutils literal notranslate"><span class="pre">foo</span></code> would be
passed the contents of the variable <code class="docutils literal notranslate"><span class="pre">var</span></code> and the argument <code class="docutils literal notranslate"><span class="pre">&quot;bar&quot;</span></code>.</p>
<p>Filter functions should always return something. They shouldn’t raise
exceptions, and they should fail silently. If there’s an error, they should
return either the original input or an empty string, whichever makes more sense.</p>
<p>Here’s an example filter definition:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cut</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="s2">&quot;Removes all values of arg from the given string&quot;</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>And here’s an example of how that filter would be used to cut spaces from a
variable’s value:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{{</span> <span class="n">somevariable</span><span class="o">|</span><span class="n">cut</span><span class="p">:</span><span class="s2">&quot; &quot;</span> <span class="p">}}</span>
</pre></div>
</div>
<p>Most filters don’t take arguments. In this case, just leave the argument out
of your function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">lower</span><span class="p">(</span><span class="n">value</span><span class="p">):</span> <span class="c1"># Only one argument.</span>
    <span class="s2">&quot;Converts a string into all lowercase&quot;</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</pre></div>
</div>
<p>When you’ve written your filter definition, you need to register it with your
<code class="docutils literal notranslate"><span class="pre">Library</span></code> instance, to make it available to Django’s template language:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">register</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;cut&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="p">)</span>
<span class="n">register</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Library.filter()</span></code> method takes two arguments:</p>
<ul class="simple">
<li>The name of the filter (a string)</li>
<li>The filter function itself</li>
</ul>
<p>If you’re using Python 2.4 or above, you can use <code class="docutils literal notranslate"><span class="pre">register.filter()</span></code> as a
decorator instead:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@register</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;cut&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cut</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="nd">@register</span><span class="o">.</span><span class="n">filter</span>
<span class="k">def</span> <span class="nf">lower</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</pre></div>
</div>
<p>If you leave off the <code class="docutils literal notranslate"><span class="pre">name</span></code> argument, as in the second example, Django
will use the function’s name as the filter name.</p>
<p>Here, then, is a complete template library example, supplying the <code class="docutils literal notranslate"><span class="pre">cut</span></code> filter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django</span> <span class="k">import</span> <span class="n">template</span>

<span class="n">register</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">Library</span><span class="p">()</span>

<span class="nd">@register</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;cut&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cut</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="writing-custom-template-tags">
<h3>Writing Custom Template Tags<a class="headerlink" href="#writing-custom-template-tags" title="Permalink to this headline">¶</a></h3>
<p>Tags are more complex than filters, because tags can do nearly anything.</p>
<p>Chapter 4 describes how the template system works in a two-step process:
compiling and rendering. To define a custom template tag, you need to tell
Django how to manage <em>both</em> of these steps when it gets to your tag.</p>
<p>When Django compiles a template, it splits the raw template text into
<em>nodes</em>. Each node is an instance of <code class="docutils literal notranslate"><span class="pre">django.template.Node</span></code> and has
a <code class="docutils literal notranslate"><span class="pre">render()</span></code> method. Thus, a compiled template is simply a list of <code class="docutils literal notranslate"><span class="pre">Node</span></code>
objects. For example, consider this template:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Hello, {{ person.name }}.

{% ifequal name.birthday today %}
    Happy birthday!
{% else %}
    Be sure to come back on your birthday
    for a splendid surprise message.
{% endifequal %}
</pre></div>
</div>
<p>In compiled template form, this template is represented as this list of
nodes:</p>
<ul class="simple">
<li>Text node: <code class="docutils literal notranslate"><span class="pre">&quot;Hello,</span> <span class="pre">&quot;</span></code></li>
<li>Variable node: <code class="docutils literal notranslate"><span class="pre">person.name</span></code></li>
<li>Text node: <code class="docutils literal notranslate"><span class="pre">&quot;.\n\n&quot;</span></code></li>
<li>IfEqual node: <code class="docutils literal notranslate"><span class="pre">name.birthday</span></code> and <code class="docutils literal notranslate"><span class="pre">today</span></code></li>
</ul>
<p>When you call <code class="docutils literal notranslate"><span class="pre">render()</span></code> on a compiled template, the template calls
<code class="docutils literal notranslate"><span class="pre">render()</span></code> on each <code class="docutils literal notranslate"><span class="pre">Node</span></code> in its node list, with the given context. The
results are all concatenated together to form the output of the template. Thus,
to define a custom template tag, you specify how the raw template tag is
converted into a <code class="docutils literal notranslate"><span class="pre">Node</span></code> (the compilation function) and what the node’s
<code class="docutils literal notranslate"><span class="pre">render()</span></code> method does.</p>
<p>In the sections that follow, we cover all the steps in writing a custom tag.</p>
</div>
<div class="section" id="writing-the-compilation-function">
<h3>Writing the Compilation Function<a class="headerlink" href="#writing-the-compilation-function" title="Permalink to this headline">¶</a></h3>
<p>For each template tag the parser encounters, it calls a Python function with
the tag contents and the parser object itself. This function is responsible for
returning a <code class="docutils literal notranslate"><span class="pre">Node</span></code> instance based on the contents of the tag.</p>
<p>For example, let’s write a template tag, <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">current_time</span> <span class="pre">%}</span></code>, that displays
the current date/time, formatted according to a parameter given in the tag, in
<code class="docutils literal notranslate"><span class="pre">strftime</span></code> syntax (see <code class="docutils literal notranslate"><span class="pre">http://www.djangoproject.com/r/python/strftime/</span></code>).
It’s a good idea to decide the tag syntax before anything else. In our case,
let’s say the tag should be used like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">The</span> <span class="n">time</span> <span class="ow">is</span> <span class="p">{</span><span class="o">%</span> <span class="n">current_time</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %I:%M %p&quot;</span> <span class="o">%</span><span class="p">}</span><span class="o">.&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Yes, this template tag is redundant–Django’s default <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">now</span> <span class="pre">%}</span></code> tag does
the same task with simpler syntax. This template tag is presented here just
for example purposes.</p>
</div>
<p>The parser for this function should grab the parameter and create a <code class="docutils literal notranslate"><span class="pre">Node</span></code>
object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django</span> <span class="k">import</span> <span class="n">template</span>

<span class="n">register</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">Library</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">do_current_time</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># split_contents() knows not to split quoted strings.</span>
        <span class="n">tag_name</span><span class="p">,</span> <span class="n">format_string</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">split_contents</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%r</span><span class="s1"> tag requires a single argument&#39;</span> <span class="o">%</span> <span class="n">token</span><span class="o">.</span><span class="n">split_contents</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">raise</span> <span class="n">template</span><span class="o">.</span><span class="n">TemplateSyntaxError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">CurrentTimeNode</span><span class="p">(</span><span class="n">format_string</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p>There’s a lot going here:</p>
<ul class="simple">
<li>Each template tag compilation function takes two arguments, <code class="docutils literal notranslate"><span class="pre">parser</span></code>
and <code class="docutils literal notranslate"><span class="pre">token</span></code>. <code class="docutils literal notranslate"><span class="pre">parser</span></code> is the template parser object. We don’t use it
in this example. <code class="docutils literal notranslate"><span class="pre">token</span></code> is the token currently being parsed by the
parser.</li>
<li><code class="docutils literal notranslate"><span class="pre">token.contents</span></code> is a string of the raw contents of the tag. In our
example, it’s <code class="docutils literal notranslate"><span class="pre">'current_time</span> <span class="pre">&quot;%Y-%m-%d</span> <span class="pre">%I:%M</span> <span class="pre">%p&quot;'</span></code>.</li>
<li>The <code class="docutils literal notranslate"><span class="pre">token.split_contents()</span></code> method separates the arguments on spaces
while keeping quoted strings together. Avoid using
<code class="docutils literal notranslate"><span class="pre">token.contents.split()</span></code> (which just uses Python’s standard
string-splitting semantics). It’s not as robust, as it naively splits on
<em>all</em> spaces, including those within quoted strings.</li>
<li>This function is responsible for raising
<code class="docutils literal notranslate"><span class="pre">django.template.TemplateSyntaxError</span></code>, with helpful messages, for any
syntax error.</li>
<li>Don’t hard-code the tag’s name in your error messages, because that
couples the tag’s name to your function. <code class="docutils literal notranslate"><span class="pre">token.split_contents()[0]</span></code>
will <em>always</em> be the name of your tag – even when the tag has no
arguments.</li>
<li>The function returns a <code class="docutils literal notranslate"><span class="pre">CurrentTimeNode</span></code> (which we’ll create shortly)
containing everything the node needs to know about this tag. In this
case, it just passes the argument <code class="docutils literal notranslate"><span class="pre">&quot;%Y-%m-%d</span> <span class="pre">%I:%M</span> <span class="pre">%p&quot;</span></code>. The
leading and trailing quotes from the template tag are removed with
<code class="docutils literal notranslate"><span class="pre">format_string[1:-1]</span></code>.</li>
<li>Template tag compilation functions <em>must</em> return a <code class="docutils literal notranslate"><span class="pre">Node</span></code> subclass;
any other return value is an error.</li>
</ul>
</div>
<div class="section" id="writing-the-template-node">
<h3>Writing the Template Node<a class="headerlink" href="#writing-the-template-node" title="Permalink to this headline">¶</a></h3>
<p>The second step in writing custom tags is to define a <code class="docutils literal notranslate"><span class="pre">Node</span></code> subclass that
has a <code class="docutils literal notranslate"><span class="pre">render()</span></code> method. Continuing the preceding example, we need to define
<code class="docutils literal notranslate"><span class="pre">CurrentTimeNode</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span>

<span class="k">class</span> <span class="nc">CurrentTimeNode</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format_string</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">format_string</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_string</span><span class="p">)</span>
</pre></div>
</div>
<p>These two functions (<code class="docutils literal notranslate"><span class="pre">__init__()</span></code> and <code class="docutils literal notranslate"><span class="pre">render()</span></code>) map directly to the two
steps in template processing (compilation and rendering). Thus, the
initialization function only needs to store the format string for later use,
and the <code class="docutils literal notranslate"><span class="pre">render()</span></code> function does the real work.</p>
<p>Like template filters, these rendering functions should fail silently instead
of raising errors. The only time that template tags are allowed to raise
errors is at compilation time.</p>
</div>
<div class="section" id="registering-the-tag">
<h3>Registering the Tag<a class="headerlink" href="#registering-the-tag" title="Permalink to this headline">¶</a></h3>
<p>Finally, you need to register the tag with your module’s <code class="docutils literal notranslate"><span class="pre">Library</span></code> instance.
Registering custom tags is very similar to registering custom filters (as
explained above). Just instantiate a <code class="docutils literal notranslate"><span class="pre">template.Library</span></code> instance and call
its <code class="docutils literal notranslate"><span class="pre">tag()</span></code> method. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">register</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="s1">&#39;current_time&#39;</span><span class="p">,</span> <span class="n">do_current_time</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">tag()</span></code> method takes two arguments:</p>
<ul class="simple">
<li>The name of the template tag (string).</li>
<li>The compilation function.</li>
</ul>
<p>As with filter registration, it is also possible to use <code class="docutils literal notranslate"><span class="pre">register.tag</span></code> as a
decorator in Python 2.4 and above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@register</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;current_time&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">do_current_time</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="c1"># ...</span>

<span class="nd">@register</span><span class="o">.</span><span class="n">tag</span>
<span class="k">def</span> <span class="nf">shout</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>If you leave off the <code class="docutils literal notranslate"><span class="pre">name</span></code> argument, as in the second example, Django
will use the function’s name as the tag name.</p>
</div>
<div class="section" id="setting-a-variable-in-the-context">
<h3>Setting a Variable in the Context<a class="headerlink" href="#setting-a-variable-in-the-context" title="Permalink to this headline">¶</a></h3>
<p>The previous section’s example simply returned a value. Often it’s useful to set
template variables instead of returning values. That way, template authors can
just use the variables that your template tags set.</p>
<p>To set a variable in the context, use dictionary assignment on the context
object in the <code class="docutils literal notranslate"><span class="pre">render()</span></code> method. Here’s an updated version of
<code class="docutils literal notranslate"><span class="pre">CurrentTimeNode</span></code> that sets a template variable, <code class="docutils literal notranslate"><span class="pre">current_time</span></code>, instead of
returning it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CurrentTimeNode2</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format_string</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">format_string</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;current_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_string</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
</pre></div>
</div>
<p>(We’ll leave the creation of a <code class="docutils literal notranslate"><span class="pre">do_current_time2</span></code> function, plus the
registration of that function to a <code class="docutils literal notranslate"><span class="pre">current_time2</span></code> template tag, as exercises
for the reader.)</p>
<p>Note that <code class="docutils literal notranslate"><span class="pre">render()</span></code> returns an empty string. <code class="docutils literal notranslate"><span class="pre">render()</span></code> should always
return a string, so if all the template tag does is set a variable,
<code class="docutils literal notranslate"><span class="pre">render()</span></code> should return an empty string.</p>
<p>Here’s how you’d use this new version of the tag:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="n">current_time2</span> <span class="s2">&quot;%Y-%M-</span><span class="si">%d</span><span class="s2"> %I:%M %p&quot;</span> <span class="o">%</span><span class="p">}</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">The</span> <span class="n">time</span> <span class="ow">is</span> <span class="p">{{</span> <span class="n">current_time</span> <span class="p">}}</span><span class="o">.&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>But there’s a problem with <code class="docutils literal notranslate"><span class="pre">CurrentTimeNode2</span></code>: the variable name
<code class="docutils literal notranslate"><span class="pre">current_time</span></code> is hard-coded. This means you’ll need to make sure your
template doesn’t use <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">current_time</span> <span class="pre">}}</span></code> anywhere else, because
<code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">current_time2</span> <span class="pre">%}</span></code> will blindly overwrite that variable’s value.</p>
<p>A cleaner solution is to make the template tag specify the name of the variable
to be set, like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="n">get_current_time</span> <span class="s2">&quot;%Y-%M-</span><span class="si">%d</span><span class="s2"> %I:%M %p&quot;</span> <span class="k">as</span> <span class="n">my_current_time</span> <span class="o">%</span><span class="p">}</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">The</span> <span class="n">current</span> <span class="n">time</span> <span class="ow">is</span> <span class="p">{{</span> <span class="n">my_current_time</span> <span class="p">}}</span><span class="o">.&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>To do so, you’ll need to refactor both the compilation function and the
<code class="docutils literal notranslate"><span class="pre">Node</span></code> class, as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>

<span class="k">class</span> <span class="nc">CurrentTimeNode3</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format_string</span><span class="p">,</span> <span class="n">var_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">format_string</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span> <span class="o">=</span> <span class="n">var_name</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">context</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_string</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

<span class="k">def</span> <span class="nf">do_current_time</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="c1"># This version uses a regular expression to parse tag contents.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Splitting by None == splitting by spaces.</span>
        <span class="n">tag_name</span><span class="p">,</span> <span class="n">arg</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%r</span><span class="s1"> tag requires arguments&#39;</span> <span class="o">%</span> <span class="n">token</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">raise</span> <span class="n">template</span><span class="o">.</span><span class="n">TemplateSyntaxError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(.*?) as (\w+)&#39;</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">fmt</span><span class="p">,</span> <span class="n">var_name</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%r</span><span class="s1"> tag had invalid arguments&#39;</span> <span class="o">%</span> <span class="n">tag_name</span>
        <span class="k">raise</span> <span class="n">template</span><span class="o">.</span><span class="n">TemplateSyntaxError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">fmt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> tag&#39;s argument should be in quotes&quot;</span> <span class="o">%</span> <span class="n">tag_name</span>
        <span class="k">raise</span> <span class="n">template</span><span class="o">.</span><span class="n">TemplateSyntaxError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">CurrentTimeNode3</span><span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">var_name</span><span class="p">)</span>
</pre></div>
</div>
<p>Now <code class="docutils literal notranslate"><span class="pre">do_current_time()</span></code> passes the format string and the variable name to
<code class="docutils literal notranslate"><span class="pre">CurrentTimeNode3</span></code>.</p>
</div>
<div class="section" id="parsing-until-another-template-tag">
<h3>Parsing Until Another Template Tag<a class="headerlink" href="#parsing-until-another-template-tag" title="Permalink to this headline">¶</a></h3>
<p>Template tags can work as blocks containing other tags (like <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">if</span> <span class="pre">%}</span></code>,
<code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">for</span> <span class="pre">%}</span></code>, etc.). To create a template tag like this, use
<code class="docutils literal notranslate"><span class="pre">parser.parse()</span></code> in your compilation function.</p>
<p>Here’s how the standard <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">comment</span> <span class="pre">%}</span></code> tag is implemented:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">do_comment</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="n">nodelist</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">((</span><span class="s1">&#39;endcomment&#39;</span><span class="p">,))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">delete_first_token</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">CommentNode</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">CommentNode</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">parser.parse()</span></code> takes a tuple of names of template tags to parse until. It
returns an instance of <code class="docutils literal notranslate"><span class="pre">django.template.NodeList</span></code>, which is a list of all
<code class="docutils literal notranslate"><span class="pre">Node</span></code> objects that the parser encountered <em>before</em> it encountered any of
the tags named in the tuple.</p>
<p>So in the preceding example, <code class="docutils literal notranslate"><span class="pre">nodelist</span></code> is a list of all nodes between
<code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">comment</span> <span class="pre">%}</span></code> and <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">endcomment</span> <span class="pre">%}</span></code>, not counting <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">comment</span> <span class="pre">%}</span></code> and
<code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">endcomment</span> <span class="pre">%}</span></code> themselves.</p>
<p>After <code class="docutils literal notranslate"><span class="pre">parser.parse()</span></code> is called, the parser hasn’t yet “consumed” the <code class="docutils literal notranslate"><span class="pre">{%</span>
<span class="pre">endcomment</span> <span class="pre">%}</span></code> tag, so the code needs to explicitly call
<code class="docutils literal notranslate"><span class="pre">parser.delete_first_token()</span></code> to prevent that tag from being processed
twice.</p>
<p>Then <code class="docutils literal notranslate"><span class="pre">CommentNode.render()</span></code> simply returns an empty string. Anything
between <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">comment</span> <span class="pre">%}</span></code> and <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">endcomment</span> <span class="pre">%}</span></code> is ignored.</p>
</div>
<div class="section" id="parsing-until-another-template-tag-and-saving-contents">
<h3>Parsing Until Another Template Tag and Saving Contents<a class="headerlink" href="#parsing-until-another-template-tag-and-saving-contents" title="Permalink to this headline">¶</a></h3>
<p>In the previous example, <code class="docutils literal notranslate"><span class="pre">do_comment()</span></code> discarded everything between
<code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">comment</span> <span class="pre">%}</span></code> and <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">endcomment</span> <span class="pre">%}</span></code>. It’s also
possible to do something with the code between template tags instead.</p>
<p>For example, here’s a custom template tag, <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">upper</span> <span class="pre">%}</span></code>, that capitalizes
everything between itself and <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">endupper</span> <span class="pre">%}</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="n">upper</span> <span class="o">%</span><span class="p">}</span>
    <span class="n">This</span> <span class="n">will</span> <span class="n">appear</span> <span class="ow">in</span> <span class="n">uppercase</span><span class="p">,</span> <span class="p">{{</span> <span class="n">user_name</span> <span class="p">}}</span><span class="o">.</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endupper</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
<p>As in the previous example, we’ll use <code class="docutils literal notranslate"><span class="pre">parser.parse()</span></code>. This time, we
pass the resulting <code class="docutils literal notranslate"><span class="pre">nodelist</span></code> to <code class="docutils literal notranslate"><span class="pre">Node</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">do_upper</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="n">nodelist</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">((</span><span class="s1">&#39;endupper&#39;</span><span class="p">,))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">delete_first_token</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">UpperNode</span><span class="p">(</span><span class="n">nodelist</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">UpperNode</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodelist</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodelist</span> <span class="o">=</span> <span class="n">nodelist</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</pre></div>
</div>
<p>The only new concept here is <code class="docutils literal notranslate"><span class="pre">self.nodelist.render(context)</span></code> in
<code class="docutils literal notranslate"><span class="pre">UpperNode.render()</span></code>. This simply calls <code class="docutils literal notranslate"><span class="pre">render()</span></code> on each <code class="docutils literal notranslate"><span class="pre">Node</span></code> in the
node list.</p>
<p>For more examples of complex rendering, see the source code for <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">if</span> <span class="pre">%}</span></code>,
<code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">for</span> <span class="pre">%}</span></code>, <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">ifequal</span> <span class="pre">%}</span></code>, and <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">ifchanged</span> <span class="pre">%}</span></code>. They live in
<code class="docutils literal notranslate"><span class="pre">django/template/defaulttags.py</span></code>.</p>
</div>
<div class="section" id="shortcut-for-simple-tags">
<h3>Shortcut for Simple Tags<a class="headerlink" href="#shortcut-for-simple-tags" title="Permalink to this headline">¶</a></h3>
<p>Many template tags take a single argument – a string or a template variable
reference – and return a string after doing some processing based solely on
the input argument and some external information. For example, the
<code class="docutils literal notranslate"><span class="pre">current_time</span></code> tag we wrote earlier is of this variety. We give it a format
string, and it returns the time as a string.</p>
<p>To ease the creation of these types of tags, Django provides a helper function,
<code class="docutils literal notranslate"><span class="pre">simple_tag</span></code>. This function, which is a method of <code class="docutils literal notranslate"><span class="pre">django.template.Library</span></code>,
takes a function that accepts one argument, wraps it in a <code class="docutils literal notranslate"><span class="pre">render</span></code> function
and the other necessary bits mentioned previously, and registers it with the
template system.</p>
<p>Our earlier <code class="docutils literal notranslate"><span class="pre">current_time</span></code> function could thus be written like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">current_time</span><span class="p">(</span><span class="n">format_string</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">format_string</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

<span class="n">register</span><span class="o">.</span><span class="n">simple_tag</span><span class="p">(</span><span class="n">current_time</span><span class="p">)</span>
</pre></div>
</div>
<p>In Python 2.4, the decorator syntax also works:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@register</span><span class="o">.</span><span class="n">simple_tag</span>
<span class="k">def</span> <span class="nf">current_time</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>Notice a couple of things to notice about the <code class="docutils literal notranslate"><span class="pre">simple_tag</span></code> helper function:</p>
<ul class="simple">
<li>Only the (single) argument is passed into our function.</li>
<li>Checking for the required number of arguments has already been
done by the time our function is called, so we don’t need to do that.</li>
<li>The quotes around the argument (if any) have already been stripped away,
so we receive a plain Unicode string.</li>
</ul>
</div>
<div class="section" id="inclusion-tags">
<h3>Inclusion Tags<a class="headerlink" href="#inclusion-tags" title="Permalink to this headline">¶</a></h3>
<p>Another common template tag is the type that displays some data by
rendering <em>another</em> template. For example, Django’s admin interface uses
custom template tags to display the buttons along the bottom of the
“add/change” form pages. Those buttons always look the same, but the link
targets change depending on the object being edited. They’re a perfect case
for using a small template that is filled with details from the current object.</p>
<p>These sorts of tags are called <em>inclusion tags</em>. Writing inclusion tags is
probably best demonstrated by example. Let’s write a tag that produces a list
of books for a given <code class="docutils literal notranslate"><span class="pre">Author</span></code> object. We’ll use the tag like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="n">books_for_author</span> <span class="n">author</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
<p>The result will be something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">ul</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;</span><span class="n">The</span> <span class="n">Cat</span> <span class="n">In</span> <span class="n">The</span> <span class="n">Hat</span><span class="o">&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;</span><span class="n">Hop</span> <span class="n">On</span> <span class="n">Pop</span><span class="o">&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;</span><span class="n">Green</span> <span class="n">Eggs</span> <span class="n">And</span> <span class="n">Ham</span><span class="o">&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">ul</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>First, we define the function that takes the argument and produces a
dictionary of data for the result. Notice that we need to return only a
dictionary, not anything more complex. This will be used as the context for
the template fragment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">books_for_author</span><span class="p">(</span><span class="n">author</span><span class="p">):</span>
    <span class="n">books</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">authors__id</span><span class="o">=</span><span class="n">author</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;books&#39;</span><span class="p">:</span> <span class="n">books</span><span class="p">}</span>
</pre></div>
</div>
<p>Next, we create the template used to render the tag’s output. Following our
example, the template is very simple:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">ul</span><span class="o">&gt;</span>
<span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">books</span> <span class="o">%</span><span class="p">}</span>
    <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">book</span><span class="o">.</span><span class="n">title</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
<span class="o">&lt;/</span><span class="n">ul</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Finally, we create and register the inclusion tag by calling the
<code class="docutils literal notranslate"><span class="pre">inclusion_tag()</span></code> method on a <code class="docutils literal notranslate"><span class="pre">Library</span></code> object.</p>
<p>Following our example, if the preceding template is in a file called
<code class="docutils literal notranslate"><span class="pre">book_snippet.html</span></code>, we register the tag like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">register</span><span class="o">.</span><span class="n">inclusion_tag</span><span class="p">(</span><span class="s1">&#39;book_snippet.html&#39;</span><span class="p">)(</span><span class="n">books_for_author</span><span class="p">)</span>
</pre></div>
</div>
<p>Python 2.4 decorator syntax works as well, so we could have written this,
instead:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@register</span><span class="o">.</span><span class="n">inclusion_tag</span><span class="p">(</span><span class="s1">&#39;book_snippet.html&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">books_for_author</span><span class="p">(</span><span class="n">author</span><span class="p">):</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>Sometimes, your inclusion tags need access to values from the parent template’s
context. To solve this, Django provides a <code class="docutils literal notranslate"><span class="pre">takes_context</span></code> option for
inclusion tags. If you specify <code class="docutils literal notranslate"><span class="pre">takes_context</span></code> in creating an inclusion tag,
the tag will have no required arguments, and the underlying Python function
will have one argument: the template context as of when the tag was called.</p>
<p>For example, say you’re writing an inclusion tag that will always be used in a
context that contains <code class="docutils literal notranslate"><span class="pre">home_link</span></code> and <code class="docutils literal notranslate"><span class="pre">home_title</span></code> variables that point
back to the main page. Here’s what the Python function would look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@register</span><span class="o">.</span><span class="n">inclusion_tag</span><span class="p">(</span><span class="s1">&#39;link.html&#39;</span><span class="p">,</span> <span class="n">takes_context</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">jump_link</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;link&#39;</span><span class="p">:</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;home_link&#39;</span><span class="p">],</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;home_title&#39;</span><span class="p">],</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>(Note that the first parameter to the function <em>must</em> be called <code class="docutils literal notranslate"><span class="pre">context</span></code>.)</p>
<p>The template <code class="docutils literal notranslate"><span class="pre">link.html</span></code> might contain the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Jump</span> <span class="n">directly</span> <span class="n">to</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;{{ link }}&quot;</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">title</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;.</span>
</pre></div>
</div>
<p>Then, anytime you want to use that custom tag, load its library and call it
without any arguments, like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="n">jump_link</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="writing-custom-template-loaders">
<h2>Writing Custom Template Loaders<a class="headerlink" href="#writing-custom-template-loaders" title="Permalink to this headline">¶</a></h2>
<p>Django’s built-in template loaders (described in the “Inside Template Loading”
section above) will usually cover all your template-loading needs, but it’s
pretty easy to write your own if you need special loading logic. For example,
you could load templates from a database, or directly from a Subversion
repository using Subversion’s Python bindings, or (as shown shortly) from a ZIP
archive.</p>
<p>A template loader – that is, each entry in the <code class="docutils literal notranslate"><span class="pre">TEMPLATE_LOADERS</span></code> setting
– is expected to be a callable object with this interface:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">load_template_source</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">template_dirs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">template_name</span></code> argument is the name of the template to load (as passed
to <code class="docutils literal notranslate"><span class="pre">loader.get_template()</span></code> or <code class="docutils literal notranslate"><span class="pre">loader.select_template()</span></code>), and
<code class="docutils literal notranslate"><span class="pre">template_dirs</span></code> is an optional list of directories to search instead of
<code class="docutils literal notranslate"><span class="pre">TEMPLATE_DIRS</span></code>.</p>
<p>If a loader is able to successfully load a template, it should return a tuple:
<code class="docutils literal notranslate"><span class="pre">(template_source,</span> <span class="pre">template_path)</span></code>. Here, <code class="docutils literal notranslate"><span class="pre">template_source</span></code> is the
template string that will be compiled by the template engine, and
<code class="docutils literal notranslate"><span class="pre">template_path</span></code> is the path the template was loaded from. That path might be
shown to the user for debugging purposes, so it should quickly identify where
the template was loaded from.</p>
<p>If the loader is unable to load a template, it should raise
<code class="docutils literal notranslate"><span class="pre">django.template.TemplateDoesNotExist</span></code>.</p>
<p>Each loader function should also have an <code class="docutils literal notranslate"><span class="pre">is_usable</span></code> function attribute.
This is a Boolean that informs the template engine whether this loader
is available in the current Python installation. For example, the eggs loader
(which is capable of loading templates from Python eggs) sets <code class="docutils literal notranslate"><span class="pre">is_usable</span></code>
to <code class="docutils literal notranslate"><span class="pre">False</span></code> if the <code class="docutils literal notranslate"><span class="pre">pkg_resources</span></code> module isn’t installed, because
<code class="docutils literal notranslate"><span class="pre">pkg_resources</span></code> is necessary to read data from eggs.</p>
<p>An example should help clarify all of this. Here’s a template loader function
that can load templates from a ZIP file. It uses a custom setting,
<code class="docutils literal notranslate"><span class="pre">TEMPLATE_ZIP_FILES</span></code>, as a search path instead of <code class="docutils literal notranslate"><span class="pre">TEMPLATE_DIRS</span></code>, and it
expects each item on that path to be a ZIP file containing templates:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf</span> <span class="k">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="k">import</span> <span class="n">TemplateDoesNotExist</span>
<span class="kn">import</span> <span class="nn">zipfile</span>

<span class="k">def</span> <span class="nf">load_template_source</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">template_dirs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="s2">&quot;Template loader that loads templates from a ZIP file.&quot;</span>

    <span class="n">template_zipfiles</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;TEMPLATE_ZIP_FILES&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="c1"># Try each ZIP file in TEMPLATE_ZIP_FILES.</span>
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">template_zipfiles</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">z</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># We found a template, so return the source.</span>
        <span class="n">template_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">template_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">template_path</span><span class="p">)</span>

    <span class="c1"># If we reach here, the template couldn&#39;t be loaded</span>
    <span class="k">raise</span> <span class="n">TemplateDoesNotExist</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span>

<span class="c1"># This loader is always usable (since zipfile is included with Python)</span>
<span class="n">load_template_source</span><span class="o">.</span><span class="n">is_usable</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>The only step left if we want to use this loader is to add it to the
<code class="docutils literal notranslate"><span class="pre">TEMPLATE_LOADERS</span></code> setting. If we put this code in a package called
<code class="docutils literal notranslate"><span class="pre">mysite.zip_loader</span></code>, then we add
<code class="docutils literal notranslate"><span class="pre">mysite.zip_loader.load_template_source</span></code> to <code class="docutils literal notranslate"><span class="pre">TEMPLATE_LOADERS</span></code>.</p>
</div>
<div class="section" id="configuring-the-template-system-in-standalone-mode">
<h2>Configuring the Template System in Standalone Mode<a class="headerlink" href="#configuring-the-template-system-in-standalone-mode" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This section is only of interest to people trying to use the template
system as an output component in another application. If you are using the
template system as part of a Django application, the information presented
here doesn’t apply to you.</p>
</div>
<p>Normally, Django loads all the configuration information it needs from its own
default configuration file, combined with the settings in the module given
in the <code class="docutils literal notranslate"><span class="pre">DJANGO_SETTINGS_MODULE</span></code> environment variable. (This was explained in
“A special Python prompt” in Chapter 4.) But if you’re using the template
system independently of the rest of Django, the environment variable approach
isn’t very convenient, because you probably want to configure the template
system in line with the rest of your application rather than dealing with
settings files and pointing to them via environment variables.</p>
<p>To solve this problem, you need to use the manual configuration option described
fully in Appendix D. In a nutshell, you need to import the appropriate pieces of
the template system and then, <em>before</em> you call any of the template functions,
call <code class="docutils literal notranslate"><span class="pre">django.conf.settings.configure()</span></code> with any settings you wish to specify.</p>
<p>You might want to consider setting at least <code class="docutils literal notranslate"><span class="pre">TEMPLATE_DIRS</span></code> (if you are
going to use template loaders), <code class="docutils literal notranslate"><span class="pre">DEFAULT_CHARSET</span></code> (although the default of
<code class="docutils literal notranslate"><span class="pre">utf-8</span></code> is probably fine) and <code class="docutils literal notranslate"><span class="pre">TEMPLATE_DEBUG</span></code>. All available settings are
described in Appendix D, and any setting starting with <code class="docutils literal notranslate"><span class="pre">TEMPLATE_</span></code> is of
obvious interest.</p>
</div>
<div class="section" id="what-s-next">
<h2>What’s Next<a class="headerlink" href="#what-s-next" title="Permalink to this headline">¶</a></h2>
<p>Continuing this section’s theme of advanced topics, the <a class="reference external" href="chapter10.html">next chapter</a> covers
advanced usage of Django models.</p>
</div>
</div>
</div>

          </div>
        </div>
      </div>
      <div id="ft">
        
<div class="nav">
    
        <a href='chapter08.html'>&laquo; previous</a> &loz;
    
    <a href="index.html">table of contents</a>
    
        &loz; <a href='chapter10.html'>next &raquo;</a>
    
</div>

        Copyright Adrian Holovaty, Jacob Kaplan-Moss, et al.<br>This
        work is licensed under the <a href="license.html">GNU Free Document
        License</a>.
      </div>
    </div>
  
  </body>
</html>