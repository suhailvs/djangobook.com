<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>Chapter 16: django.contrib</title>
    <link rel="stylesheet" href="static/reset-min.css" type="text/css">
    <link rel="stylesheet" href="static/grids-min.css" type="text/css">
    <link rel="stylesheet" href="static/djangobook.css" type="text/css">
    
  </head>
  <body>
    <div id="doc" class="yui-t7">
      <div id="hd">
        <h1><a href="index.html">The Django Book</a></h1>
        <div id="global-nav">
            <a class="about" href="frontmatter.html">About</a>
        </div>
        
<div class="nav">
    
        <a href='chapter15.html'>&laquo; previous</a> &loz;
    
    <a href="index.html">table of contents</a>
    
        &loz; <a href='chapter17.html'>next &raquo;</a>
    
</div>

      </div>
      <div id="bd">
        <div id="yui-main">
          <div class="yui-b">
            
  <div id="chapter-body"><div class="section" id="chapter-16-django-contrib">
<h1>Chapter 16: django.contrib<a class="headerlink" href="#chapter-16-django-contrib" title="Permalink to this headline">¶</a></h1>
<p>One of the many strengths of Python is its “batteries included” philosophy: when
you install Python, it comes with a large standard library of packages that you
can start using immediately, without having to download anything else. Django
aims to follow this philosophy, and it includes its own standard library of
add-ons useful for common Web development tasks. This chapter covers that
collection of add-ons.</p>
<div class="section" id="the-django-standard-library">
<h2>The Django Standard Library<a class="headerlink" href="#the-django-standard-library" title="Permalink to this headline">¶</a></h2>
<p>Django’s standard library lives in the package <code class="docutils literal"><span class="pre">django.contrib</span></code>. Within each
subpackage is a separate piece of add-on functionality. These pieces are not
necessarily related, but some <code class="docutils literal"><span class="pre">django.contrib</span></code> subpackages may require other
ones.</p>
<p>There’s no hard requirement for the types of functionality in
<code class="docutils literal"><span class="pre">django.contrib</span></code>. Some of the packages include models (and hence require you
to install their database tables into your database), but others consist solely
of middleware or template tags.</p>
<p>The single characteristic the <code class="docutils literal"><span class="pre">django.contrib</span></code> packages have in common is
this: if you were to remove the <code class="docutils literal"><span class="pre">django.contrib</span></code> package entirely, you could
still use Django’s fundamental features with no problems. When the Django
developers add new functionality to the framework, they use this rule of thumb
in deciding whether the new functionality should live in <code class="docutils literal"><span class="pre">django.contrib</span></code> or
elsewhere.</p>
<p><code class="docutils literal"><span class="pre">django.contrib</span></code> consists of these packages:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">admin</span></code>: The Django admin site. See Chapter 6.</li>
<li><code class="docutils literal"><span class="pre">admindocs</span></code>: Auto-documentation for the Django admin site. This book
doesn’t cover this feature; check the official Django documentation.</li>
<li><code class="docutils literal"><span class="pre">auth</span></code>: Django’s authentication framework. See Chapter 14.</li>
<li><code class="docutils literal"><span class="pre">comments</span></code>: A comments application. This book doesn’t cover this
feature; check the official Django documentation.</li>
<li><code class="docutils literal"><span class="pre">contenttypes</span></code>: A framework for hooking into “types” of content, where
each installed Django model is a separate content type. This framework is
used internally by other “contrib” applications and is mostly intended for very
advanced Django developers. Those developers should find out more about
this application by reading the source code in <code class="docutils literal"><span class="pre">django/contrib/contenttypes</span></code>.</li>
<li><code class="docutils literal"><span class="pre">csrf</span></code>: Protection against Cross-Site Request Forgery (CSRF). See
the later section titled “CSRF Protection.”</li>
<li><code class="docutils literal"><span class="pre">databrowse</span></code>: A Django application that lets you browse your data. This
book doesn’t cover this feature; check the official Django documentation.</li>
<li><code class="docutils literal"><span class="pre">flatpages</span></code>: A framework for managing simple “flat” HTML content in a
database. See the later section titled “Flatpages.”</li>
<li><code class="docutils literal"><span class="pre">formtools</span></code>: A number of useful higher-level libraries for dealing with
common patterns in forms. This book doesn’t cover this feature; check the
official Django documentation.</li>
<li><code class="docutils literal"><span class="pre">gis</span></code>: Extensions to Django that provide for GIS (Geographic
Information Systems) support. These, for example, allow your Django
models to store geographic data and perform geographic queries. This is
a large, complex library and isn’t covered in this book. See
<a class="reference external" href="http://geodjango.org/">http://geodjango.org/</a> for documentation.</li>
<li><code class="docutils literal"><span class="pre">humanize</span></code>: A set of Django template filters useful for adding a
“human touch” to data. See the later section titled “Humanizing Data.”</li>
<li><code class="docutils literal"><span class="pre">localflavor</span></code>: Assorted pieces of code that are useful for particular
countries or cultures. For example, this includes ways to validate U.S.
ZIP codes or Icelandic identification numbers.</li>
<li><code class="docutils literal"><span class="pre">markup</span></code>: A set of Django template filters that implement a number of
common markup languages. See the later section titled “Markup Filters.”</li>
<li><code class="docutils literal"><span class="pre">redirects</span></code>: A framework for managing redirects. See the later section titled
“Redirects.”</li>
<li><code class="docutils literal"><span class="pre">sessions</span></code>: Django’s session framework. See Chapter 14.</li>
<li><code class="docutils literal"><span class="pre">sitemaps</span></code>: A framework for generating sitemap XML files. See Chapter 13.</li>
<li><code class="docutils literal"><span class="pre">sites</span></code>: A framework that lets you operate multiple Web sites from the
same database and Django installation. See the next section, “Sites.”</li>
<li><code class="docutils literal"><span class="pre">syndication</span></code>: A framework for generating syndication feeds in RSS and
Atom. See Chapter 13.</li>
<li><code class="docutils literal"><span class="pre">webdesign</span></code>: Django add-ons that are particularly useful to Web
<em>designers</em> (as opposed to developers). As of this writing, this included
only a single template tag, <code class="docutils literal"><span class="pre">{%</span> <span class="pre">lorem</span> <span class="pre">%}</span></code>. Check the Django
documentation for information.</li>
</ul>
<p>The rest of this chapter goes into detail a number of <code class="docutils literal"><span class="pre">django.contrib</span></code>
packages that we haven’t yet covered in this book.</p>
</div>
<div class="section" id="sites">
<h2>Sites<a class="headerlink" href="#sites" title="Permalink to this headline">¶</a></h2>
<p>Django’s sites system is a generic framework that lets you operate multiple
Web sites from the same database and Django project. This is an abstract
concept, and it can be tricky to understand, so we’ll start with a couple of
scenarios where it would be useful.</p>
<div class="section" id="scenario-1-reusing-data-on-multiple-sites">
<h3>Scenario 1: Reusing Data on Multiple Sites<a class="headerlink" href="#scenario-1-reusing-data-on-multiple-sites" title="Permalink to this headline">¶</a></h3>
<p>As we explained in Chapter 1, the Django-powered sites LJWorld.com and
Lawrence.com are operated by the same news organization: the <em>Lawrence
Journal-World</em> newspaper in Lawrence, Kansas. LJWorld.com focuses on news, while
Lawrence.com focuses on local entertainment. But sometimes editors want to
publish an article on <em>both</em> sites.</p>
<p>The brain-dead way of solving the problem would be to use a separate database
for each site and to require site producers to publish the same story twice:
once for LJWorld.com and again for Lawrence.com. But that’s inefficient for
site producers, and it’s redundant to store multiple copies of the same story
in the database.</p>
<p>The better solution? Both sites use the same article database, and an article
is associated with one or more sites via a many-to-many relationship. The
Django sites framework provides the database table to which articles can be
related. It’s a hook for associating data with one or more “sites.”</p>
</div>
<div class="section" id="scenario-2-storing-your-site-name-domain-in-one-place">
<h3>Scenario 2: Storing Your Site Name/Domain in One Place<a class="headerlink" href="#scenario-2-storing-your-site-name-domain-in-one-place" title="Permalink to this headline">¶</a></h3>
<p>LJWorld.com and Lawrence.com both have e-mail alert functionality, which lets
readers sign up to get notifications when news happens. It’s pretty basic: a
reader signs up on a Web form, and he immediately gets an e-mail saying,
“Thanks for your subscription.”</p>
<p>It would be inefficient and redundant to implement this signup-processing code
twice, so the sites use the same code behind the scenes. But the “Thank you for
your subscription” notice needs to be different for each site. By using <code class="docutils literal"><span class="pre">Site</span></code>
objects, we can abstract the thank-you notice to use the values of the
current site’s <code class="docutils literal"><span class="pre">name</span></code> (e.g., <code class="docutils literal"><span class="pre">'LJWorld.com'</span></code>) and <code class="docutils literal"><span class="pre">domain</span></code> (e.g.,
<code class="docutils literal"><span class="pre">'www.ljworld.com'</span></code>).</p>
<p>The Django sites framework provides a place for you to store the <code class="docutils literal"><span class="pre">name</span></code> and
<code class="docutils literal"><span class="pre">domain</span></code> for each site in your Django project, which means you can reuse
those values in a generic way.</p>
<p>In Django 1.5, to protect from host poisoning attacks, your domains must be
added in <code class="docutils literal"><span class="pre">ALLOWED_HOSTS</span></code> in settings.py as shown below</p>
<blockquote>
<div>ALLOWED_HOSTS = []</div></blockquote>
</div>
<div class="section" id="how-to-use-the-sites-framework">
<h3>How to Use the Sites Framework<a class="headerlink" href="#how-to-use-the-sites-framework" title="Permalink to this headline">¶</a></h3>
<p>The sites framework is more a series of conventions than a framework. The
whole thing is based on two simple concepts:</p>
<ul class="simple">
<li>The <code class="docutils literal"><span class="pre">Site</span></code> model, found in <code class="docutils literal"><span class="pre">django.contrib.sites</span></code>, has <code class="docutils literal"><span class="pre">domain</span></code> and
<code class="docutils literal"><span class="pre">name</span></code> fields.</li>
<li>The <code class="docutils literal"><span class="pre">SITE_ID</span></code> setting specifies the database ID of the <code class="docutils literal"><span class="pre">Site</span></code> object
associated with that particular settings file.</li>
</ul>
<p>How you use these two concepts is up to you, but Django uses them in a couple
of ways automatically via simple conventions.</p>
<p>To install the sites application, follow these steps:</p>
<ol class="arabic simple">
<li>Add <code class="docutils literal"><span class="pre">'django.contrib.sites'</span></code> to your <code class="docutils literal"><span class="pre">INSTALLED_APPS</span></code>.</li>
<li>Run the command <code class="docutils literal"><span class="pre">manage.py</span> <span class="pre">syncdb</span></code> to install the <code class="docutils literal"><span class="pre">django_site</span></code>
table into your database. This will also create a default site object,
with the domain <code class="docutils literal"><span class="pre">example.com</span></code>.</li>
<li>Change the <code class="docutils literal"><span class="pre">example.com</span></code> site to your own domain, and add any other
<code class="docutils literal"><span class="pre">Site</span></code> objects, either through the Django admin site or via the Python
API. Create a <code class="docutils literal"><span class="pre">Site</span></code> object for each site/domain that this Django
project powers.</li>
<li>Define the <code class="docutils literal"><span class="pre">SITE_ID</span></code> setting in each of your settings files. This
value should be the database ID of the <code class="docutils literal"><span class="pre">Site</span></code> object for the site
powered by that settings file.</li>
</ol>
</div>
<div class="section" id="the-sites-framework-s-capabilities">
<h3>The Sites Framework’s Capabilities<a class="headerlink" href="#the-sites-framework-s-capabilities" title="Permalink to this headline">¶</a></h3>
<p>The sections that follow describe the various things you can do with the sites
framework.</p>
<div class="section" id="reusing-data-on-multiple-sites">
<h4>Reusing Data on Multiple Sites<a class="headerlink" href="#reusing-data-on-multiple-sites" title="Permalink to this headline">¶</a></h4>
<p>To reuse data on multiple sites, as explained in the first scenario, just create
a <code class="docutils literal"><span class="pre">ManyToManyField</span></code> to <code class="docutils literal"><span class="pre">Site</span></code> in your models, for example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.contrib.sites.models</span> <span class="k">import</span> <span class="n">Site</span>

<span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">headline</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="c1"># ...</span>
    <span class="n">sites</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">Site</span><span class="p">)</span>
</pre></div>
</div>
<p>That’s the infrastructure you need to associate articles with multiple sites in
your database. With that in place, you can reuse the same Django view code for
multiple sites. Continuing the <code class="docutils literal"><span class="pre">Article</span></code> model example, here’s what an
<code class="docutils literal"><span class="pre">article_detail</span></code> view might look like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf</span> <span class="k">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="k">import</span> <span class="n">get_object_or_404</span>
<span class="kn">from</span> <span class="nn">mysite.articles.models</span> <span class="k">import</span> <span class="n">Article</span>

<span class="k">def</span> <span class="nf">article_detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Article</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">,</span> <span class="n">sites__id</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">SITE_ID</span><span class="p">)</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>This view function is reusable because it checks the article’s site
dynamically, according to the value of the <code class="docutils literal"><span class="pre">SITE_ID</span></code> setting.</p>
<p>For example, say LJWorld.com’s settings file has a <code class="docutils literal"><span class="pre">SITE_ID</span></code> set to <code class="docutils literal"><span class="pre">1</span></code>, and
Lawrence.com’s settings file has a <code class="docutils literal"><span class="pre">SITE_ID</span></code> set to <code class="docutils literal"><span class="pre">2</span></code>. If this view is
called when LJWorld.com’s settings file is active, then it will limit the
article lookup to articles in which the list of sites includes LJWorld.com.</p>
</div>
<div class="section" id="associating-content-with-a-single-site">
<h4>Associating Content with a Single Site<a class="headerlink" href="#associating-content-with-a-single-site" title="Permalink to this headline">¶</a></h4>
<p>Similarly, you can associate a model to the <code class="docutils literal"><span class="pre">Site</span></code> model in a many-to-one
relationship using <code class="docutils literal"><span class="pre">ForeignKey</span></code>.</p>
<p>For example, if each article is associated with only a single site, you could
use a model like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.contrib.sites.models</span> <span class="k">import</span> <span class="n">Site</span>

<span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">headline</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="c1"># ...</span>
    <span class="n">site</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Site</span><span class="p">)</span>
</pre></div>
</div>
<p>This has the same benefits as described in the last section.</p>
</div>
<div class="section" id="hooking-into-the-current-site-from-views">
<h4>Hooking Into the Current Site from Views<a class="headerlink" href="#hooking-into-the-current-site-from-views" title="Permalink to this headline">¶</a></h4>
<p>On a lower level, you can use the sites framework in your Django views to do
particular things based on the site in which the view is being called,
for example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf</span> <span class="k">import</span> <span class="n">settings</span>

<span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">SITE_ID</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># Do something.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Do something else.</span>
</pre></div>
</div>
<p>Of course, it’s ugly to hard-code the site IDs like that. A slightly cleaner way
of accomplishing the same thing is to check the current site’s domain:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf</span> <span class="k">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib.sites.models</span> <span class="k">import</span> <span class="n">Site</span>

<span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">current_site</span> <span class="o">=</span> <span class="n">Site</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">SITE_ID</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">current_site</span><span class="o">.</span><span class="n">domain</span> <span class="o">==</span> <span class="s1">&#39;foo.com&#39;</span><span class="p">:</span>
        <span class="c1"># Do something</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Do something else.</span>
</pre></div>
</div>
<p>The idiom of retrieving the <code class="docutils literal"><span class="pre">Site</span></code> object for the value of
<code class="docutils literal"><span class="pre">settings.SITE_ID</span></code> is quite common, so the <code class="docutils literal"><span class="pre">Site</span></code> model’s manager
(<code class="docutils literal"><span class="pre">Site.objects</span></code>) has a <code class="docutils literal"><span class="pre">get_current()</span></code> method. This example is equivalent to
the previous one:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.sites.models</span> <span class="k">import</span> <span class="n">Site</span>

<span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">current_site</span> <span class="o">=</span> <span class="n">Site</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_current</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">current_site</span><span class="o">.</span><span class="n">domain</span> <span class="o">==</span> <span class="s1">&#39;foo.com&#39;</span><span class="p">:</span>
        <span class="c1"># Do something</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Do something else.</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In this final example, you don’t have to import <code class="docutils literal"><span class="pre">django.conf.settings</span></code>.</p>
</div>
</div>
<div class="section" id="getting-the-current-domain-for-display">
<h4>Getting the Current Domain for Display<a class="headerlink" href="#getting-the-current-domain-for-display" title="Permalink to this headline">¶</a></h4>
<p>For a DRY (Don’t Repeat Yourself) approach to storing your site’s name and
domain name, as explained in
“Scenario 2: Storing Your Site Name/Domain in One Place,” just reference the
<code class="docutils literal"><span class="pre">name</span></code> and <code class="docutils literal"><span class="pre">domain</span></code> of the current <code class="docutils literal"><span class="pre">Site</span></code> object. For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.sites.models</span> <span class="k">import</span> <span class="n">Site</span>
<span class="kn">from</span> <span class="nn">django.core.mail</span> <span class="k">import</span> <span class="n">send_mail</span>

<span class="k">def</span> <span class="nf">register_for_newsletter</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># Check form values, etc., and subscribe the user.</span>
    <span class="c1"># ...</span>
    <span class="n">current_site</span> <span class="o">=</span> <span class="n">Site</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_current</span><span class="p">()</span>
    <span class="n">send_mail</span><span class="p">(</span><span class="s1">&#39;Thanks for subscribing to </span><span class="si">%s</span><span class="s1"> alerts&#39;</span> <span class="o">%</span> <span class="n">current_site</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;Thanks for your subscription. We appreciate it.</span><span class="se">\n\n</span><span class="s1">-The </span><span class="si">%s</span><span class="s1"> team.&#39;</span> <span class="o">%</span> <span class="n">current_site</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;editor@</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">current_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
        <span class="p">[</span><span class="n">user_email</span><span class="p">])</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>Continuing our ongoing example of LJWorld.com and Lawrence.com, on Lawrence.com
this e-mail has the subject line “Thanks for subscribing to lawrence.com
alerts.” On LJWorld.com, the e-mail has the subject line “Thanks for subscribing to
LJWorld.com alerts.” This same site-specific behavior is applied to the e-mails’
message body.</p>
<p>An even more flexible (but more heavyweight) way of doing this would be to use
Django’s template system. Assuming Lawrence.com and LJWorld.com have different
template directories (<code class="docutils literal"><span class="pre">TEMPLATE_DIRS</span></code>), you could simply delegate to the
template system like so:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.core.mail</span> <span class="k">import</span> <span class="n">send_mail</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="k">import</span> <span class="n">loader</span><span class="p">,</span> <span class="n">Context</span>

<span class="k">def</span> <span class="nf">register_for_newsletter</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># Check form values, etc., and subscribe the user.</span>
    <span class="c1"># ...</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s1">&#39;alerts/subject.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">Context</span><span class="p">({}))</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s1">&#39;alerts/message.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">Context</span><span class="p">({}))</span>
    <span class="n">send_mail</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="s1">&#39;do-not-reply@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">user_email</span><span class="p">])</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>In this case, you have to create <code class="docutils literal"><span class="pre">subject.txt</span></code> and <code class="docutils literal"><span class="pre">message.txt</span></code>
templates in both the LJWorld.com and Lawrence.com template directories.
As mentioned previously, that gives you more flexibility, but it’s also
more complex.</p>
<p>It’s a good idea to exploit the <code class="docutils literal"><span class="pre">Site</span></code> objects as much as possible to remove
unneeded complexity and redundancy.</p>
</div>
</div>
<div class="section" id="currentsitemanager">
<h3>CurrentSiteManager<a class="headerlink" href="#currentsitemanager" title="Permalink to this headline">¶</a></h3>
<p>If <code class="docutils literal"><span class="pre">Site</span></code> objects play a key role in your application, consider using the
<code class="docutils literal"><span class="pre">CurrentSiteManager</span></code> in your model(s). It’s a model manager (see Chapter 10)
that automatically filters its queries to include only objects associated with
the current <code class="docutils literal"><span class="pre">Site</span></code>.</p>
<p>Use <code class="docutils literal"><span class="pre">CurrentSiteManager</span></code> by adding it to your model explicitly. For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.contrib.sites.models</span> <span class="k">import</span> <span class="n">Site</span>
<span class="kn">from</span> <span class="nn">django.contrib.sites.managers</span> <span class="k">import</span> <span class="n">CurrentSiteManager</span>

<span class="k">class</span> <span class="nc">Photo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">photo</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FileField</span><span class="p">(</span><span class="n">upload_to</span><span class="o">=</span><span class="s1">&#39;/home/photos&#39;</span><span class="p">)</span>
    <span class="n">photographer_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">()</span>
    <span class="n">site</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Site</span><span class="p">)</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
    <span class="n">on_site</span> <span class="o">=</span> <span class="n">CurrentSiteManager</span><span class="p">()</span>
</pre></div>
</div>
<p>With this model, <code class="docutils literal"><span class="pre">Photo.objects.all()</span></code> will return all <code class="docutils literal"><span class="pre">Photo</span></code> objects in
the database, but <code class="docutils literal"><span class="pre">Photo.on_site.all()</span></code> will return only the <code class="docutils literal"><span class="pre">Photo</span></code>
objects associated with the current site, according to the <code class="docutils literal"><span class="pre">SITE_ID</span></code> setting.</p>
<p>In other words, these two statements are equivalent:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Photo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">SITE_ID</span><span class="p">)</span>
<span class="n">Photo</span><span class="o">.</span><span class="n">on_site</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>
</div>
<p>How did <code class="docutils literal"><span class="pre">CurrentSiteManager</span></code> know which field of <code class="docutils literal"><span class="pre">Photo</span></code> was the <code class="docutils literal"><span class="pre">Site</span></code>?
It defaults to looking for a field called <code class="docutils literal"><span class="pre">site</span></code>. If your model has a
<code class="docutils literal"><span class="pre">ForeignKey</span></code> or <code class="docutils literal"><span class="pre">ManyToManyField</span></code> called something <em>other</em> than <code class="docutils literal"><span class="pre">site</span></code>,
you need to explicitly pass that as the parameter to <code class="docutils literal"><span class="pre">CurrentSiteManager</span></code>.
The following model, which has a field called <code class="docutils literal"><span class="pre">publish_on</span></code>, demonstrates
this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.contrib.sites.models</span> <span class="k">import</span> <span class="n">Site</span>
<span class="kn">from</span> <span class="nn">django.contrib.sites.managers</span> <span class="k">import</span> <span class="n">CurrentSiteManager</span>

<span class="k">class</span> <span class="nc">Photo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">photo</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FileField</span><span class="p">(</span><span class="n">upload_to</span><span class="o">=</span><span class="s1">&#39;/home/photos&#39;</span><span class="p">)</span>
    <span class="n">photographer_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">()</span>
    <span class="n">publish_on</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Site</span><span class="p">)</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
    <span class="n">on_site</span> <span class="o">=</span> <span class="n">CurrentSiteManager</span><span class="p">(</span><span class="s1">&#39;publish_on&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>If you attempt to use <code class="docutils literal"><span class="pre">CurrentSiteManager</span></code> and pass a field name that doesn’t
exist, Django will raise a <code class="docutils literal"><span class="pre">ValueError</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>You’ll probably want to keep a normal (non-site-specific) <code class="docutils literal"><span class="pre">Manager</span></code> on
your model, even if you use <code class="docutils literal"><span class="pre">CurrentSiteManager</span></code>. As explained in Appendix
B, if you define a manager manually, then Django won’t create the automatic
<code class="docutils literal"><span class="pre">objects</span> <span class="pre">=</span> <span class="pre">models.Manager()</span></code> manager for you.</p>
<p class="last">Also, certain parts of Django – namely, the Django admin site and generic
views – use whichever manager is defined <em>first</em> in the model, so if you
want your admin site to have access to all objects (not just site-specific
ones), put <code class="docutils literal"><span class="pre">objects</span> <span class="pre">=</span> <span class="pre">models.Manager()</span></code> in your model, before you define
<code class="docutils literal"><span class="pre">CurrentSiteManager</span></code>.</p>
</div>
</div>
<div class="section" id="how-django-uses-the-sites-framework">
<h3>How Django Uses the Sites Framework<a class="headerlink" href="#how-django-uses-the-sites-framework" title="Permalink to this headline">¶</a></h3>
<p>Although it’s not required that you use the sites framework, it’s encouraged,
because Django takes advantage of it in a few places. Even if your
Django installation is powering only a single site, you should take a few
seconds to create the site object with your <code class="docutils literal"><span class="pre">domain</span></code> and <code class="docutils literal"><span class="pre">name</span></code>, and point
to its ID in your <code class="docutils literal"><span class="pre">SITE_ID</span></code> setting.</p>
<p>Here’s how Django uses the sites framework:</p>
<ul class="simple">
<li>In the redirects framework (see the later section “Redirects”), each
redirect object is associated with a particular site. When Django searches
for a redirect, it takes into account the current <code class="docutils literal"><span class="pre">SITE_ID</span></code>.</li>
<li>In the comments framework, each comment is associated with a particular
site. When a comment is posted, its <code class="docutils literal"><span class="pre">site</span></code> is set to the current
<code class="docutils literal"><span class="pre">SITE_ID</span></code>, and when comments are listed via the appropriate template
tag, only the comments for the current site are displayed.</li>
<li>In the flatpages framework (see the later section “Flatpages”), each
flatpage is associated with a particular site. When a flatpage is created,
you specify its <code class="docutils literal"><span class="pre">site</span></code>, and the flatpage middleware checks the current
<code class="docutils literal"><span class="pre">SITE_ID</span></code> in retrieving flatpages to display.</li>
<li>In the syndication framework (see Chapter 13), the templates for
<code class="docutils literal"><span class="pre">title</span></code> and <code class="docutils literal"><span class="pre">description</span></code> automatically have access to a variable
<code class="docutils literal"><span class="pre">{{</span> <span class="pre">site</span> <span class="pre">}}</span></code>, which is the <code class="docutils literal"><span class="pre">Site</span></code> object representing the current
site. Also, the hook for providing item URLs will use the
<code class="docutils literal"><span class="pre">domain</span></code> from the current <code class="docutils literal"><span class="pre">Site</span></code> object if you don’t specify a
fully qualified domain.</li>
<li>In the authentication framework (see Chapter 14), the
<code class="docutils literal"><span class="pre">django.contrib.auth.views.login</span></code> view passes the current <code class="docutils literal"><span class="pre">Site</span></code> name
to the template as <code class="docutils literal"><span class="pre">{{</span> <span class="pre">site_name</span> <span class="pre">}}</span></code> and the current <code class="docutils literal"><span class="pre">Site</span></code> object as
<code class="docutils literal"><span class="pre">{{</span> <span class="pre">site</span> <span class="pre">}}</span></code>.</li>
</ul>
</div>
</div>
<div class="section" id="flatpages">
<h2>Flatpages<a class="headerlink" href="#flatpages" title="Permalink to this headline">¶</a></h2>
<p>Often you’ll have a database-driven Web application up and running, but you’ll
need to add a couple of one-off static pages, such as an About page or a
Privacy Policy page. It would be possible to use a standard Web server such as
Apache to serve these files as flat HTML files, but that introduces an extra
level of complexity into your application, because then you have to worry about
configuring Apache, you have to set up access for your team to edit those
files, and you can’t take advantage of Django’s template system to style the
pages.</p>
<p>The solution to this problem is Django’s flatpages application, which lives in the
package <code class="docutils literal"><span class="pre">django.contrib.flatpages</span></code>. This application lets you manage such one-off
pages via Django’s admin site, and it lets you specify templates for them using
Django’s template system. It uses Django models behind the scenes, which means
it stores the pages in a database, just like the rest of your data, and you can
access flatpages with the standard Django database API.</p>
<p>Flatpages are keyed by their URL and site. When you create a flatpage, you
specify which URL it’s associated with, along with which site(s) it’s on. (For
more on sites, see the “Sites” section.)</p>
<div class="section" id="using-flatpages">
<h3>Using Flatpages<a class="headerlink" href="#using-flatpages" title="Permalink to this headline">¶</a></h3>
<p>To install the flatpages application, follow these steps:</p>
<ol class="arabic simple">
<li>Add <code class="docutils literal"><span class="pre">'django.contrib.flatpages'</span></code> to your <code class="docutils literal"><span class="pre">INSTALLED_APPS</span></code>.
<code class="docutils literal"><span class="pre">django.contrib.flatpages</span></code> depends on <code class="docutils literal"><span class="pre">django.contrib.sites</span></code>, so make
sure the both packages are in <code class="docutils literal"><span class="pre">INSTALLED_APPS</span></code>.</li>
<li>Add <code class="docutils literal"><span class="pre">'django.contrib.flatpages.middleware.FlatpageFallbackMiddleware'</span></code>
to your <code class="docutils literal"><span class="pre">MIDDLEWARE_CLASSES</span></code> setting.</li>
<li>Run the command <code class="docutils literal"><span class="pre">manage.py</span> <span class="pre">syncdb</span></code> to install the two required tables
into your database.</li>
</ol>
<p>The flatpages application creates two tables in your database: <code class="docutils literal"><span class="pre">django_flatpage</span></code>
and <code class="docutils literal"><span class="pre">django_flatpage_sites</span></code>. <code class="docutils literal"><span class="pre">django_flatpage</span></code> simply maps a URL to a title
and bunch of text content. <code class="docutils literal"><span class="pre">django_flatpage_sites</span></code> is a many-to-many table
that associates a flatpage with one or more sites.</p>
<p>The application comes with a single <code class="docutils literal"><span class="pre">FlatPage</span></code> model, defined in
<code class="docutils literal"><span class="pre">django/contrib/flatpages/models.py</span></code>. It looks something like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.contrib.sites.models</span> <span class="k">import</span> <span class="n">Site</span>

<span class="k">class</span> <span class="nc">FlatPage</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">enable_comments</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">()</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">registration_required</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">()</span>
    <span class="n">sites</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">Site</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s examine these fields one at a time:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">url</span></code>: The URL at which this flatpage lives, excluding the domain
name but including the leading slash (e.g., <code class="docutils literal"><span class="pre">/about/contact/</span></code>).</li>
<li><code class="docutils literal"><span class="pre">title</span></code>: The title of the flatpage. The framework doesn’t do anything
special with this. It’s your responsibility to display it in your
template.</li>
<li><code class="docutils literal"><span class="pre">content</span></code>: The content of the flatpage (i.e., the HTML of the page).
The framework doesn’t do anything special with this. It’s your
responsibility to display it in the template.</li>
<li><code class="docutils literal"><span class="pre">enable_comments</span></code>: Whether to enable comments on this flatpage. The
framework doesn’t do anything special with this. You can check this value
in your template and display a comment form if needed.</li>
<li><code class="docutils literal"><span class="pre">template_name</span></code>: The name of the template to use for rendering this
flatpage. This is optional; if it’s not given or if this template doesn’t
exist, the framework will fall back to the template
<code class="docutils literal"><span class="pre">flatpages/default.html</span></code>.</li>
<li><code class="docutils literal"><span class="pre">registration_required</span></code>: Whether registration is required for viewing
this flatpage. This integrates with Django’s authentication/user
framework, which is explained further in Chapter 14.</li>
<li><code class="docutils literal"><span class="pre">sites</span></code>: The sites that this flatpage lives on. This integrates with
Django’s sites framework, which is explained in the “Sites” section of
this chapter.</li>
</ul>
<p>You can create flatpages through either the Django admin interface or the
Django database API. For more information on this, see the section
“Adding, Changing, and Deleting Flatpages.”</p>
<p>Once you’ve created flatpages, <code class="docutils literal"><span class="pre">FlatpageFallbackMiddleware</span></code> does all of
the work. Each time any Django application raises a 404 error, this middleware
checks the flatpages database for the requested URL as a last resort.
Specifically, it checks for a flatpage with the given URL with a site ID that
corresponds to the <code class="docutils literal"><span class="pre">SITE_ID</span></code> setting.</p>
<p>If it finds a match, it loads the flatpage’s template or
<code class="docutils literal"><span class="pre">flatpages/default.html</span></code> if the flatpage has not specified a custom template.
It passes that template a single context variable, <code class="docutils literal"><span class="pre">flatpage</span></code>, which is the
<code class="docutils literal"><span class="pre">FlatPage</span></code> object. It uses <code class="docutils literal"><span class="pre">RequestContext</span></code> in rendering the template.</p>
<p>If <code class="docutils literal"><span class="pre">FlatpageFallbackMiddleware</span></code> doesn’t find a match, the request continues
to be processed as usual.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This middleware only gets activated for 404 (page not found) errors – not
for 500 (server error) or other error responses. Also note that the order of
<code class="docutils literal"><span class="pre">MIDDLEWARE_CLASSES</span></code> matters. Generally, you can put
<code class="docutils literal"><span class="pre">FlatpageFallbackMiddleware</span></code> at or near the end of the list, because it’s
a last resort.</p>
</div>
</div>
<div class="section" id="adding-changing-and-deleting-flatpages">
<h3>Adding, Changing, and Deleting Flatpages<a class="headerlink" href="#adding-changing-and-deleting-flatpages" title="Permalink to this headline">¶</a></h3>
<p>You can add, change and delete flatpages in two ways:</p>
<div class="section" id="via-the-admin-interface">
<h4>Via the Admin Interface<a class="headerlink" href="#via-the-admin-interface" title="Permalink to this headline">¶</a></h4>
<p>If you’ve activated the automatic Django admin interface, you should see a
“Flatpages” section on the admin index page. Edit flatpages as you would edit any
other object in the system.</p>
</div>
<div class="section" id="via-the-python-api">
<h4>Via the Python API<a class="headerlink" href="#via-the-python-api" title="Permalink to this headline">¶</a></h4>
<p>As described previously, flatpages are represented by a standard Django model that
lives in <code class="docutils literal"><span class="pre">django/contrib/flatpages/models.py</span></code>. Hence, you can access flatpage
objects via the Django database API, for example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">django.contrib.flatpages.models</span> <span class="k">import</span> <span class="n">FlatPage</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">django.contrib.sites.models</span> <span class="k">import</span> <span class="n">Site</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fp</span> <span class="o">=</span> <span class="n">FlatPage</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">url</span><span class="o">=</span><span class="s1">&#39;/about/&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;About&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">content</span><span class="o">=</span><span class="s1">&#39;&lt;p&gt;About this site...&lt;/p&gt;&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">enable_comments</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">template_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">registration_required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fp</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Site</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">FlatPage</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s1">&#39;/about/&#39;</span><span class="p">)</span>
<span class="go">&lt;FlatPage: /about/ -- About&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="using-flatpage-templates">
<h3>Using Flatpage Templates<a class="headerlink" href="#using-flatpage-templates" title="Permalink to this headline">¶</a></h3>
<p>By default, flatpages are rendered via the template <code class="docutils literal"><span class="pre">flatpages/default.html</span></code>,
but you can override that for a particular flatpage with the <code class="docutils literal"><span class="pre">template_name</span></code>
field on the <code class="docutils literal"><span class="pre">FlatPage</span></code> object.</p>
<p>Creating the <code class="docutils literal"><span class="pre">flatpages/default.html</span></code> template is your responsibility. In
your template directory, just create a <code class="docutils literal"><span class="pre">flatpages</span></code> directory containing a
<code class="docutils literal"><span class="pre">default.html</span></code> file.</p>
<p>Flatpage templates are passed a single context variable, <code class="docutils literal"><span class="pre">flatpage</span></code>, which is
the flatpage object.</p>
<p>Here’s a sample <code class="docutils literal"><span class="pre">flatpages/default.html</span></code> template:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot;
    &quot;http://www.w3.org/TR/REC-html40/loose.dtd&quot;&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;{{ flatpage.title }}&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
{{ flatpage.content|safe }}
&lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
<p>Note that we’ve used the <code class="docutils literal"><span class="pre">safe</span></code> template filter to allow <code class="docutils literal"><span class="pre">flatpage.content</span></code>
to include raw HTML and bypass auto-escaping.</p>
</div>
</div>
<div class="section" id="redirects">
<h2>Redirects<a class="headerlink" href="#redirects" title="Permalink to this headline">¶</a></h2>
<p>Django’s redirects framework lets you manage redirects easily by storing them in
a database and treating them as any other Django model object. For example, you
can use the redirects framework to tell Django, “Redirect any request to
<code class="docutils literal"><span class="pre">/music/</span></code> to <code class="docutils literal"><span class="pre">/sections/arts/music/</span></code>.” This comes in handy when you need to
move things around on your site; Web developers should do whatever is necessary
to avoid broken links.</p>
<div class="section" id="using-the-redirects-framework">
<h3>Using the Redirects Framework<a class="headerlink" href="#using-the-redirects-framework" title="Permalink to this headline">¶</a></h3>
<p>To install the redirects application, follow these steps:</p>
<ol class="arabic simple">
<li>Add <code class="docutils literal"><span class="pre">'django.contrib.redirects'</span></code> to your <code class="docutils literal"><span class="pre">INSTALLED_APPS</span></code>.</li>
<li>Add <code class="docutils literal"><span class="pre">'django.contrib.redirects.middleware.RedirectFallbackMiddleware'</span></code>
to your <code class="docutils literal"><span class="pre">MIDDLEWARE_CLASSES</span></code> setting.</li>
<li>Run the command <code class="docutils literal"><span class="pre">manage.py</span> <span class="pre">syncdb</span></code> to install the single required
table into your database.</li>
</ol>
<p><code class="docutils literal"><span class="pre">manage.py</span> <span class="pre">syncdb</span></code> creates a <code class="docutils literal"><span class="pre">django_redirect</span></code> table in your database. This
is a simple lookup table with <code class="docutils literal"><span class="pre">site_id</span></code>, <code class="docutils literal"><span class="pre">old_path</span></code>, and <code class="docutils literal"><span class="pre">new_path</span></code> fields.</p>
<p>You can create redirects through either the Django admin interface or the Django
database API. For more, see the section “Adding, Changing, and Deleting
Redirects.”</p>
<p>Once you’ve created redirects, the <code class="docutils literal"><span class="pre">RedirectFallbackMiddleware</span></code> class does all
of the work. Each time any Django application raises a 404 error, this
middleware checks the redirects database for the requested URL as a last resort.
Specifically, it checks for a redirect with the given <code class="docutils literal"><span class="pre">old_path</span></code> with a site
ID that corresponds to the <code class="docutils literal"><span class="pre">SITE_ID</span></code> setting. (See the earlier section “Sites”
for more information on <code class="docutils literal"><span class="pre">SITE_ID</span></code> and the sites framework.) Then it follows these steps:</p>
<ul class="simple">
<li>If it finds a match, and <code class="docutils literal"><span class="pre">new_path</span></code> is not empty, it redirects to
<code class="docutils literal"><span class="pre">new_path</span></code>.</li>
<li>If it finds a match, and <code class="docutils literal"><span class="pre">new_path</span></code> is empty, it sends a 410 (“Gone”)
HTTP header and an empty (contentless) response.</li>
<li>If it doesn’t find a match, the request continues to be processed as
usual.</li>
</ul>
<p>The middleware only gets activated for 404 errors – not for 500 errors or responses of any
other status code.</p>
<p>Note that the order of <code class="docutils literal"><span class="pre">MIDDLEWARE_CLASSES</span></code> matters. Generally, you can put
<code class="docutils literal"><span class="pre">RedirectFallbackMiddleware</span></code> toward the end of the list, because it’s a last
resort.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you’re using both the redirect and flatpage fallback middleware, consider
which one (redirect or flatpage) you’d like checked first. We
suggest flatpages before redirects (thus putting
the flatpage middleware before the redirect middleware), but you might feel
differently.</p>
</div>
</div>
<div class="section" id="adding-changing-and-deleting-redirects">
<h3>Adding, Changing, and Deleting Redirects<a class="headerlink" href="#adding-changing-and-deleting-redirects" title="Permalink to this headline">¶</a></h3>
<p>You can add, change and delete redirects in two ways:</p>
<div class="section" id="id1">
<h4>Via the Admin Interface<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>If you’ve activated the automatic Django admin interface, you should see a
“Redirects” section on the admin index page. Edit redirects as you would edit any
other object in the system.</p>
</div>
<div class="section" id="id2">
<h4>Via the Python API<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>Redirects are represented by a standard Django model that lives in
<code class="docutils literal"><span class="pre">django/contrib/redirects/models.py</span></code>. Hence, you can access redirect objects
via the Django database API, for example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">django.contrib.redirects.models</span> <span class="k">import</span> <span class="n">Redirect</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">django.contrib.sites.models</span> <span class="k">import</span> <span class="n">Site</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">red</span> <span class="o">=</span> <span class="n">Redirect</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">site</span><span class="o">=</span><span class="n">Site</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">old_path</span><span class="o">=</span><span class="s1">&#39;/music/&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">new_path</span><span class="o">=</span><span class="s1">&#39;/sections/arts/music/&#39;</span><span class="p">,</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Redirect</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">old_path</span><span class="o">=</span><span class="s1">&#39;/music/&#39;</span><span class="p">)</span>
<span class="go">&lt;Redirect: /music/ ---&gt; /sections/arts/music/&gt;</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="csrf-protection">
<h2>CSRF Protection<a class="headerlink" href="#csrf-protection" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">django.contrib.csrf</span></code> package protects against
Cross-Site Request Forgery (CSRF).</p>
<p>CSRF, also known as “session riding,” is a Web site security exploit. It
happens when a malicious Web site tricks a user into unknowingly loading a URL
from a site at which that user is already authenticated, hence taking advantage
of the user’s authenticated status. This can be a bit tricky to understand at first,
so we walk through two examples in this section.</p>
<div class="section" id="a-simple-csrf-example">
<h3>A Simple CSRF Example<a class="headerlink" href="#a-simple-csrf-example" title="Permalink to this headline">¶</a></h3>
<p>Suppose you’re logged in to a webmail account at <code class="docutils literal"><span class="pre">example.com</span></code>. This webmail
site has a Log Out button that points to the URL <code class="docutils literal"><span class="pre">example.com/logout</span></code> –
that is, the only action you need to take in order to log out is to visit the
page <code class="docutils literal"><span class="pre">example.com/logout</span></code>.</p>
<p>A malicious site can coerce you to visit the URL <code class="docutils literal"><span class="pre">example.com/logout</span></code> by
including that URL as a hidden <code class="docutils literal"><span class="pre">&lt;iframe&gt;</span></code> on its own (malicious) page. Thus,
if you’re logged in to the <code class="docutils literal"><span class="pre">example.com</span></code> webmail account and visit the
malicious page that has an <code class="docutils literal"><span class="pre">&lt;iframe&gt;</span></code> to <code class="docutils literal"><span class="pre">example.com/logout</span></code>, the act of
visiting the malicious page will log you out from <code class="docutils literal"><span class="pre">example.com</span></code>.</p>
<p>Clearly, being logged out of a webmail site against your will is not a
terrifying breach of security, but this same type of exploit can happen to
<em>any</em> site that trusts users, such as an online banking site or an e-commerce
site, where the exploit could be used to initiate an order or payment without
the user’s knowledge.</p>
</div>
<div class="section" id="a-more-complex-csrf-example">
<h3>A More Complex CSRF Example<a class="headerlink" href="#a-more-complex-csrf-example" title="Permalink to this headline">¶</a></h3>
<p>In the previous example, <code class="docutils literal"><span class="pre">example.com</span></code> was partially at fault because it allowed
a state change (i.e., logging the user out) to be requested via the HTTP
<code class="docutils literal"><span class="pre">GET</span></code> method. It’s much better practice to require an HTTP <code class="docutils literal"><span class="pre">POST</span></code> for any
request that changes state on the server. But even Web sites that require
<code class="docutils literal"><span class="pre">POST</span></code> for state-changing actions are vulnerable to CSRF.</p>
<p>Suppose <code class="docutils literal"><span class="pre">example.com</span></code> has upgraded its Log Out functionality so that it’s a
<code class="docutils literal"><span class="pre">&lt;form&gt;</span></code> button that is requested via <code class="docutils literal"><span class="pre">POST</span></code> to the URL
<code class="docutils literal"><span class="pre">example.com/logout</span></code>. Furthermore, the logout <code class="docutils literal"><span class="pre">&lt;form&gt;</span></code> includes this
hidden field:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;hidden&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;confirm&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>This ensures that a simple <code class="docutils literal"><span class="pre">POST</span></code> to the URL <code class="docutils literal"><span class="pre">example.com/logout</span></code> won’t
log a user out; in order for a user to log out, the user must request
<code class="docutils literal"><span class="pre">example.com/logout</span></code> via <code class="docutils literal"><span class="pre">POST</span></code> <em>and</em> send the <code class="docutils literal"><span class="pre">confirm</span></code> <code class="docutils literal"><span class="pre">POST</span></code>
variable with a value of <code class="docutils literal"><span class="pre">'true'</span></code>.</p>
<p>Well, despite the extra security, this arrangement can still be exploited by
CSRF – the malicious page just needs to do a little more work. Attackers can
create an entire form targeting your site, hide it in an invisible <code class="docutils literal"><span class="pre">&lt;iframe&gt;</span></code>,
and then use JavaScript to submit that form automatically.</p>
</div>
<div class="section" id="preventing-csrf">
<h3>Preventing CSRF<a class="headerlink" href="#preventing-csrf" title="Permalink to this headline">¶</a></h3>
<p>How, then, can your site protect itself from this exploit? The first step is
to make sure all <code class="docutils literal"><span class="pre">GET</span></code> requests are free of side effects. That way,
if a malicious site includes one of your pages as an <code class="docutils literal"><span class="pre">&lt;iframe&gt;</span></code>,
it won’t have a negative effect.</p>
<p>That leaves <code class="docutils literal"><span class="pre">POST</span></code> requests. The second step is to give each <code class="docutils literal"><span class="pre">POST</span></code>
<code class="docutils literal"><span class="pre">&lt;form&gt;</span></code> a hidden field whose value is secret and is generated from the
user’s session ID. Then, when processing the form on the server side, check for
that secret field and raise an error if it doesn’t validate.</p>
<p>This is exactly what Django’s CSRF prevention layer does, as explained in the
sections that follow.</p>
<div class="section" id="using-the-csrf-middleware">
<h4>Using the CSRF Middleware<a class="headerlink" href="#using-the-csrf-middleware" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal"><span class="pre">django.contrib.csrf</span></code> package contains only one module: <code class="docutils literal"><span class="pre">middleware.py</span></code>. This
module contains a Django middleware class, <code class="docutils literal"><span class="pre">CsrfMiddleware</span></code>, which implements
the CSRF protection.</p>
<p>To activate this CSRF protection, add <code class="docutils literal"><span class="pre">'django.contrib.csrf.middleware.CsrfMiddleware'</span></code>
to the <code class="docutils literal"><span class="pre">MIDDLEWARE_CLASSES</span></code> setting in your settings file. This middleware
needs to process the response <em>after</em> <code class="docutils literal"><span class="pre">SessionMiddleware</span></code>, so
<code class="docutils literal"><span class="pre">CsrfMiddleware</span></code> must appear <em>before</em> <code class="docutils literal"><span class="pre">SessionMiddleware</span></code> in the list
(because the response middleware is processed last-to-first). Also, it must
process the response before the response gets compressed or otherwise mangled,
so <code class="docutils literal"><span class="pre">CsrfMiddleware</span></code> must come after <code class="docutils literal"><span class="pre">GZipMiddleware</span></code>. Once you’ve added
that to your <code class="docutils literal"><span class="pre">MIDDLEWARE_CLASSES</span></code> setting, you’re done.  See the section
“Order of MIDDLEWARE_CLASSES” in Chapter 15 for more explanation.</p>
<p>In case you’re interested, here’s how <code class="docutils literal"><span class="pre">CsrfMiddleware</span></code> works. It does these
two things:</p>
<ol class="arabic simple">
<li>It modifies outgoing requests by adding a hidden form field to all
<code class="docutils literal"><span class="pre">POST</span></code> forms, with the name <code class="docutils literal"><span class="pre">csrfmiddlewaretoken</span></code> and a value that
is a hash of the session ID plus a secret key. The middleware does <em>not</em>
modify the response if there’s no session ID set, so the performance
penalty is negligible for requests that don’t use sessions.</li>
<li>On all incoming <code class="docutils literal"><span class="pre">POST</span></code> requests that have the session cookie set, it
checks that <code class="docutils literal"><span class="pre">csrfmiddlewaretoken</span></code> is present and correct. If it
isn’t, the user will get a 403 <code class="docutils literal"><span class="pre">HTTP</span></code> error. The content of the 403
error page is the message “Cross Site Request Forgery detected. Request
aborted.”</li>
</ol>
<p>This ensures that only forms originating from your Web site can be used to POST
data back.</p>
<p>This middleware deliberately targets only HTTP <code class="docutils literal"><span class="pre">POST</span></code> requests (and the
corresponding POST forms). As we explained, <code class="docutils literal"><span class="pre">GET</span></code> requests ought never
to have side effects; it’s your own responsibility to ensure this.</p>
<p><code class="docutils literal"><span class="pre">POST</span></code> requests not accompanied by a session cookie are not
protected, but they don’t <em>need</em> to be protected, because a malicious Web site
could make these kind of requests anyway.</p>
<p>To avoid altering non-HTML requests, the middleware checks the response’s
<code class="docutils literal"><span class="pre">Content-Type</span></code> header before modifying it. Only pages that are served as
<code class="docutils literal"><span class="pre">text/html</span></code> or <code class="docutils literal"><span class="pre">application/xml+xhtml</span></code> are modified.</p>
</div>
<div class="section" id="limitations-of-the-csrf-middleware">
<h4>Limitations of the CSRF Middleware<a class="headerlink" href="#limitations-of-the-csrf-middleware" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">CsrfMiddleware</span></code> requires Django’s session framework to work. (See Chapter 14
for more on sessions.) If you’re using a custom session or authentication
framework that manually manages session cookies, this middleware will not help
you.</p>
<p>If your application creates HTML pages and forms in some unusual way (e.g., if it
sends fragments of HTML in JavaScript <code class="docutils literal"><span class="pre">document.write</span></code> statements), you
might bypass the filter that adds the hidden field to the form. In this case,
the form submission will always fail. (This happens because
<code class="docutils literal"><span class="pre">CsrfMiddleware</span></code> uses a regular expression to add the <code class="docutils literal"><span class="pre">csrfmiddlewaretoken</span></code>
field to your HTML before the page is sent to the client, and the regular
expression sometimes cannot handle wacky HTML.) If you suspect this might be
happening, just view the source in your Web browser to see whether
<code class="docutils literal"><span class="pre">csrfmiddlewaretoken</span></code> was inserted into your <code class="docutils literal"><span class="pre">&lt;form&gt;</span></code>.</p>
<p>For more CSRF information and examples, visit <a class="reference external" href="http://en.wikipedia.org/wiki/CSRF">http://en.wikipedia.org/wiki/CSRF</a></p>
</div>
</div>
</div>
<div class="section" id="humanizing-data">
<h2>Humanizing Data<a class="headerlink" href="#humanizing-data" title="Permalink to this headline">¶</a></h2>
<p>The package <code class="docutils literal"><span class="pre">django.contrib.humanize</span></code> holds a set of Django template filters
useful for adding a “human touch” to data. To activate these filters, add
<code class="docutils literal"><span class="pre">'django.contrib.humanize'</span></code> to your <code class="docutils literal"><span class="pre">INSTALLED_APPS</span></code>. Once you’ve done
that, use <code class="docutils literal"><span class="pre">{%</span> <span class="pre">load</span> <span class="pre">humanize</span> <span class="pre">%}</span></code> in a template, and you’ll have access to the
filters described in the following sections.</p>
<div class="section" id="apnumber">
<h3>apnumber<a class="headerlink" href="#apnumber" title="Permalink to this headline">¶</a></h3>
<p>For numbers 1 through 9, this filter returns the number spelled out. Otherwise,
it returns the numeral. This follows Associated Press style.</p>
<p>Examples:</p>
<ul class="simple">
<li>1 becomes “one”.</li>
<li>2 becomes “two”.</li>
<li>10 becomes “10”.</li>
</ul>
<p>You can pass in either an integer or a string representation of an integer.</p>
</div>
<div class="section" id="intcomma">
<h3>intcomma<a class="headerlink" href="#intcomma" title="Permalink to this headline">¶</a></h3>
<p>This filter converts an integer to a string containing commas every three digits.</p>
<p>Examples:</p>
<ul class="simple">
<li>4500 becomes “4,500”.</li>
<li>45000 becomes “45,000”.</li>
<li>450000 becomes “450,000”.</li>
<li>4500000 becomes “4,500,000”.</li>
</ul>
<p>You can pass in either an integer or a string representation of an integer.</p>
</div>
<div class="section" id="intword">
<h3>intword<a class="headerlink" href="#intword" title="Permalink to this headline">¶</a></h3>
<p>This filter converts a large integer to a friendly text representation. It works best for
numbers over 1 million.</p>
<p>Examples:</p>
<ul class="simple">
<li>1000000 becomes “1.0 million”.</li>
<li>1200000 becomes “1.2 million”.</li>
<li>1200000000 becomes “1.2 billion”.</li>
</ul>
<p>Values up to 1 quadrillion (1,000,000,000,000,000) are supported.</p>
<p>You can pass in either an integer or a string representation of an integer.</p>
</div>
<div class="section" id="ordinal">
<h3>ordinal<a class="headerlink" href="#ordinal" title="Permalink to this headline">¶</a></h3>
<p>This filter converts an integer to its ordinal as a string.</p>
<p>Examples:</p>
<ul class="simple">
<li>1 becomes “1st”.</li>
<li>2 becomes “2nd”.</li>
<li>3 becomes “3rd”.</li>
<li>254 becomes “254th”.</li>
</ul>
<p>You can pass in either an integer or a string representation of an integer.</p>
</div>
</div>
<div class="section" id="markup-filters">
<h2>Markup Filters<a class="headerlink" href="#markup-filters" title="Permalink to this headline">¶</a></h2>
<p>The package <code class="docutils literal"><span class="pre">django.contrib.markup</span></code> includes a handful of Django template
filters, each of which implements a common markup languages:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">textile</span></code>: Implements Textile
(<a class="reference external" href="http://en.wikipedia.org/wiki/Textile_%28markup_language%29">http://en.wikipedia.org/wiki/Textile_%28markup_language%29</a>)</li>
<li><code class="docutils literal"><span class="pre">markdown</span></code>: Implements Markdown (<a class="reference external" href="http://en.wikipedia.org/wiki/Markdown">http://en.wikipedia.org/wiki/Markdown</a>)</li>
<li><code class="docutils literal"><span class="pre">restructuredtext</span></code>: Implements ReStructured Text
(<a class="reference external" href="http://en.wikipedia.org/wiki/ReStructuredText">http://en.wikipedia.org/wiki/ReStructuredText</a>)</li>
</ul>
<p>In each case, the filter expects formatted markup as a string and returns a
string representing the marked-up text. For example, the <code class="docutils literal"><span class="pre">textile</span></code> filter converts
text that is marked up in Textile format to HTML:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="n">load</span> <span class="n">markup</span> <span class="o">%</span><span class="p">}</span>
<span class="p">{{</span> <span class="nb">object</span><span class="o">.</span><span class="n">content</span><span class="o">|</span><span class="n">textile</span> <span class="p">}}</span>
</pre></div>
</div>
<p>To activate these filters, add <code class="docutils literal"><span class="pre">'django.contrib.markup'</span></code> to your
<code class="docutils literal"><span class="pre">INSTALLED_APPS</span></code> setting. Once you’ve done that, use <code class="docutils literal"><span class="pre">{%</span> <span class="pre">load</span> <span class="pre">markup</span> <span class="pre">%}</span></code> in
a template, and you’ll have access to these filters. For more documentation,
read the source code in <code class="docutils literal"><span class="pre">django/contrib/markup/templatetags/markup.py.</span></code></p>
</div>
<div class="section" id="what-s-next">
<h2>What’s Next?<a class="headerlink" href="#what-s-next" title="Permalink to this headline">¶</a></h2>
<p>Many of these contributed frameworks (CSRF, the auth system, etc.) do their
magic by providing a piece of <em>middleware</em>. Middleware is code that runs before
and/or after every request and can modify requests and responses at will, to
extend the framework. In the <a class="reference external" href="chapter17.html">next chapter</a>, we’ll discuss Django’s built-in
middleware and explain how you can write your own.</p>
</div>
</div>
</div>

          </div>
        </div>
      </div>
      <div id="ft">
        
<div class="nav">
    
        <a href='chapter15.html'>&laquo; previous</a> &loz;
    
    <a href="index.html">table of contents</a>
    
        &loz; <a href='chapter17.html'>next &raquo;</a>
    
</div>

        Copyright Adrian Holovaty, Jacob Kaplan-Moss, et al.<br>This
        work is licensed under the <a href="license.html">GNU Free Document
        License</a>.
      </div>
    </div>
  
  </body>
</html>