<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>Chapter 14: Sessions, Users, and Registration</title>
    <link rel="stylesheet" href="_static/reset-min.css" type="text/css">
    <link rel="stylesheet" href="_static/grids-min.css" type="text/css">
    <link rel="stylesheet" href="_static/djangobook.css" type="text/css">
    
  </head>
  <body>
    <div id="doc" class="yui-t7">
      <div id="hd">
        <h1><a href="index.html">The Django Book</a></h1>
        <div id="global-nav">
            <a class="about" href="frontmatter.html">About</a>
        </div>
        
<div class="nav">
    
        <a href='chapter13.html'>&laquo; previous</a> &loz;
    
    <a href="index.html">table of contents</a>
    
        &loz; <a href='chapter15.html'>next &raquo;</a>
    
</div>

      </div>
      <div id="bd">
        <div id="yui-main">
          <div class="yui-b">
            
  <div id="chapter-body"><div class="section" id="chapter-14-sessions-users-and-registration">
<h1>Chapter 14: Sessions, Users, and Registration<a class="headerlink" href="#chapter-14-sessions-users-and-registration" title="Permalink to this headline">¶</a></h1>
<p>It’s time for a confession: we’ve been deliberately ignoring an important
aspect of Web development prior to this point. So far, we’ve thought of the
traffic visiting our sites as some faceless, anonymous mass hurtling itself
against our carefully designed pages.</p>
<p>This isn’t true, of course. The browsers hitting our sites have real humans
behind them (most of the time, at least). That’s a big thing to ignore: the
Internet is at its best when it serves to connect <em>people</em>, not machines. If
we’re going to develop truly compelling sites, eventually we’re going to have
to deal with the bodies behind the browsers.</p>
<p>Unfortunately, it’s not all that easy. HTTP is designed to be <em>stateless</em>–
that is, each and every request happens in a vacuum. There’s no persistence
between one request and the next, and we can’t count on any aspects of a
request (IP address, user agent, etc.) to consistently indicate successive
requests from the same person.</p>
<p>In this chapter you’ll learn how to handle this lack of state. We’ll start at
the lowest level (<em>cookies</em>), and work up to the high-level tools for handling
sessions, users and registration.</p>
<div class="section" id="cookies">
<h2>Cookies<a class="headerlink" href="#cookies" title="Permalink to this headline">¶</a></h2>
<p>Browser developers long ago recognized that HTTP’s statelessness poses a huge
problem for Web developers, and thus <em>cookies</em> were born. A cookie is a
small piece of information that browsers store on behalf of Web servers. Every
time a browser requests a page from a certain server, it gives back the cookie
that it initially received.</p>
<p>Let’s take a look how this might work. When you open your browser and type in
<code class="docutils literal"><span class="pre">google.com</span></code>, your browser sends an HTTP request to Google that starts
something like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="n">Host</span><span class="p">:</span> <span class="n">google</span><span class="o">.</span><span class="n">com</span>
<span class="o">...</span>
</pre></div>
</div>
<p>When Google replies, the HTTP response looks something like the following:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span>
<span class="n">Set</span><span class="o">-</span><span class="n">Cookie</span><span class="p">:</span> <span class="n">PREF</span><span class="o">=</span><span class="n">ID</span><span class="o">=</span><span class="mi">5</span><span class="n">b14f22bdaf1e81c</span><span class="p">:</span><span class="n">TM</span><span class="o">=</span><span class="mi">1167000671</span><span class="p">:</span><span class="n">LM</span><span class="o">=</span><span class="mi">1167000671</span><span class="p">;</span>
            <span class="n">expires</span><span class="o">=</span><span class="n">Sun</span><span class="p">,</span> <span class="mi">17</span><span class="o">-</span><span class="n">Jan</span><span class="o">-</span><span class="mi">2038</span> <span class="mi">19</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">07</span> <span class="n">GMT</span><span class="p">;</span>
            <span class="n">path</span><span class="o">=/</span><span class="p">;</span> <span class="n">domain</span><span class="o">=.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span>
<span class="n">Server</span><span class="p">:</span> <span class="n">GWS</span><span class="o">/</span><span class="mf">2.1</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Notice the <code class="docutils literal"><span class="pre">Set-Cookie</span></code> header. Your browser will store that cookie value
(<code class="docutils literal"><span class="pre">PREF=ID=5b14f22bdaf1e81c:TM=1167000671:LM=1167000671</span></code>) and serve it back
to Google every time you access the site. So the next time you access Google,
your browser is going to send a request like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="n">Host</span><span class="p">:</span> <span class="n">google</span><span class="o">.</span><span class="n">com</span>
<span class="n">Cookie</span><span class="p">:</span> <span class="n">PREF</span><span class="o">=</span><span class="n">ID</span><span class="o">=</span><span class="mi">5</span><span class="n">b14f22bdaf1e81c</span><span class="p">:</span><span class="n">TM</span><span class="o">=</span><span class="mi">1167000671</span><span class="p">:</span><span class="n">LM</span><span class="o">=</span><span class="mi">1167000671</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Google then can use that <code class="docutils literal"><span class="pre">Cookie</span></code> value to know that you’re the same person
who accessed the site earlier. This value might, for example, be a key into a
database that stores user information. Google could (and does) use it to
display your account’s username on the page.</p>
<div class="section" id="getting-and-setting-cookies">
<h3>Getting and Setting Cookies<a class="headerlink" href="#getting-and-setting-cookies" title="Permalink to this headline">¶</a></h3>
<p>When dealing with persistence in Django, most of the time you’ll want to use the
higher-level session and/or user frameworks discussed a little later in this
chapter. However, first look at how to read and write cookies at a low
level. This should help you understand how the rest of the tools discussed in
the chapter actually work, and it will come in handy if you ever need to play
with cookies directly.</p>
<p>Reading cookies that are already set is simple. Every <code class="docutils literal"><span class="pre">HttpRequest</span></code>
object has a <code class="docutils literal"><span class="pre">COOKIES</span></code> object that acts like a dictionary; you can use it to
read any cookies that the browser has sent to the view:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">show_color</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;favorite_color&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Your favorite color is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> \
            <span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="p">[</span><span class="s2">&quot;favorite_color&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;You don&#39;t have a favorite color.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Writing cookies is slightly more complicated. You need to use the
<code class="docutils literal"><span class="pre">set_cookie()</span></code> method on an <code class="docutils literal"><span class="pre">HttpResponse</span></code> object. Here’s an example that
sets the <code class="docutils literal"><span class="pre">favorite_color</span></code> cookie based on a <code class="docutils literal"><span class="pre">GET</span></code> parameter:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">set_color</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;favorite_color&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">:</span>

        <span class="c1"># Create an HttpResponse object...</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Your favorite color is now </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> \
            <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s2">&quot;favorite_color&quot;</span><span class="p">])</span>

        <span class="c1"># ... and set a cookie on the response</span>
        <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s2">&quot;favorite_color&quot;</span><span class="p">,</span>
                            <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s2">&quot;favorite_color&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">response</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;You didn&#39;t give a favorite color.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also pass a number of optional arguments to <code class="docutils literal"><span class="pre">response.set_cookie()</span></code>
that control aspects of the cookie, as shown in Table 14-1.</p>
<table border="1" class="docutils" id="id1">
<caption><span class="caption-text">Table 14-1: Cookie options</span><a class="headerlink" href="#id1" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="19%" />
<col width="14%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Parameter</th>
<th class="head">Default</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">max_age</span></code></td>
<td><code class="docutils literal"><span class="pre">None</span></code></td>
<td>Age (in seconds) that the cookie should last.
If this parameter is <code class="docutils literal"><span class="pre">None</span></code>, the cookie will
last only until the browser is closed.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">expires</span></code></td>
<td><code class="docutils literal"><span class="pre">None</span></code></td>
<td>The actual date/time when the cookie should
expire. It needs to be in the format <code class="docutils literal"><span class="pre">&quot;Wdy,</span>
<span class="pre">DD-Mth-YY</span> <span class="pre">HH:MM:SS</span> <span class="pre">GMT&quot;</span></code>. If given, this
parameter overrides the <code class="docutils literal"><span class="pre">max_age</span></code> parameter.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">path</span></code></td>
<td><code class="docutils literal"><span class="pre">&quot;/&quot;</span></code></td>
<td><p class="first">The path prefix that this cookie is valid for.
Browsers will only pass the cookie back to
pages below this path prefix, so you can use
this to prevent cookies from being sent to
other sections of your site.</p>
<p class="last">This is especially useful when you don’t
control the top level of your site’s domain.</p>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">domain</span></code></td>
<td><code class="docutils literal"><span class="pre">None</span></code></td>
<td><p class="first">The domain that this cookie is valid for.  You
can use this parameter to set a cross-domain
cookie. For example, <code class="docutils literal"><span class="pre">domain=&quot;.example.com&quot;</span></code>
will set a cookie that is readable by the
domains <code class="docutils literal"><span class="pre">www.example.com</span></code>,
<code class="docutils literal"><span class="pre">www2.example.com</span></code>, and
<code class="docutils literal"><span class="pre">an.other.sub.domain.example.com</span></code>.</p>
<p class="last">If this parameter is set to <code class="docutils literal"><span class="pre">None</span></code>, a cookie
will only be readable by the domain that set it.</p>
</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">secure</span></code></td>
<td><code class="docutils literal"><span class="pre">False</span></code></td>
<td>If set to <code class="docutils literal"><span class="pre">True</span></code>, this parameter instructs the
browser to only return this cookie to pages
accessed over HTTPS.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="the-mixed-blessing-of-cookies">
<h3>The Mixed Blessing of Cookies<a class="headerlink" href="#the-mixed-blessing-of-cookies" title="Permalink to this headline">¶</a></h3>
<p>You might notice a number of potential problems with the way cookies work.
Let’s look at some of the more important ones:</p>
<ul>
<li><p class="first">Storage of cookies is voluntary; a client does not have to accept or
store cookies. In fact, all browsers enable users to control the policy
for accepting cookies. If you want to see just how vital cookies are to
the Web, try turning on your browser’s “prompt to accept every cookie”
option.</p>
<p>Despite their nearly universal use, cookies are still the definition of
unreliability. This means that developers should check that a user
actually accepts cookies before relying on them.</p>
</li>
<li><p class="first">Cookies (especially those not sent over HTTPS) are not secure. Because
HTTP data is sent in cleartext, cookies are extremely vulnerable to
snooping attacks. That is, an attacker snooping on the wire can intercept
a cookie and read it. This means you should never store sensitive
information in a cookie.</p>
<p>There’s an even more insidious attack, known as a <em>man-in-the-middle</em>
attack, wherein an attacker intercepts a cookie and uses it to pose as
another user. Chapter 20 discusses attacks of this nature in depth, as
well as ways to prevent it.</p>
</li>
<li><p class="first">Cookies aren’t even secure from their intended recipients. Most browsers
provide easy ways to edit the content of individual cookies, and
resourceful users can always use tools like mechanize
(<a class="reference external" href="http://wwwsearch.sourceforge.net/mechanize/">http://wwwsearch.sourceforge.net/mechanize/</a>) to construct HTTP requests
by hand.</p>
<p>So you can’t store data in cookies that might be sensitive to tampering.
The canonical mistake in this scenario is storing something like
<code class="docutils literal"><span class="pre">IsLoggedIn=1</span></code> in a cookie when a user logs in. You’d be amazed at the
number of sites that make mistakes of this nature; it takes only a
second to fool these sites’ “security” systems.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="django-s-session-framework">
<h2>Django’s Session Framework<a class="headerlink" href="#django-s-session-framework" title="Permalink to this headline">¶</a></h2>
<p>With all of these limitations and potential security holes, it’s obvious that
cookies and persistent sessions are examples of those “pain points” in Web
development. Of course, Django’s goal is to be an effective painkiller, so
it comes with a session framework designed to smooth over these
difficulties for you.</p>
<p>This session framework lets you store and retrieve arbitrary data on a
per-site visitor basis. It stores data on the server side and abstracts the
sending and receiving of cookies. Cookies use only a hashed session ID – not
the data itself – thus protecting you from most of the common cookie
problems.</p>
<p>Let’s look at how to enable sessions and use them in views.</p>
<div class="section" id="enabling-sessions">
<h3>Enabling Sessions<a class="headerlink" href="#enabling-sessions" title="Permalink to this headline">¶</a></h3>
<p>Sessions are implemented via a piece of middleware (see Chapter 17) and a Django
model. To enable sessions, you’ll need to follow these steps:</p>
<ol class="arabic simple">
<li>Edit your <code class="docutils literal"><span class="pre">MIDDLEWARE_CLASSES</span></code> setting and make sure
<code class="docutils literal"><span class="pre">MIDDLEWARE_CLASSES</span></code> contains
<code class="docutils literal"><span class="pre">'django.contrib.sessions.middleware.SessionMiddleware'</span></code>.</li>
<li>Make sure <code class="docutils literal"><span class="pre">'django.contrib.sessions'</span></code> is in your <code class="docutils literal"><span class="pre">INSTALLED_APPS</span></code>
setting (and run <code class="docutils literal"><span class="pre">manage.py</span> <span class="pre">syncdb</span></code> if you have to add it).</li>
</ol>
<p>The default skeleton settings created by <code class="docutils literal"><span class="pre">startproject</span></code> have both of these
bits already installed, so unless you’ve removed them, you probably don’t have
to change anything to get sessions to work.</p>
<p>If you don’t want to use sessions, you might want to remove the
<code class="docutils literal"><span class="pre">SessionMiddleware</span></code> line from <code class="docutils literal"><span class="pre">MIDDLEWARE_CLASSES</span></code> and
<code class="docutils literal"><span class="pre">'django.contrib.sessions'</span></code> from your <code class="docutils literal"><span class="pre">INSTALLED_APPS</span></code>. It will save
you only a small amount of overhead, but every little bit counts.</p>
</div>
<div class="section" id="using-sessions-in-views">
<h3>Using Sessions in Views<a class="headerlink" href="#using-sessions-in-views" title="Permalink to this headline">¶</a></h3>
<p>When <code class="docutils literal"><span class="pre">SessionMiddleware</span></code> is activated, each <code class="docutils literal"><span class="pre">HttpRequest</span></code> object – the
first argument to any Django view function – will have a <code class="docutils literal"><span class="pre">session</span></code>
attribute, which is a dictionary-like object. You can read it and write to it
in the same way you’d use a normal dictionary. For example, in a view
you could do stuff like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Set a session value:</span>
<span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;fav_color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span>

<span class="c1"># Get a session value -- this could be called in a different view,</span>
<span class="c1"># or many requests later (or both):</span>
<span class="n">fav_color</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;fav_color&quot;</span><span class="p">]</span>

<span class="c1"># Clear an item from the session:</span>
<span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;fav_color&quot;</span><span class="p">]</span>

<span class="c1"># Check if the session has a given key:</span>
<span class="k">if</span> <span class="s2">&quot;fav_color&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>You can also use other dictionary methods like <code class="docutils literal"><span class="pre">keys()</span></code> and <code class="docutils literal"><span class="pre">items()</span></code> on
<code class="docutils literal"><span class="pre">request.session</span></code>.</p>
<p>There are a couple of simple rules for using Django’s sessions effectively:</p>
<ul>
<li><p class="first">Use normal Python strings as dictionary keys on <code class="docutils literal"><span class="pre">request.session</span></code> (as
opposed to integers, objects, etc.).</p>
</li>
<li><p class="first">Session dictionary keys that begin with an underscore are reserved for
internal use by Django. In practice, the framework uses only a small
number of underscore-prefixed session variables, but unless you know what
they all are (and you are willing to keep up with any changes in Django
itself), staying away from underscore prefixes will keep Django from
interfering with your application.</p>
<p>For example, don’t use a session key called <code class="docutils literal"><span class="pre">_fav_color</span></code>, like
this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;_fav_color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span> <span class="c1"># Don&#39;t do this!</span>
</pre></div>
</div>
</li>
<li><p class="first">Don’t replace <code class="docutils literal"><span class="pre">request.session</span></code> with a new object, and don’t access or
set its attributes. Use it like a Python dictionary. Examples:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">request</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">some_other_object</span> <span class="c1"># Don&#39;t do this!</span>

<span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span> <span class="c1"># Don&#39;t do this!</span>
</pre></div>
</div>
</li>
</ul>
<p>Let’s take a look at a few quick examples. This simplistic view sets a
<code class="docutils literal"><span class="pre">has_commented</span></code> variable to <code class="docutils literal"><span class="pre">True</span></code> after a user posts a comment. It’s a
simple (if not particularly secure) way of preventing a user from
posting more than one comment:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">post_comment</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span><span class="p">(</span><span class="s1">&#39;Only POSTs are allowed&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;comment&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span><span class="p">(</span><span class="s1">&#39;Comment not submitted&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;has_commented&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;You&#39;ve already commented.&quot;</span><span class="p">)</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">comments</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">comment</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">])</span>
    <span class="n">c</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;has_commented&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Thanks for your comment!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This simplistic view logs in a “member” of the site:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span><span class="p">(</span><span class="s1">&#39;Only POSTs are allowed&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Member</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">password</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]:</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;member_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">id</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s1">&#39;/you-are-logged-in/&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Member</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Your username and password didn&#39;t match.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>And this one logs out a member who has been logged in via <code class="docutils literal"><span class="pre">login()</span></code> above:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;member_id&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;You&#39;re logged out.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In practice, this is a lousy way of logging users in. The authentication
framework discussed shortly handles this task for you in a much more robust
and useful manner. These examples are deliberately simplistic so that you
can easily see what’s going on.</p>
</div>
</div>
<div class="section" id="setting-test-cookies">
<h3>Setting Test Cookies<a class="headerlink" href="#setting-test-cookies" title="Permalink to this headline">¶</a></h3>
<p>As mentioned above, you can’t rely on every browser accepting cookies. So, as
a convenience, Django provides an easy way to test whether a user’s browser
accepts cookies. Just call <code class="docutils literal"><span class="pre">request.session.set_test_cookie()</span></code> in a view, and
check <code class="docutils literal"><span class="pre">request.session.test_cookie_worked()</span></code> in a subsequent view – not in
the same view call.</p>
<p>This awkward split between <code class="docutils literal"><span class="pre">set_test_cookie()</span></code> and <code class="docutils literal"><span class="pre">test_cookie_worked()</span></code>
is necessary due to the way cookies work. When you set a cookie, you can’t
actually tell whether a browser accepted it until the browser’s next request.</p>
<p>It’s good practice to use <code class="docutils literal"><span class="pre">delete_test_cookie()</span></code> to clean up after yourself.
Do this after you’ve verified that the test cookie worked.</p>
<p>Here’s a typical usage example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>

    <span class="c1"># If we submitted the form...</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>

        <span class="c1"># Check that the test cookie worked (we set it below):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">test_cookie_worked</span><span class="p">():</span>

            <span class="c1"># The test cookie worked, so delete it.</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete_test_cookie</span><span class="p">()</span>

            <span class="c1"># In practice, we&#39;d need some logic to check username/password</span>
            <span class="c1"># here, but since this is an example...</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;You&#39;re logged in.&quot;</span><span class="p">)</span>

        <span class="c1"># The test cookie failed, so display an error message. If this</span>
        <span class="c1"># were a real site, we&#39;d want to display a friendlier message.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Please enable cookies and try again.&quot;</span><span class="p">)</span>

    <span class="c1"># If we didn&#39;t post, send the test cookie along with the login form.</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">set_test_cookie</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;foo/login_form.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Again, the built-in authentication functions handle this check for you.</p>
</div>
</div>
<div class="section" id="using-sessions-outside-of-views">
<h3>Using Sessions Outside of Views<a class="headerlink" href="#using-sessions-outside-of-views" title="Permalink to this headline">¶</a></h3>
<p>Internally, each session is just a normal Django model defined in
<code class="docutils literal"><span class="pre">django.contrib.sessions.models</span></code>. Each session is identified by a more-or-less
random 32-character hash stored in a cookie. Because it’s a normal model, you
can access sessions using the normal Django database API:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">django.contrib.sessions.models</span> <span class="k">import</span> <span class="n">Session</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="s1">&#39;2b1189a188b44ad18c35e113ac6ceead&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">expire_date</span>
<span class="go">datetime.datetime(2005, 8, 20, 13, 35, 12)</span>
</pre></div>
</div>
<p>You’ll need to call <code class="docutils literal"><span class="pre">get_decoded()</span></code> to get the actual session data. This is
necessary because the dictionary is stored in an encoded format:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">session_data</span>
<span class="go">&#39;KGRwMQpTJ19hdXRoX3VzZXJfaWQnCnAyCkkxCnMuMTExY2ZjODI2Yj...&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">get_decoded</span><span class="p">()</span>
<span class="go">{&#39;user_id&#39;: 42}</span>
</pre></div>
</div>
</div>
<div class="section" id="when-sessions-are-saved">
<h3>When Sessions Are Saved<a class="headerlink" href="#when-sessions-are-saved" title="Permalink to this headline">¶</a></h3>
<p>By default, Django only saves to the database if the session has been modified
– that is, if any of its dictionary values have been assigned or deleted:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Session is modified.</span>
<span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span>

<span class="c1"># Session is modified.</span>
<span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">]</span>

<span class="c1"># Session is modified.</span>
<span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># Gotcha: Session is NOT modified, because this alters</span>
<span class="c1"># request.session[&#39;foo&#39;] instead of request.session.</span>
<span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">][</span><span class="s1">&#39;bar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;baz&#39;</span>
</pre></div>
</div>
<p>To change this default behavior, set <code class="docutils literal"><span class="pre">SESSION_SAVE_EVERY_REQUEST</span></code>
to <code class="docutils literal"><span class="pre">True</span></code>. If <code class="docutils literal"><span class="pre">SESSION_SAVE_EVERY_REQUEST</span></code> is <code class="docutils literal"><span class="pre">True</span></code>, Django
will save the session to the database on every single request, even if it
wasn’t changed.</p>
<p>Note that the session cookie is sent only when a session has been created or
modified. If <code class="docutils literal"><span class="pre">SESSION_SAVE_EVERY_REQUEST</span></code> is <code class="docutils literal"><span class="pre">True</span></code>, the session cookie
will be sent on every request. Similarly, the <code class="docutils literal"><span class="pre">expires</span></code> part of a session
cookie is updated each time the session cookie is sent.</p>
</div>
<div class="section" id="browser-length-sessions-vs-persistent-sessions">
<h3>Browser-Length Sessions vs. Persistent Sessions<a class="headerlink" href="#browser-length-sessions-vs-persistent-sessions" title="Permalink to this headline">¶</a></h3>
<p>You might have noticed that the cookie Google sent us at the beginning of this
chapter contained <code class="docutils literal"><span class="pre">expires=Sun,</span> <span class="pre">17-Jan-2038</span> <span class="pre">19:14:07</span> <span class="pre">GMT;</span></code>. Cookies can
optionally contain an expiration date that advises the browser on when to
remove the cookie. If a cookie doesn’t contain an expiration value, the browser
will expire it when the user closes his or her browser window. You can control
the session framework’s behavior in this regard with the
<code class="docutils literal"><span class="pre">SESSION_EXPIRE_AT_BROWSER_CLOSE</span></code> setting.</p>
<p>By default, <code class="docutils literal"><span class="pre">SESSION_EXPIRE_AT_BROWSER_CLOSE</span></code> is set to <code class="docutils literal"><span class="pre">False</span></code>, which means
session cookies will be stored in users’ browsers for <code class="docutils literal"><span class="pre">SESSION_COOKIE_AGE</span></code>
seconds (which defaults to two weeks, or 1,209,600 seconds). Use this if you
don’t want people to have to log in every time they open a browser.</p>
<p>If <code class="docutils literal"><span class="pre">SESSION_EXPIRE_AT_BROWSER_CLOSE</span></code> is set to <code class="docutils literal"><span class="pre">True</span></code>, Django will use
browser-length cookies.</p>
</div>
<div class="section" id="other-session-settings">
<h3>Other Session Settings<a class="headerlink" href="#other-session-settings" title="Permalink to this headline">¶</a></h3>
<p>Besides the settings already mentioned, a few other settings
influence how Django’s session framework uses cookies, as shown in Table 14-2.</p>
<table border="1" class="docutils" id="id2">
<caption><span class="caption-text">Table 14-2. Settings that influence cookie behavior</span><a class="headerlink" href="#id2" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="37%" />
<col width="41%" />
<col width="21%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Setting</th>
<th class="head">Description</th>
<th class="head">Default</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">SESSION_COOKIE_DOMAIN</span></code></td>
<td>The domain to use for session
cookies. Set this to a string
such as <code class="docutils literal"><span class="pre">&quot;.example.com&quot;</span></code>
for cross-domain cookies, or
use <code class="docutils literal"><span class="pre">None</span></code> for a standard
cookie.</td>
<td><code class="docutils literal"><span class="pre">None</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">SESSION_COOKIE_NAME</span></code></td>
<td>The name of the cookie to use
for sessions. This can be any
string.</td>
<td><code class="docutils literal"><span class="pre">&quot;sessionid&quot;</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">SESSION_COOKIE_SECURE</span></code></td>
<td>Whether to use a “secure”
cookie for the session
cookie. If this is set to
<code class="docutils literal"><span class="pre">True</span></code>,  the cookie will be
marked as “secure,” which
means that browsers will
ensure that the cookie is
only sent via HTTPS.</td>
<td><code class="docutils literal"><span class="pre">False</span></code></td>
</tr>
</tbody>
</table>
<div class="admonition-technical-details admonition">
<p class="first admonition-title">Technical Details</p>
<p>For the curious, here are a few technical notes about the inner workings
of the session framework:</p>
<ul>
<li><p class="first">The session dictionary accepts any Python object capable of being
“pickled.” See the documentation for Python’s built-in <code class="docutils literal"><span class="pre">pickle</span></code>
module for information about how this works.</p>
</li>
<li><p class="first">Session data is stored in a database table named <code class="docutils literal"><span class="pre">django_session</span></code>.</p>
</li>
<li><p class="first">Session data is fetched upon demand. If you never access
<code class="docutils literal"><span class="pre">request.session</span></code>, Django won’t hit that database table.</p>
</li>
<li><p class="first">Django only sends a cookie if it needs to. If you don’t set any
session data, it won’t send a session cookie (unless
<code class="docutils literal"><span class="pre">SESSION_SAVE_EVERY_REQUEST</span></code> is set to <code class="docutils literal"><span class="pre">True</span></code>).</p>
</li>
<li><p class="first">The Django sessions framework is entirely, and solely, cookie based.
It does not fall back to putting session IDs in URLs as a last
resort, as some other tools (PHP, JSP) do.</p>
<p>This is an intentional design decision. Putting sessions in URLs
don’t just make URLs ugly, but also make your site vulnerable to a
certain form of session ID theft via the <code class="docutils literal"><span class="pre">Referer</span></code> header.</p>
</li>
</ul>
<p class="last">If you’re still curious, the source is pretty straightforward; look in
<code class="docutils literal"><span class="pre">django.contrib.sessions</span></code> for more details.</p>
</div>
</div>
</div>
<div class="section" id="users-and-authentication">
<h2>Users and Authentication<a class="headerlink" href="#users-and-authentication" title="Permalink to this headline">¶</a></h2>
<p>Sessions give us a way of persisting data through multiple browser requests;
the second part of the equation is using those sessions for user login. Of
course, we can’t just trust that users are who they say they are, so we need
to authenticate them along the way.</p>
<p>Naturally, Django provides tools to handle this common task (and many others).
Django’s user authentication system handles user accounts, groups, permissions,
and cookie-based user sessions. This system is often referred to as an
<em>auth/auth</em> (authentication and authorization) system. That name recognizes
that dealing with users is often a two-step process. We need to</p>
<ol class="arabic simple">
<li>Verify (<em>authenticate</em>) that a user is who he or she claims to be
(usually by checking a username and password against a database of users)</li>
<li>Verify that the user is <em>authorized</em> to perform some given operation
(usually by checking against a table of permissions)</li>
</ol>
<p>Following these needs, Django’s auth/auth system consists of a number of
parts:</p>
<ul class="simple">
<li><em>Users</em>: People registered with your site</li>
<li><em>Permissions</em>: Binary (yes/no) flags designating whether a user may
perform a certain task</li>
<li><em>Groups</em>: A generic way of applying labels and permissions to more than
one user</li>
<li><em>Messages</em>: A simple way to queue and display system messages to users</li>
</ul>
<p>If you’ve used the admin tool (discussed in Chapter 6), you’ve already seen many
of these tools, and if you’ve edited users or groups in the admin tool, you’ve
actually been editing data in the auth system’s database tables.</p>
<div class="section" id="enabling-authentication-support">
<h3>Enabling Authentication Support<a class="headerlink" href="#enabling-authentication-support" title="Permalink to this headline">¶</a></h3>
<p>Like the session tools, authentication support is bundled as a Django
application in <code class="docutils literal"><span class="pre">django.contrib</span></code> that needs to be installed. Also like the
session tools, it’s also installed by default, but if you’ve removed it, you’ll
need to follow these steps to install it:</p>
<ol class="arabic simple">
<li>Make sure the session framework is installed as described earlier in this
chapter. Keeping track of users obviously requires cookies, and thus
builds on the session framework.</li>
<li>Put <code class="docutils literal"><span class="pre">'django.contrib.auth'</span></code> in your <code class="docutils literal"><span class="pre">INSTALLED_APPS</span></code> setting and
run <code class="docutils literal"><span class="pre">manage.py</span> <span class="pre">syncdb</span></code> to install the appropriate database tables.</li>
<li>Make sure that
<code class="docutils literal"><span class="pre">'django.contrib.auth.middleware.AuthenticationMiddleware'</span></code> is in
your <code class="docutils literal"><span class="pre">MIDDLEWARE_CLASSES</span></code> setting – <em>after</em> <code class="docutils literal"><span class="pre">SessionMiddleware</span></code>.</li>
</ol>
<p>With that installation out of the way, we’re ready to deal with users in view
functions. The main interface you’ll use to access users within a view is
<code class="docutils literal"><span class="pre">request.user</span></code>; this is an object that represents the currently logged-in
user. If the user isn’t logged in, this will instead be an <code class="docutils literal"><span class="pre">AnonymousUser</span></code>
object (see below for more details).</p>
<p>You can easily tell if a user is logged in with the <code class="docutils literal"><span class="pre">is_authenticated()</span></code>
method:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
    <span class="c1"># Do something for authenticated users.</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Do something for anonymous users.</span>
</pre></div>
</div>
</div>
<div class="section" id="using-users">
<h3>Using Users<a class="headerlink" href="#using-users" title="Permalink to this headline">¶</a></h3>
<p>Once you have a <code class="docutils literal"><span class="pre">User</span></code> – often from <code class="docutils literal"><span class="pre">request.user</span></code>, but possibly through
one of the other methods discussed shortly – you have a number of fields and
methods available on that object. <code class="docutils literal"><span class="pre">AnonymousUser</span></code> objects emulate <em>some</em> of
this interface, but not all of it, so you should always check
<code class="docutils literal"><span class="pre">user.is_authenticated()</span></code> before assuming you’re dealing with a bona fide user
object. Tables 14-3 and 14-4 list the fields and methods, respectively, on <code class="docutils literal"><span class="pre">User</span></code> objects.</p>
<table border="1" class="docutils" id="id3">
<caption><span class="caption-text">Table 14-3. Fields on <code class="docutils literal"><span class="pre">User</span></code> Objects</span><a class="headerlink" href="#id3" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="24%" />
<col width="76%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">username</span></code></td>
<td>Required; 30 characters or fewer. Alphanumeric
characters only (letters, digits, and underscores).</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">first_name</span></code></td>
<td>Optional; 30 characters or fewer.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">last_name</span></code></td>
<td>Optional; 30 characters or fewer.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">email</span></code></td>
<td>Optional. E-mail address.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">password</span></code></td>
<td>Required. A hash of, and metadata about, the password
(Django doesn’t store the raw password). See the
“Passwords” section for more about this value.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">is_staff</span></code></td>
<td>Boolean. Designates whether this user can access the
admin site.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">is_active</span></code></td>
<td>Boolean. Designates whether this account can be used
to log in. Set this flag to <code class="docutils literal"><span class="pre">False</span></code> instead of
deleting accounts.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">is_superuser</span></code></td>
<td>Boolean. Designates that this user has all permissions
without explicitly assigning them.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">last_login</span></code></td>
<td>A datetime of the user’s last login. This is set to the
current date/time by default.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">date_joined</span></code></td>
<td>A datetime designating when the account was created.
This is set to the current date/time by default when the
account is created.</td>
</tr>
</tbody>
</table>
<table border="1" class="docutils" id="id4">
<caption><span class="caption-text">Table 14-4. Methods on <code class="docutils literal"><span class="pre">User</span></code> Objects</span><a class="headerlink" href="#id4" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="43%" />
<col width="57%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Method</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">is_authenticated()</span></code></td>
<td>Always returns <code class="docutils literal"><span class="pre">True</span></code> for “real”
<code class="docutils literal"><span class="pre">User</span></code> objects. This is a way to tell if
the user has been authenticated. This does
not imply any permissions, and it doesn’t
check if the user is active. It only
indicates that the user has sucessfully
authenticated.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">is_anonymous()</span></code></td>
<td>Returns <code class="docutils literal"><span class="pre">True</span></code> only for
<code class="docutils literal"><span class="pre">AnonymousUser</span></code> objects (and <code class="docutils literal"><span class="pre">False</span></code>
for “real” <code class="docutils literal"><span class="pre">User</span></code> objects). Generally,
you should prefer using
<code class="docutils literal"><span class="pre">is_authenticated()</span></code> to this method.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">get_full_name()</span></code></td>
<td>Returns the <code class="docutils literal"><span class="pre">first_name</span></code> plus the
<code class="docutils literal"><span class="pre">last_name</span></code>, with a space in between.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">set_password(passwd)</span></code></td>
<td>Sets the user’s password to the given
raw string, taking care of the password
hashing. This doesn’t actually save the
<code class="docutils literal"><span class="pre">User</span></code> object.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">check_password(passwd)</span></code></td>
<td>Returns <code class="docutils literal"><span class="pre">True</span></code> if the given raw
string is the correct password for the
user. This takes care of the password
hashing in making the comparison.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">get_group_permissions()</span></code></td>
<td>Returns a list of permission strings that
the user has through the groups he or she
belongs to.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">get_all_permissions()</span></code></td>
<td>Returns a list of permission strings that
the user has, both through group and user
permissions.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">has_perm(perm)</span></code></td>
<td>Returns <code class="docutils literal"><span class="pre">True</span></code> if the user has the
specified permission, where <code class="docutils literal"><span class="pre">perm</span></code> is in
the format <code class="docutils literal"><span class="pre">&quot;package.codename&quot;</span></code>. If the
user is inactive, this method will always
return <code class="docutils literal"><span class="pre">False</span></code>.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">has_perms(perm_list)</span></code></td>
<td>Returns <code class="docutils literal"><span class="pre">True</span></code> if the user has <em>all</em> of
the specified permissions. If the user is
inactive, this method will always return
<code class="docutils literal"><span class="pre">False</span></code>.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">has_module_perms(app_label)</span></code></td>
<td>Returns <code class="docutils literal"><span class="pre">True</span></code> if the user has
any permissions in the given <code class="docutils literal"><span class="pre">app_label</span></code>.
If the user is inactive, this method will
always return <code class="docutils literal"><span class="pre">False</span></code>.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">get_and_delete_messages()</span></code></td>
<td>Returns a list of <code class="docutils literal"><span class="pre">Message</span></code> objects in
the user’s queue and deletes the messages
from the queue.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">email_user(subj,</span> <span class="pre">msg)</span></code></td>
<td>Sends an email to the user. This email
is sent from the <code class="docutils literal"><span class="pre">DEFAULT_FROM_EMAIL</span></code>
setting.  You can also pass a third
argument, <code class="docutils literal"><span class="pre">from_email</span></code>, to override the
From address on the email.</td>
</tr>
</tbody>
</table>
<p>Finally, <code class="docutils literal"><span class="pre">User</span></code> objects have two many-to-many fields: <code class="docutils literal"><span class="pre">groups</span></code> and
<code class="docutils literal"><span class="pre">permissions</span></code>. <code class="docutils literal"><span class="pre">User</span></code> objects can access their related objects in the same
way as any other many-to-many field:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Set a user&#39;s groups:</span>
<span class="n">myuser</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="n">group_list</span>

<span class="c1"># Add a user to some groups:</span>
<span class="n">myuser</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>

<span class="c1"># Remove a user from some groups:</span>
<span class="n">myuser</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>

<span class="c1"># Remove a user from all groups:</span>
<span class="n">myuser</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<span class="c1"># Permissions work the same way</span>
<span class="n">myuser</span><span class="o">.</span><span class="n">permissions</span> <span class="o">=</span> <span class="n">permission_list</span>
<span class="n">myuser</span><span class="o">.</span><span class="n">permissions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">permission1</span><span class="p">,</span> <span class="n">permission2</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">myuser</span><span class="o">.</span><span class="n">permissions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">permission1</span><span class="p">,</span> <span class="n">permission2</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">myuser</span><span class="o">.</span><span class="n">permissions</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="logging-in-and-out">
<h3>Logging In and Out<a class="headerlink" href="#logging-in-and-out" title="Permalink to this headline">¶</a></h3>
<p>Django provides built-in view functions for handling logging in and out (and a
few other nifty tricks), but before we get to those, let’s take a look at how
to log users in and out “by hand.” Django provides two functions to perform
these actions in <code class="docutils literal"><span class="pre">django.contrib.auth</span></code>: <code class="docutils literal"><span class="pre">authenticate()</span></code> and <code class="docutils literal"><span class="pre">login()</span></code>.</p>
<p>To authenticate a given username and password, use <code class="docutils literal"><span class="pre">authenticate()</span></code>. It
takes two keyword arguments, <code class="docutils literal"><span class="pre">username</span></code> and <code class="docutils literal"><span class="pre">password</span></code>, and it returns a
<code class="docutils literal"><span class="pre">User</span></code> object if the password is valid for the given username. If the
password is invalid, <code class="docutils literal"><span class="pre">authenticate()</span></code> returns <code class="docutils literal"><span class="pre">None</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="k">import</span> <span class="n">auth</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;john&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;secret&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span> <span class="s2">&quot;Correct!&quot;</span>
<span class="gp">... </span><span class="k">else</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span> <span class="s2">&quot;Invalid password.&quot;</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">authenticate()</span></code> only verifies a user’s credentials. To log in a user, use
<code class="docutils literal"><span class="pre">login()</span></code>. It takes an <code class="docutils literal"><span class="pre">HttpRequest</span></code> object and a <code class="docutils literal"><span class="pre">User</span></code> object and saves
the user’s ID in the session, using Django’s session framework.</p>
<p>This example shows how you might use both <code class="docutils literal"><span class="pre">authenticate()</span></code> and <code class="docutils literal"><span class="pre">login()</span></code>
within a view function:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="k">import</span> <span class="n">auth</span>

<span class="k">def</span> <span class="nf">login_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="c1"># Correct password, and the user is marked &quot;active&quot;</span>
        <span class="n">auth</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
        <span class="c1"># Redirect to a success page.</span>
        <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s2">&quot;/account/loggedin/&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Show an error page</span>
        <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s2">&quot;/account/invalid/&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>To log out a user, use <code class="docutils literal"><span class="pre">django.contrib.auth.logout()</span></code> within your view. It
takes an <code class="docutils literal"><span class="pre">HttpRequest</span></code> object and has no return value:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="k">import</span> <span class="n">auth</span>

<span class="k">def</span> <span class="nf">logout_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">auth</span><span class="o">.</span><span class="n">logout</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="c1"># Redirect to a success page.</span>
    <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s2">&quot;/account/loggedout/&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal"><span class="pre">auth.logout()</span></code> doesn’t throw any errors if the user wasn’t logged
in.</p>
<p>In practice, you usually will not need to write your own login/logout functions;
the authentication system comes with a set of views for generically handling
logging in and out. The first step in using these authentication views is to
wire them up in your URLconf. You’ll need to add this snippet:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth.views</span> <span class="k">import</span> <span class="n">login</span><span class="p">,</span> <span class="n">logout</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="c1"># existing patterns here...</span>
    <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^accounts/login/$&#39;</span><span class="p">,</span>  <span class="n">login</span><span class="p">),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^accounts/logout/$&#39;</span><span class="p">,</span> <span class="n">logout</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">/accounts/login/</span></code> and <code class="docutils literal"><span class="pre">/accounts/logout/</span></code> are the default URLs that
Django uses for these views.</p>
<p>By default, the <code class="docutils literal"><span class="pre">login</span></code> view renders a template at
<code class="docutils literal"><span class="pre">registration/login.html</span></code> (you can change this template name by passing an
extra view argument ,``template_name``). This form needs to contain a
<code class="docutils literal"><span class="pre">username</span></code> and a <code class="docutils literal"><span class="pre">password</span></code> field. A simple template might look like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="n">extends</span> <span class="s2">&quot;base.html&quot;</span> <span class="o">%</span><span class="p">}</span>

<span class="p">{</span><span class="o">%</span> <span class="n">block</span> <span class="n">content</span> <span class="o">%</span><span class="p">}</span>

  <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">errors</span> <span class="o">%</span><span class="p">}</span>
    <span class="o">&lt;</span><span class="n">p</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="o">&gt;</span><span class="n">Sorry</span><span class="p">,</span> <span class="n">that</span><span class="s1">&#39;s not a valid username or password&lt;/p&gt;</span>
  <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>

  <span class="o">&lt;</span><span class="n">form</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">&quot;username&quot;</span><span class="o">&gt;</span><span class="n">User</span> <span class="n">name</span><span class="p">:</span><span class="o">&lt;/</span><span class="n">label</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;username&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;username&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">&quot;password&quot;</span><span class="o">&gt;</span><span class="n">Password</span><span class="p">:</span><span class="o">&lt;/</span><span class="n">label</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;password&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;password&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;password&quot;</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;login&quot;</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;hidden&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;next&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;{{ next|escape }}&quot;</span> <span class="o">/&gt;</span>
  <span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>

<span class="p">{</span><span class="o">%</span> <span class="n">endblock</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
<p>If the user successfully logs in, he or she will be redirected to
<code class="docutils literal"><span class="pre">/accounts/profile/</span></code> by default. You can override this by providing a hidden
field called <code class="docutils literal"><span class="pre">next</span></code> with the URL to redirect to after logging in. You can
also pass this value as a <code class="docutils literal"><span class="pre">GET</span></code> parameter to the login view and it will be
automatically added to the context as a variable called <code class="docutils literal"><span class="pre">next</span></code> that you can
insert into that hidden field.</p>
<p>The logout view works a little differently. By default it renders a template
at <code class="docutils literal"><span class="pre">registration/logged_out.html</span></code> (which usually contains a “You’ve
successfully logged out” message). However, you can call the view with an
extra argument, <code class="docutils literal"><span class="pre">next_page</span></code>, which will instruct the view to redirect after
a logout.</p>
</div>
<div class="section" id="limiting-access-to-logged-in-users">
<h3>Limiting Access to Logged-in Users<a class="headerlink" href="#limiting-access-to-logged-in-users" title="Permalink to this headline">¶</a></h3>
<p>Of course, the reason we’re going through all this trouble is so we can
limit access to parts of our site.</p>
<p>The simple, raw way to limit access to pages is to check
<code class="docutils literal"><span class="pre">request.user.is_authenticated()</span></code> and redirect to a login page:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.http</span> <span class="k">import</span> <span class="n">HttpResponseRedirect</span>

<span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s1">&#39;/accounts/login/?next=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>or perhaps display an error message:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;myapp/login_error.html&#39;</span><span class="p">)</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>As a shortcut, you can use the convenient <code class="docutils literal"><span class="pre">login_required</span></code> decorator:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="k">import</span> <span class="n">login_required</span>

<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">login_required</span></code> does the following:</p>
<ul class="simple">
<li>If the user isn’t logged in, redirect to <code class="docutils literal"><span class="pre">/accounts/login/</span></code>, passing
the current URL path in the query string as <code class="docutils literal"><span class="pre">next</span></code>, for example:
<code class="docutils literal"><span class="pre">/accounts/login/?next=/polls/3/</span></code>.</li>
<li>If the user is logged in, execute the view normally. The view code
can then assume that the user is logged in.</li>
</ul>
</div>
<div class="section" id="limiting-access-to-users-who-pass-a-test">
<h3>Limiting Access to Users Who Pass a Test<a class="headerlink" href="#limiting-access-to-users-who-pass-a-test" title="Permalink to this headline">¶</a></h3>
<p>Limiting access based on certain permissions or some other test, or providing
a different location for the login view works essentially the same way.</p>
<p>The raw way is to run your test on <code class="docutils literal"><span class="pre">request.user</span></code> in the view directly. For
example, this view checks to make sure the user is logged in and has the
permission <code class="docutils literal"><span class="pre">polls.can_vote</span></code> (more about how permissions
works follows):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vote</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">()</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;polls.can_vote&#39;</span><span class="p">)):</span>
        <span class="c1"># vote here</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;You can&#39;t vote in this poll.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Again, Django provides a shortcut called <code class="docutils literal"><span class="pre">user_passes_test</span></code>. It
takes arguments and generates a specialized decorator for your particular
situation:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">user_can_vote</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">()</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;polls.can_vote&quot;</span><span class="p">)</span>

<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">user_can_vote</span><span class="p">,</span> <span class="n">login_url</span><span class="o">=</span><span class="s2">&quot;/login/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">vote</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># Code here can assume a logged-in user with the correct permission.</span>
    <span class="o">...</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">user_passes_test</span></code> takes one required argument: a callable that takes a
<code class="docutils literal"><span class="pre">User</span></code> object and returns <code class="docutils literal"><span class="pre">True</span></code> if the user is allowed to view the page.
Note that <code class="docutils literal"><span class="pre">user_passes_test</span></code> does not automatically check that the <code class="docutils literal"><span class="pre">User</span></code>
is authenticated; you should do that yourself.</p>
<p>In this example we’re also showing the second (optional) argument,
<code class="docutils literal"><span class="pre">login_url</span></code>, which lets you specify the URL for your login page
(<code class="docutils literal"><span class="pre">/accounts/login/</span></code> by default). If the user doesn’t pass the test, then
the <code class="docutils literal"><span class="pre">user_passes_test</span></code> decorator will redirect the user to the <code class="docutils literal"><span class="pre">login_url</span></code>.</p>
<p>Because it’s a relatively common task to check whether a user has a particular
permission, Django provides a shortcut for that case: the
<code class="docutils literal"><span class="pre">permission_required()</span></code> decorator. Using this decorator, the earlier example
can be written as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="k">import</span> <span class="n">permission_required</span>

<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;polls.can_vote&#39;</span><span class="p">,</span> <span class="n">login_url</span><span class="o">=</span><span class="s2">&quot;/login/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">vote</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal"><span class="pre">permission_required()</span></code> also takes an optional <code class="docutils literal"><span class="pre">login_url</span></code>
parameter, which also defaults to <code class="docutils literal"><span class="pre">'/accounts/login/'</span></code>.</p>
<div class="admonition-limiting-access-to-generic-views admonition">
<p class="first admonition-title">Limiting Access to Generic Views</p>
<p>One of the most frequently asked questions on the Django users list deals
with limiting access to a generic view. To pull this off, you’ll need to
write a thin wrapper around the view and point your URLconf to your wrapper
instead of the generic view itself:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="k">import</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">django.views.generic.date_based</span> <span class="k">import</span> <span class="n">object_detail</span>

<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">limited_object_detail</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">object_detail</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p class="last">You can, of course, replace <code class="docutils literal"><span class="pre">login_required</span></code> with any of the other
limiting decorators.</p>
</div>
</div>
<div class="section" id="managing-users-permissions-and-groups">
<h3>Managing Users, Permissions, and Groups<a class="headerlink" href="#managing-users-permissions-and-groups" title="Permalink to this headline">¶</a></h3>
<p>The easiest way by far to manage the auth system is through the admin interface.
Chapter 6 discusses how to use Django’s admin site to edit users and
control their permissions and access, and most of the time you’ll just use that
interface.</p>
<p>However, there are low-level APIs you can dive into when you need absolute
control, and we discuss these in the sections that follow.</p>
<div class="section" id="creating-users">
<h4>Creating Users<a class="headerlink" href="#creating-users" title="Permalink to this headline">¶</a></h4>
<p>Create users with the <code class="docutils literal"><span class="pre">create_user</span></code> helper function:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="k">import</span> <span class="n">User</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;john&#39;</span><span class="p">,</span>
<span class="gp">... </span>                                <span class="n">email</span><span class="o">=</span><span class="s1">&#39;jlennon@beatles.com&#39;</span><span class="p">,</span>
<span class="gp">... </span>                                <span class="n">password</span><span class="o">=</span><span class="s1">&#39;glass onion&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>At this point, <code class="docutils literal"><span class="pre">user</span></code> is a <code class="docutils literal"><span class="pre">User</span></code> instance ready to be saved to the database
(<code class="docutils literal"><span class="pre">create_user()</span></code> doesn’t actually call <code class="docutils literal"><span class="pre">save()</span></code> itself). You can continue to
change its attributes before saving, too:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">=</span> <span class="kc">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="changing-passwords">
<h4>Changing Passwords<a class="headerlink" href="#changing-passwords" title="Permalink to this headline">¶</a></h4>
<p>You can change a password with <code class="docutils literal"><span class="pre">set_password()</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;john&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="s1">&#39;goo goo goo joob&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>Don’t set the <code class="docutils literal"><span class="pre">password</span></code> attribute directly unless you know what you’re
doing. The password is actually stored as a <em>salted hash</em> and thus can’t be
edited directly.</p>
<p>More formally, the <code class="docutils literal"><span class="pre">password</span></code> attribute of a <code class="docutils literal"><span class="pre">User</span></code> object is a string in
this format:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>hashtype$salt$hash
</pre></div>
</div>
<p>That’s a hash type, the salt, and the hash itself, separated by the dollar sign
($) character.</p>
<p><code class="docutils literal"><span class="pre">hashtype</span></code> is either <code class="docutils literal"><span class="pre">sha1</span></code> (default) or <code class="docutils literal"><span class="pre">md5</span></code>, the algorithm used to
perform a one-way hash of the password. <code class="docutils literal"><span class="pre">salt</span></code> is a random string used to salt
the raw password to create the hash, for example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>sha1$a1976$a36cc8cbf81742a8fb52e221aaeab48ed7f58ab4
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">User.set_password()</span></code> and <code class="docutils literal"><span class="pre">User.check_password()</span></code> functions handle the
setting and checking of these values behind the scenes.</p>
<div class="admonition-salted-hashes admonition">
<p class="first admonition-title">Salted hashes</p>
<p>A <em>hash</em> is a one-way cryptographic function – that is, you can easily
compute the hash of a given value, but it’s nearly impossible to take a
hash and reconstruct the original value.</p>
<p>If we stored passwords as plain text, anyone who got their hands on the
password database would instantly know everyone’s password. Storing
passwords as hashes reduces the value of a compromised database.</p>
<p>However, an attacker with the password database could still run a <em>brute-
force</em> attack, hashing millions of passwords and comparing those hashes
against the stored values. This takes some time, but less than you might
think.</p>
<p>Worse, there are publicly available <em>rainbow tables</em>, or databases of
pre-computed hashes of millions of passwords. With a rainbow table, an
experienced attacker could break most passwords in seconds.</p>
<p>Adding a <em>salt</em> – basically an initial random value – to the stored hash
adds another layer of difficulty to breaking passwords. Because salts
differ from password to password, they also prevent the use of a rainbow
table, thus forcing attackers to fall back on a brute-force attack, itself
made more difficult by the extra entropy added to the hash by the salt.</p>
<p class="last">While salted hashes aren’t absolutely the most secure way of storing
passwords, they’re a good middle ground between security and convenience.</p>
</div>
</div>
<div class="section" id="handling-registration">
<h4>Handling Registration<a class="headerlink" href="#handling-registration" title="Permalink to this headline">¶</a></h4>
<p>We can use these low-level tools to create views that allow users to sign up
for new accounts. Different developers implement registration differently, so
Django leaves writing a registration view up to you. Luckily, it’s pretty easy.</p>
<p>At its simplest, we could provide a small view that prompts for the required
user information and creates those users. Django provides a built-in form you
can use for this purpose, which we’ll use in this example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django</span> <span class="k">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.forms</span> <span class="k">import</span> <span class="n">UserCreationForm</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="k">import</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="k">import</span> <span class="n">render</span>

<span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">UserCreationForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">new_user</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s2">&quot;/books/&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">UserCreationForm</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;registration/register.html&quot;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
    <span class="p">})</span>
</pre></div>
</div>
<p>This form assumes a template named <code class="docutils literal"><span class="pre">registration/register.html</span></code>. Here’s an
example of what that template might look like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="n">extends</span> <span class="s2">&quot;base.html&quot;</span> <span class="o">%</span><span class="p">}</span>

<span class="p">{</span><span class="o">%</span> <span class="n">block</span> <span class="n">title</span> <span class="o">%</span><span class="p">}</span><span class="n">Create</span> <span class="n">an</span> <span class="n">account</span><span class="p">{</span><span class="o">%</span> <span class="n">endblock</span> <span class="o">%</span><span class="p">}</span>

<span class="p">{</span><span class="o">%</span> <span class="n">block</span> <span class="n">content</span> <span class="o">%</span><span class="p">}</span>
  <span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Create</span> <span class="n">an</span> <span class="n">account</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>

  <span class="o">&lt;</span><span class="n">form</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="o">&gt;</span>
      <span class="p">{{</span> <span class="n">form</span><span class="o">.</span><span class="n">as_p</span> <span class="p">}}</span>
      <span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;Create the account&quot;</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endblock</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="using-authentication-data-in-templates">
<h3>Using Authentication Data in Templates<a class="headerlink" href="#using-authentication-data-in-templates" title="Permalink to this headline">¶</a></h3>
<p>The current logged-in user and his or her permissions are made available in the
template context when you use the <code class="docutils literal"><span class="pre">render()</span></code> shortcut or explicitly use a
<code class="docutils literal"><span class="pre">RequestContext</span></code> (see Chapter 9).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Technically, these variables are only made available in the template
context if you use <code class="docutils literal"><span class="pre">RequestContext</span></code> <em>and</em> your
<code class="docutils literal"><span class="pre">TEMPLATE_CONTEXT_PROCESSORS</span></code> setting contains
<code class="docutils literal"><span class="pre">&quot;django.core.context_processors.auth&quot;</span></code>, which is the default. Again, see
Chapter 9 for more information.</p>
</div>
<p>When using <code class="docutils literal"><span class="pre">RequestContext</span></code>, the current user (either a <code class="docutils literal"><span class="pre">User</span></code> instance
or an <code class="docutils literal"><span class="pre">AnonymousUser</span></code> instance) is stored in the template variable
<code class="docutils literal"><span class="pre">{{</span> <span class="pre">user</span> <span class="pre">}}</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span> <span class="o">%</span><span class="p">}</span>
  <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">Welcome</span><span class="p">,</span> <span class="p">{{</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="p">}}</span><span class="o">.</span> <span class="n">Thanks</span> <span class="k">for</span> <span class="n">logging</span> <span class="ow">in</span><span class="o">.&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="p">{</span><span class="o">%</span> <span class="k">else</span> <span class="o">%</span><span class="p">}</span>
  <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">Welcome</span><span class="p">,</span> <span class="n">new</span> <span class="n">user</span><span class="o">.</span> <span class="n">Please</span> <span class="n">log</span> <span class="ow">in</span><span class="o">.&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
<p>This user’s permissions are stored in the template variable <code class="docutils literal"><span class="pre">{{</span> <span class="pre">perms</span> <span class="pre">}}</span></code>.
This is a template-friendly proxy to a couple of permission methods described
shortly.</p>
<p>There are two ways you can use this <code class="docutils literal"><span class="pre">perms</span></code> object. You can use something like
<code class="docutils literal"><span class="pre">{%</span> <span class="pre">if</span> <span class="pre">perms.polls</span> <span class="pre">%}</span></code> to check if the user has <em>any</em> permissions for some given
application, or you can use something like <code class="docutils literal"><span class="pre">{%</span> <span class="pre">if</span> <span class="pre">perms.polls.can_vote</span> <span class="pre">%}</span></code> to
check if the user has a specific permission.</p>
<p>Thus, you can check permissions in template <code class="docutils literal"><span class="pre">{%</span> <span class="pre">if</span> <span class="pre">%}</span></code> statements:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>{% if perms.polls %}
  &lt;p&gt;You have permission to do something in the polls app.&lt;/p&gt;
  {% if perms.polls.can_vote %}
    &lt;p&gt;You can vote!&lt;/p&gt;
  {% endif %}
{% else %}
  &lt;p&gt;You don&#39;t have permission to do anything in the polls app.&lt;/p&gt;
{% endif %}
</pre></div>
</div>
</div>
</div>
<div class="section" id="permissions-groups-and-messages">
<h2>Permissions, Groups and Messages<a class="headerlink" href="#permissions-groups-and-messages" title="Permalink to this headline">¶</a></h2>
<p>There are a few other bits of the authentication framework that we’ve only dealt
with in passing. We’ll take a closer look at them in the following sections.</p>
<div class="section" id="permissions">
<h3>Permissions<a class="headerlink" href="#permissions" title="Permalink to this headline">¶</a></h3>
<p>Permissions are a simple way to “mark” users and groups as being able to
perform some action. They are usually used by the Django admin site, but you can
easily use them in your own code.</p>
<p>The Django admin site uses permissions as follows:</p>
<ul class="simple">
<li>Access to view the “add” form, and add an object is limited to users with
the <em>add</em> permission for that type of object.</li>
<li>Access to view the change list, view the “change” form, and change an
object is limited to users with the <em>change</em> permission for that type of
object.</li>
<li>Access to delete an object is limited to users with the <em>delete</em>
permission for that type of object.</li>
</ul>
<p>Permissions are set globally per type of object, not per specific object
instance. For example, it’s possible to say “Mary may change news stories,”
but permissions don’t let you say “Mary may change news stories, but only
the ones she created herself” or “Mary may only change news stories that have
a certain status, publication date, or ID.”</p>
<p>These three basic permissions – add, change, and delete – are automatically
created for each Django model. Behind the scenes, these permissions are added
to the <code class="docutils literal"><span class="pre">auth_permission</span></code> database table when you run <code class="docutils literal"><span class="pre">manage.py</span> <span class="pre">syncdb</span></code>.</p>
<p>These permissions will be of the form <code class="docutils literal"><span class="pre">&quot;&lt;app&gt;.&lt;action&gt;_&lt;object_name&gt;&quot;</span></code>. That
is, if you have a <code class="docutils literal"><span class="pre">polls</span></code> application with a <code class="docutils literal"><span class="pre">Choice</span></code> model, you’ll get
permissions named <code class="docutils literal"><span class="pre">&quot;polls.add_choice&quot;</span></code>, <code class="docutils literal"><span class="pre">&quot;polls.change_choice&quot;</span></code>, and
<code class="docutils literal"><span class="pre">&quot;polls.delete_choice&quot;</span></code>.</p>
<p>Just like users, permissions are implemented in a Django model that lives in
<code class="docutils literal"><span class="pre">django.contrib.auth.models</span></code>. This means that you can use Django’s database
API to interact directly with permissions if you like.</p>
</div>
<div class="section" id="groups">
<h3>Groups<a class="headerlink" href="#groups" title="Permalink to this headline">¶</a></h3>
<p>Groups are a generic way of categorizing users so you can apply permissions,
or some other label, to those users. A user can belong to any number of
groups.</p>
<p>A user in a group automatically has the permissions granted to that group. For
example, if the group <code class="docutils literal"><span class="pre">Site</span> <span class="pre">editors</span></code> has the permission
<code class="docutils literal"><span class="pre">can_edit_home_page</span></code>, any user in that group will have that permission.</p>
<p>Groups are also a convenient way to categorize users to give them some label, or
extended functionality. For example, you could create a group <code class="docutils literal"><span class="pre">'Special</span>
<span class="pre">users'</span></code>, and you could write code that could, say, give those users access to a
members-only portion of your site, or send them members-only e-mail messages.</p>
<p>Like users, the easiest way to manage groups is through the admin interface.
However, groups are also just Django models that live in
<code class="docutils literal"><span class="pre">django.contrib.auth.models</span></code>, so once again you can always use Django’s
database APIs to deal with groups at a low level.</p>
</div>
<div class="section" id="messages">
<h3>Messages<a class="headerlink" href="#messages" title="Permalink to this headline">¶</a></h3>
<p>The message system is a lightweight way to queue messages for given users. A
message is associated with a <code class="docutils literal"><span class="pre">User</span></code>. There’s no concept of expiration or
timestamps.</p>
<p>Messages are used by the Django admin interface after successful actions. For
example, when you create an object, you’ll notice a “The object was created
successfully” message at the top of the admin page.</p>
<p>You can use the same API to queue and display messages in your own application.
The API is simple:</p>
<ul class="simple">
<li>To create a new message, use
<code class="docutils literal"><span class="pre">user.message_set.create(message='message_text')</span></code>.</li>
<li>To retrieve/delete messages, use <code class="docutils literal"><span class="pre">user.get_and_delete_messages()</span></code>,
which returns a list of <code class="docutils literal"><span class="pre">Message</span></code> objects in the user’s queue (if any)
and deletes the messages from the queue.</li>
</ul>
<p>In this example view, the system saves a message for the user after creating a
playlist:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_playlist</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">songs</span><span class="p">):</span>
    <span class="c1"># Create the playlist with the given songs.</span>
    <span class="c1"># ...</span>
    <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">message_set</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Your playlist was added successfully.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;playlists/create.html&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>When you use the <code class="docutils literal"><span class="pre">render()</span></code> shortcut or render a template with a
<code class="docutils literal"><span class="pre">RequestContext</span></code>, the current logged-in user and his or her messages are made
available in the template context as the template variable <code class="docutils literal"><span class="pre">{{</span> <span class="pre">messages</span> <span class="pre">}}</span></code>.
Here’s an example of template code that displays messages:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">messages</span> <span class="o">%</span><span class="p">}</span>
<span class="o">&lt;</span><span class="n">ul</span><span class="o">&gt;</span>
    <span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span> <span class="o">%</span><span class="p">}</span>
    <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">message</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
    <span class="p">{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
<span class="o">&lt;/</span><span class="n">ul</span><span class="o">&gt;</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal"><span class="pre">RequestContext</span></code> calls <code class="docutils literal"><span class="pre">get_and_delete_messages</span></code> behind the
scenes, so any messages will be deleted even if you don’t display them.</p>
<p>Finally, note that this messages framework only works with users in the user
database. To send messages to anonymous users, use the session framework
directly.</p>
</div>
</div>
<div class="section" id="what-s-next">
<h2>What’s Next<a class="headerlink" href="#what-s-next" title="Permalink to this headline">¶</a></h2>
<p>The session and authorization system is a lot to absorb. Most of the time,
you won’t need all the features described in this chapter, but when you need to
allow complex interactions between users, it’s good to have all that power
available.</p>
<p>In the <a class="reference external" href="chapter15.html">next chapter</a>, we’ll take a look at Django’s caching infrastructure,
which is a convenient way to improve the performance of your application.</p>
</div>
</div>
</div>

          </div>
        </div>
      </div>
      <div id="ft">
        
<div class="nav">
    
        <a href='chapter13.html'>&laquo; previous</a> &loz;
    
    <a href="index.html">table of contents</a>
    
        &loz; <a href='chapter15.html'>next &raquo;</a>
    
</div>

        Copyright Adrian Holovaty, Jacob Kaplan-Moss, et al.<br>This
        work is licensed under the <a href="license.html">GNU Free Document
        License</a>.
      </div>
    </div>
  
  </body>
</html>